Option Explicit

Private Sub ExportarCore(ByRef p As tExportParams, ByVal closeRepoAfter As Boolean)
    Dim prevScreenUpdating As Boolean
    Dim prevEnableEvents As Boolean
    Dim prevDisplayAlerts As Boolean
    Dim prevAskToUpdateLinks As Boolean
    Dim prevCalculation As XlCalculation
    
    Dim repoWB As Workbook
    Dim baseWS As Worksheet
    Dim permWS As Worksheet          'Hoja "Permanencia" en repo
    Dim tasaWS As Worksheet          'Hoja "Tasa_Caida" en repo
    
    Dim inWB As Workbook
    Dim outWB As Workbook
    Dim outPlanWS As Worksheet
    
    Dim headers As Object
    Dim permHeaders As Object
    Dim tasaHeaders As Object
    
    Dim nextRow As Long
    Dim nextId As Long
    
    Dim colId As Long
    Dim colTarifa As Long
    Dim colPlan As Long
    Dim lastBaseRow As Long
    Dim r As Long
    
    'Index de filas existentes para reemplazo (solo para la tarifa actual)
    'key = UCase(CODIGO_TARIFA) & "|" & UCase(PLAN)
    'value = Array(rowIndex, idValue, planLabel)
    Dim idx As Object
    Dim seen As Object
    Dim key As String
    Dim tarifaBase As String
    Dim planBase As String
    Dim idBase As Long
    Dim arr As Variant
    
    Dim newCount As Long
    
    'Lista de nombres de hojas INPUT (viene del formulario, separados por ;)
    Dim inputPlanNames As Collection
    Dim inputSheetName As Variant
    
    'Mapa INPUT -> OUTPUT (OUTPUT se lee desde C4 en la hoja INPUT)
    Dim mapInputToOutput As Object
    Dim outUsed As Object
    Dim outputSheetName As String
    
    'Plan / Consolidado
    Dim planSheetName As String
    Dim planLabel As String
    
    Dim rowIndex As Long
    Dim idValue As Long
    
    Dim totalCol As Long
    
    'Output (CLP)
    Dim gwpCLP As Double
    Dim writtenNetTaxCLP As Double
    Dim devolucionesCLP As Double
    Dim nepCLP As Double
    Dim paidClaimsCLP As Double
    Dim comisionesMontoCLP As Double
    
    Dim ventasPlan As Double
    Dim expuestosPlan As Double
    Dim lastColRow288 As Long
    Dim c As Long
    Dim v As Variant
    
    Dim devolPct As Variant
    Dim valorCliente As Variant
    Dim lossRatio As Variant
    Dim denomLR As Double
    
    Dim permanenciaPlan As Variant
    Dim duracionMediaMeses As Variant
    Dim primaClienteNetaCalc As Variant
    
    Dim ivaEfectivo As Variant
    Dim ivaRecuperable As Variant
    
    Dim gastosDirectosMonto As Double
    Dim gastosIndirectosMonto As Double
    Dim gastosDirectosPct As Variant
    Dim gastosIndirectosPct As Variant
    
    'Input por plan
    Dim comisionesPctInput As Variant
    Dim mesesVentaPlan As Variant
    Dim inflacionTxt As String
    Dim cutOffRunOffTxt As String
    Dim fechaCutOffVal As Variant
    Dim periodicidadTxt As String
    Dim productTypeTxt As String
    Dim loanDurationVal As Variant
    
    'Tasa caída (una sola por póliza)
    Dim tasaCaida(1 To 144) As Double
    Dim permanencias(1 To 144) As Double
    Dim k As Long
    Dim tasaColStart As Long
    
    'Control para pegar Tasa_Caida + Permanencia una sola vez
    Dim ratesDone As Boolean
    Dim polizaId As Long             'ID_INTERNO único para póliza (usaremos el del consolidado)
    Dim periodicidadPoliza As String 'periodicidad del primer plan exportado (para permanencia)
    
    On Error GoTo FAIL
    
    '========================================================
    ' Estabilidad Excel (evitar parpadeos / recalculo)
    '========================================================
    prevScreenUpdating = Application.ScreenUpdating
    prevEnableEvents = Application.EnableEvents
    prevDisplayAlerts = Application.DisplayAlerts
    prevAskToUpdateLinks = Application.AskToUpdateLinks
    prevCalculation = Application.Calculation
    
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.DisplayAlerts = False
    Application.AskToUpdateLinks = False
    Application.Calculation = xlCalculationManual
    
    '========================================================
    ' Abrir repo y preparar headers (Base + tablas auxiliares)
    '========================================================
    Set repoWB = Workbooks.Open(Filename:=p.RepoPath, UpdateLinks:=0, ReadOnly:=False, AddToMru:=False)
    
    Set baseWS = GetWorksheet(repoWB, "Base")
    Set permWS = GetWorksheet(repoWB, "Permanencia")
    Set tasaWS = GetWorksheet(repoWB, "Tasa_Caida")
    
    Set headers = BuildHeaderMap(baseWS, 1)
    Set permHeaders = BuildHeaderMap(permWS, 1)
    Set tasaHeaders = BuildHeaderMap(tasaWS, 1)
    
    'Base: columnas mínimas
    If Not headers.Exists("ID_INTERNO") Then Err.Raise vbObjectError + 3001, "ExportarCore", "Falta header ID_INTERNO en Base"
    If Not headers.Exists("CODIGO_TARIFA") Then Err.Raise vbObjectError + 3002, "ExportarCore", "Falta header CODIGO_TARIFA en Base"
    If Not headers.Exists("PLAN") Then Err.Raise vbObjectError + 3003, "ExportarCore", "Falta header PLAN en Base"
    
    'Permanencia: columnas requeridas
    If Not permHeaders.Exists("ID_INTERNO") Then Err.Raise vbObjectError + 3011, "ExportarCore", "Falta header ID_INTERNO en Permanencia"
    If Not permHeaders.Exists("MES") Then Err.Raise vbObjectError + 3012, "ExportarCore", "Falta header MES en Permanencia"
    If Not permHeaders.Exists("VALOR") Then Err.Raise vbObjectError + 3013, "ExportarCore", "Falta header VALOR en Permanencia"
    If Not permHeaders.Exists("TIPO") Then Err.Raise vbObjectError + 3014, "ExportarCore", "Falta header TIPO en Permanencia"
    
    'Tasa_Caida: columnas requeridas
    If Not tasaHeaders.Exists("ID_INTERNO") Then Err.Raise vbObjectError + 3021, "ExportarCore", "Falta header ID_INTERNO en Tasa_Caida"
    If Not tasaHeaders.Exists("PERIODO") Then Err.Raise vbObjectError + 3022, "ExportarCore", "Falta header PERIODO en Tasa_Caida"
    If Not tasaHeaders.Exists("TRAMO") Then Err.Raise vbObjectError + 3023, "ExportarCore", "Falta header TRAMO en Tasa_Caida"
    If Not tasaHeaders.Exists("TASA") Then Err.Raise vbObjectError + 3024, "ExportarCore", "Falta header TASA en Tasa_Caida"
    
    colId = CLng(headers("ID_INTERNO"))
    colTarifa = CLng(headers("CODIGO_TARIFA"))
    colPlan = CLng(headers("PLAN"))
    
    'Siguiente ID y siguiente fila disponible (solo para insertar nuevos)
    nextId = NextIdFromHeader(baseWS, headers, "ID_INTERNO", 2)
    nextRow = NextFreeRowFromHeader(baseWS, headers, "ID_INTERNO", 2)
    
    '========================================================
    ' Index de filas existentes (misma tarifa) para reemplazo
    '========================================================
    Set idx = CreateObject("Scripting.Dictionary")
    idx.CompareMode = 1
    
    lastBaseRow = baseWS.Cells(baseWS.Rows.Count, colTarifa).End(xlUp).Row
    If lastBaseRow < 2 Then lastBaseRow = 1
    
    For r = 2 To lastBaseRow
        tarifaBase = Trim$(CStr(baseWS.Cells(r, colTarifa).Value2))
        If Len(tarifaBase) > 0 Then
            If StrComp(tarifaBase, p.CodigoTarifa, vbTextCompare) = 0 Then
                planBase = Trim$(CStr(baseWS.Cells(r, colPlan).Value2))
                idBase = CLng(ValSafe(baseWS.Cells(r, colId).Value2))
                
                key = UCase$(tarifaBase) & "|" & UCase$(planBase)
                If Not idx.Exists(key) Then
                    idx.Add key, Array(r, idBase, planBase)
                End If
            End If
        End If
    Next r
    
    Set seen = CreateObject("Scripting.Dictionary")
    seen.CompareMode = 1
    
    '========================================================
    ' Abrir input/output Condor
    '========================================================
    Set inWB = Workbooks.Open(Filename:=p.CondorInputPath, UpdateLinks:=0, ReadOnly:=True, AddToMru:=False)
    Set outWB = Workbooks.Open(Filename:=p.CondorOutputPath, UpdateLinks:=0, ReadOnly:=True, AddToMru:=False)
    
    '========================================================
    ' Parse lista de hojas input desde formulario (separadas por ;)
    ' REQUIERE: p.PlanSheetsRaw (string)
    '========================================================
    Set inputPlanNames = ParseSemicolonList(p.PlanSheetsRaw)
    If inputPlanNames Is Nothing Or inputPlanNames.Count = 0 Then
        Err.Raise vbObjectError + 3201, "ExportarCore", "No se ingresaron nombres de hojas INPUT (separadas por ';')."
    End If
    
    '========================================================
    ' Construir mapa INPUT -> OUTPUT leyendo C4 en la hoja INPUT
    ' - Usuario ingresa nombre interno (hoja input)
    ' - Nombre real de output viene en C4 de esa hoja input
    '========================================================
    Set mapInputToOutput = CreateObject("Scripting.Dictionary")
    mapInputToOutput.CompareMode = 1
    
    Set outUsed = CreateObject("Scripting.Dictionary")
    outUsed.CompareMode = 1
    
    For Each inputSheetName In inputPlanNames
        If Not WorksheetExists(inWB, CStr(inputSheetName)) Then
            Err.Raise vbObjectError + 3202, "ExportarCore", "Falta hoja INPUT: " & CStr(inputSheetName)
        End If
        
        outputSheetName = Trim$(CStr(ReadCell(inWB, CStr(inputSheetName), "C4")))
        If Len(outputSheetName) = 0 Then
            Err.Raise vbObjectError + 3203, "ExportarCore", "C4 vacío (nombre OUTPUT) en hoja INPUT: " & CStr(inputSheetName)
        End If
        
        If Not WorksheetExists(outWB, outputSheetName) Then
            Err.Raise vbObjectError + 3204, "ExportarCore", "Falta hoja OUTPUT: " & outputSheetName & " (referenciada por INPUT " & CStr(inputSheetName) & " en C4)"
        End If
        
        If outUsed.Exists(UCase$(outputSheetName)) Then
            Err.Raise vbObjectError + 3205, "ExportarCore", _
                "Dos hojas INPUT apuntan al mismo OUTPUT (" & outputSheetName & "). Revisa C4 en tus hojas INPUT."
        End If
        
        mapInputToOutput.Add CStr(inputSheetName), outputSheetName
        outUsed.Add UCase$(outputSheetName), True
    Next inputSheetName
    
    newCount = 0
    ratesDone = False
    polizaId = 0
    periodicidadPoliza = vbNullString
    
    '========================================================
    ' 1) Exportar CONSOLIDADO (output "???")
    ' - Nunca se marca ni se elimina
    ' - Usamos su ID_INTERNO como "ID de póliza" para Permanencia/Tasa_Caida
    '========================================================
    planSheetName = "???"
    planLabel = "Consolidado"
    
    If Not WorksheetExists(outWB, planSheetName) Then
        Err.Raise vbObjectError + 3101, "ExportarCore", "No existe hoja consolidado en output con nombre ???"
    End If
    
    Set outPlanWS = outWB.Worksheets(planSheetName)
    totalCol = FindTotalCol(outPlanWS, 17, 3)
    
    'Lecturas output (CLP)
    gwpCLP = CDbl(ValSafe(outPlanWS.Cells(131, totalCol).Value2))
    writtenNetTaxCLP = CDbl(ValSafe(outPlanWS.Cells(132, totalCol).Value2))
    devolucionesCLP = CDbl(ValSafe(outPlanWS.Cells(137, totalCol).Value2))
    nepCLP = CDbl(ValSafe(outPlanWS.Cells(139, totalCol).Value2))
    paidClaimsCLP = CDbl(ValSafe(outPlanWS.Cells(174, totalCol).Value2))
    comisionesMontoCLP = CDbl(ValSafe(outPlanWS.Cells(163, totalCol).Value2))
    ventasPlan = CDbl(ValSafe(outPlanWS.Cells(126, totalCol).Value2))
    
    'Expuestos = sumatoria fila 288 por meses (ignora columna Total)
    expuestosPlan = 0#
    lastColRow288 = outPlanWS.Cells(288, outPlanWS.Columns.Count).End(xlToLeft).Column
    If lastColRow288 < 3 Then lastColRow288 = 3
    
    For c = 3 To lastColRow288
        If c <> totalCol Then
            v = outPlanWS.Cells(288, c).Value2
            If IsNumeric(v) Then expuestosPlan = expuestosPlan + CDbl(v)
        End If
    Next c
    
    'Devoluciones %
    If writtenNetTaxCLP <> 0# Then devolPct = devolucionesCLP / writtenNetTaxCLP Else devolPct = Empty
    
    'Valor cliente = PaidClaims / NEP
    If nepCLP <> 0# Then valorCliente = paidClaimsCLP / nepCLP Else valorCliente = Empty
    
    'Loss ratio = PaidClaims / (NEP - comisionesMonto)
    denomLR = nepCLP - comisionesMontoCLP
    If denomLR <> 0# Then lossRatio = paidClaimsCLP / denomLR Else lossRatio = Empty
    
    'Permanencia / duración
    If ventasPlan <> 0# Then
        permanenciaPlan = expuestosPlan / ventasPlan
        duracionMediaMeses = permanenciaPlan
    Else
        permanenciaPlan = Empty
        duracionMediaMeses = Empty
    End If
    
    'IVA efectivo/recuperable
    If writtenNetTaxCLP <> 0# Then
        ivaEfectivo = (gwpCLP - writtenNetTaxCLP) / writtenNetTaxCLP
        ivaRecuperable = 0.19 - CDbl(ivaEfectivo)
    Else
        ivaEfectivo = Empty
        ivaRecuperable = Empty
    End If
    
    'Gastos directos/indirectos sobre NEP
    gastosDirectosMonto = CDbl(ValSafe(outPlanWS.Cells(191, totalCol).Value2)) + CDbl(ValSafe(outPlanWS.Cells(192, totalCol).Value2))
    gastosIndirectosMonto = CDbl(ValSafe(outPlanWS.Cells(196, totalCol).Value2)) + CDbl(ValSafe(outPlanWS.Cells(197, totalCol).Value2))
    
    If nepCLP <> 0# Then
        gastosDirectosPct = gastosDirectosMonto / nepCLP
        gastosIndirectosPct = gastosIndirectosMonto / nepCLP
    Else
        gastosDirectosPct = Empty
        gastosIndirectosPct = Empty
    End If
    
    'Inputs para consolidado quedan vacíos
    comisionesPctInput = Empty
    mesesVentaPlan = Empty
    inflacionTxt = vbNullString
    cutOffRunOffTxt = vbNullString
    fechaCutOffVal = Empty
    periodicidadTxt = vbNullString
    productTypeTxt = vbNullString
    loanDurationVal = Empty
    primaClienteNetaCalc = Empty
    
    'Key / reemplazo vs insert
    key = UCase$(Trim$(p.CodigoTarifa)) & "|" & UCase$(Trim$(planLabel))
    
    If idx.Exists(key) Then
        arr = idx(key)
        rowIndex = CLng(arr(0))
        idValue = CLng(arr(1))
    Else
        rowIndex = nextRow + newCount
        idValue = nextId + newCount
        newCount = newCount + 1
    End If
    
    'Guardamos el ID de póliza (para Permanencia / Tasa_Caida)
    polizaId = idValue
    
    'Escritura en Base (Consolidado)
    WriteByHeader baseWS, headers, rowIndex, "ID_INTERNO", idValue
    WriteByHeader baseWS, headers, rowIndex, "CODIGO_TARIFA", p.CodigoTarifa
    WriteByHeader baseWS, headers, rowIndex, "PLAN", planLabel
    WriteByHeader baseWS, headers, rowIndex, "RUTA", p.CondorOutputPath
    
    WriteByHeader baseWS, headers, rowIndex, "ID_BIZAGI", p.IdBizagi
    WriteByHeader baseWS, headers, rowIndex, "POLIZA", p.Poliza
    WriteByHeader baseWS, headers, rowIndex, "SOCIO", p.Socio
    
    WriteByHeader baseWS, headers, rowIndex, "VALIDACION_TERRITORIAL", p.ValidTerr
    WriteByHeader baseWS, headers, rowIndex, "VALIDACION_TECNICA", p.ValidTec
    WriteByHeader baseWS, headers, rowIndex, "VALIDACION_VALOR_CLIENTE", p.ValidVC
    
    WriteByHeader baseWS, headers, rowIndex, "VENTAS", ventasPlan
    WriteByHeader baseWS, headers, rowIndex, "MESES_DE_VENTA", mesesVentaPlan
    
    WriteByHeader baseWS, headers, rowIndex, "GWP", gwpCLP
    WriteByHeader baseWS, headers, rowIndex, "WRITTEN_PREMIUM_NET_TAX", writtenNetTaxCLP
    WriteByHeader baseWS, headers, rowIndex, "NEP", nepCLP
    WriteByHeader baseWS, headers, rowIndex, "CARGA_SINIESTROS", paidClaimsCLP
    WriteByHeader baseWS, headers, rowIndex, "COMISIONES_MONTO", comisionesMontoCLP
    
    'COMISIONES en Base es porcentual -> TODO
    WriteByHeader baseWS, headers, rowIndex, "COMISIONES", Empty
    
    WriteByHeader baseWS, headers, rowIndex, "SINIESTRALIDAD", lossRatio
    WriteByHeader baseWS, headers, rowIndex, "VALOR_CLIENTE", valorCliente
    
    WriteByHeader baseWS, headers, rowIndex, "DEVOLUCIONES", devolPct
    WriteByHeader baseWS, headers, rowIndex, "DEVOLUCIONES_MONTO", devolucionesCLP
    
    WriteByHeader baseWS, headers, rowIndex, "EXPUESTOS", expuestosPlan
    WriteByHeader baseWS, headers, rowIndex, "PERMANENCIA", permanenciaPlan
    WriteByHeader baseWS, headers, rowIndex, "DURACION_MEDIA_MESES", duracionMediaMeses
    
    WriteByHeader baseWS, headers, rowIndex, "PRIMA_CLIENTE_NETA", primaClienteNetaCalc
    WriteByHeader baseWS, headers, rowIndex, "UNIDAD_PRIMA_CLIENTE_NETA", "CLP"
    
    WriteByHeader baseWS, headers, rowIndex, "IVA_EFECTIVO", ivaEfectivo
    WriteByHeader baseWS, headers, rowIndex, "IVA_RECUPERABLE", ivaRecuperable
    
    WriteByHeader baseWS, headers, rowIndex, "GASTOS_DIRECTOS", gastosDirectosPct
    WriteByHeader baseWS, headers, rowIndex, "GASTOS_INDIRECTOS", gastosIndirectosPct
    WriteByHeader baseWS, headers, rowIndex, "GASTOS_DIRECTOS_MONTO", gastosDirectosMonto
    WriteByHeader baseWS, headers, rowIndex, "GASTOS_INDIRECTOS_MONTO", gastosIndirectosMonto
    
    WriteByHeader baseWS, headers, rowIndex, "INFLACION", inflacionTxt
    WriteByHeader baseWS, headers, rowIndex, "CUT_OFF_RUN_OFF", cutOffRunOffTxt
    WriteByHeader baseWS, headers, rowIndex, "FECHA_CUT_OFF", fechaCutOffVal
    
    WriteByHeader baseWS, headers, rowIndex, "PERIODICIDAD", periodicidadTxt
    WriteByHeader baseWS, headers, rowIndex, "PRODUCT_TYPE", productTypeTxt
    WriteByHeader baseWS, headers, rowIndex, "LOAN_DURATION", loanDurationVal
    
    WriteByHeader baseWS, headers, rowIndex, "COMISIONES_PCT_INPUT_C63", comisionesPctInput
    
    WriteByHeader baseWS, headers, rowIndex, "FECHA_FIN_TARIFA", Date
    WriteByHeader baseWS, headers, rowIndex, "OBSERVACION", p.Observacion
    
    'Consolidado: nunca marcar estado_plan ni fecha_estado_plan
    seen.Add key, True
    
    '========================================================
    ' 2) Exportar PLANES (lista input; output se toma desde C4)
    ' - Si agregan planes: se insertan (ID nuevo)
    ' - Si reemplazan un plan existente: se pisa la fila (mismo row / ID)
    ' - Tasa_Caida y Permanencia se pegan una sola vez (por póliza)
    '========================================================
    For Each inputSheetName In inputPlanNames
        outputSheetName = CStr(mapInputToOutput(CStr(inputSheetName)))
        
        planSheetName = outputSheetName
        planLabel = outputSheetName 'Nombre real (viene desde C4 del input)
        
        Set outPlanWS = outWB.Worksheets(planSheetName)
        totalCol = FindTotalCol(outPlanWS, 17, 3)
        
        'Output por plan (CLP)
        gwpCLP = CDbl(ValSafe(outPlanWS.Cells(131, totalCol).Value2))
        writtenNetTaxCLP = CDbl(ValSafe(outPlanWS.Cells(132, totalCol).Value2))
        devolucionesCLP = CDbl(ValSafe(outPlanWS.Cells(137, totalCol).Value2))
        nepCLP = CDbl(ValSafe(outPlanWS.Cells(139, totalCol).Value2))
        paidClaimsCLP = CDbl(ValSafe(outPlanWS.Cells(174, totalCol).Value2))
        comisionesMontoCLP = CDbl(ValSafe(outPlanWS.Cells(163, totalCol).Value2))
        ventasPlan = CDbl(ValSafe(outPlanWS.Cells(126, totalCol).Value2))
        
        'Expuestos = sumatoria fila 288 por meses (ignora columna Total)
        expuestosPlan = 0#
        lastColRow288 = outPlanWS.Cells(288, outPlanWS.Columns.Count).End(xlToLeft).Column
        If lastColRow288 < 3 Then lastColRow288 = 3
        
        For c = 3 To lastColRow288
            If c <> totalCol Then
                v = outPlanWS.Cells(288, c).Value2
                If IsNumeric(v) Then expuestosPlan = expuestosPlan + CDbl(v)
            End If
        Next c
        
        'Devoluciones %
        If writtenNetTaxCLP <> 0# Then devolPct = devolucionesCLP / writtenNetTaxCLP Else devolPct = Empty
        
        'Valor cliente = PaidClaims / NEP
        If nepCLP <> 0# Then valorCliente = paidClaimsCLP / nepCLP Else valorCliente = Empty
        
        'Loss ratio = PaidClaims / (NEP - comisionesMonto)
        denomLR = nepCLP - comisionesMontoCLP
        If denomLR <> 0# Then lossRatio = paidClaimsCLP / denomLR Else lossRatio = Empty
        
        'Permanencia / duración (por ahora misma fórmula; periodicidad puede cambiar definiciones)
        If ventasPlan <> 0# Then
            permanenciaPlan = expuestosPlan / ventasPlan
            duracionMediaMeses = permanenciaPlan
        Else
            permanenciaPlan = Empty
            duracionMediaMeses = Empty
        End If
        
        'IVA efectivo/recuperable
        If writtenNetTaxCLP <> 0# Then
            ivaEfectivo = (gwpCLP - writtenNetTaxCLP) / writtenNetTaxCLP
            ivaRecuperable = 0.19 - CDbl(ivaEfectivo)
        Else
            ivaEfectivo = Empty
            ivaRecuperable = Empty
        End If
        
        'Gastos directos/indirectos sobre NEP
        gastosDirectosMonto = CDbl(ValSafe(outPlanWS.Cells(191, totalCol).Value2)) + CDbl(ValSafe(outPlanWS.Cells(192, totalCol).Value2))
        gastosIndirectosMonto = CDbl(ValSafe(outPlanWS.Cells(196, totalCol).Value2)) + CDbl(ValSafe(outPlanWS.Cells(197, totalCol).Value2))
        
        If nepCLP <> 0# Then
            gastosDirectosPct = gastosDirectosMonto / nepCLP
            gastosIndirectosPct = gastosIndirectosMonto / nepCLP
        Else
            gastosDirectosPct = Empty
            gastosIndirectosPct = Empty
        End If
        
        'Input por plan (hoja INPUT ingresada por usuario)
        comisionesPctInput = NormalizePct(ReadCell(inWB, CStr(inputSheetName), "C63"))
        mesesVentaPlan = ReadCell(inWB, CStr(inputSheetName), "C9")
        
        inflacionTxt = Trim$(CStr(ReadCell(inWB, CStr(inputSheetName), "C14")))
        cutOffRunOffTxt = Trim$(CStr(ReadCell(inWB, CStr(inputSheetName), "C270")))
        
        If StrComp(cutOffRunOffTxt, "Cut-Off", vbTextCompare) = 0 Then
            fechaCutOffVal = ReadCell(inWB, CStr(inputSheetName), "C272")
        Else
            fechaCutOffVal = Empty
        End If
        
        periodicidadTxt = Trim$(CStr(ReadCell(inWB, CStr(inputSheetName), "C39")))
        productTypeTxt = Trim$(CStr(ReadCell(inWB, CStr(inputSheetName), "C49")))
        loanDurationVal = ReadCell(inWB, CStr(inputSheetName), "C35")
        
        'Tasa caída 144 meses fila 27 desde H (se lee igual que antes)
        tasaColStart = 8
        For k = 1 To 144
            tasaCaida(k) = CDbl(ValSafe(inWB.Worksheets(CStr(inputSheetName)).Cells(27, tasaColStart + (k - 1)).Value2))
        Next k
        
        '====================================================
        ' Pegar Tasa_Caida + Permanencia UNA SOLA VEZ por póliza
        ' - ID_INTERNO = polizaId (del consolidado)
        ' - Tasa_Caida: siempre se pega
        ' - Permanencia: si es mensual -> calculamos y TIPO="PERMANENCIA"
        '                si es única -> TODO (no sabemos fórmula) y TIPO="TODO"
        '====================================================
        If Not ratesDone Then
            periodicidadPoliza = periodicidadTxt
            
            'Calcular permanencias (solo caso mensual)
            Call CalcPermanenciasFromTasaCaida(tasaCaida, permanencias)
            
            'Upsert de ambas tablas (borramos lo anterior del mismo ID y pegamos de nuevo)
            Call UpsertTasaCaida(repoWB, tasaWS, tasaHeaders, polizaId, tasaCaida)
            Call UpsertPermanencia(repoWB, permWS, permHeaders, polizaId, permanencias, periodicidadPoliza)
            
            ratesDone = True
        End If
        
        'Prima cliente neta según periodicidad (si no calza texto, queda vacío)
        primaClienteNetaCalc = Empty
        If Len(periodicidadTxt) > 0 Then
            If InStr(1, LCase$(periodicidadTxt), "mens", vbTextCompare) > 0 Or InStr(1, LCase$(periodicidadTxt), "month", vbTextCompare) > 0 Then
                If expuestosPlan <> 0# Then primaClienteNetaCalc = gwpCLP / expuestosPlan
            ElseIf InStr(1, LCase$(periodicidadTxt), "unic", vbTextCompare) > 0 Or InStr(1, LCase$(periodicidadTxt), "single", vbTextCompare) > 0 Then
                If ventasPlan <> 0# Then primaClienteNetaCalc = gwpCLP / ventasPlan
            Else
                'TODO: definir periodicidades adicionales
                primaClienteNetaCalc = Empty
            End If
        End If
        
        'Reemplazo vs insert
        key = UCase$(Trim$(p.CodigoTarifa)) & "|" & UCase$(Trim$(planLabel))
        
        If idx.Exists(key) Then
            arr = idx(key)
            rowIndex = CLng(arr(0))
            idValue = CLng(arr(1))
        Else
            rowIndex = nextRow + newCount
            idValue = nextId + newCount
            newCount = newCount + 1
        End If
        
        'Escritura en Base (Plan)
        WriteByHeader baseWS, headers, rowIndex, "ID_INTERNO", idValue
        WriteByHeader baseWS, headers, rowIndex, "CODIGO_TARIFA", p.CodigoTarifa
        WriteByHeader baseWS, headers, rowIndex, "PLAN", planLabel
        WriteByHeader baseWS, headers, rowIndex, "RUTA", p.CondorOutputPath
        
        WriteByHeader baseWS, headers, rowIndex, "ID_BIZAGI", p.IdBizagi
        WriteByHeader baseWS, headers, rowIndex, "POLIZA", p.Poliza
        WriteByHeader baseWS, headers, rowIndex, "SOCIO", p.Socio
        
        WriteByHeader baseWS, headers, rowIndex, "VALIDACION_TERRITORIAL", p.ValidTerr
        WriteByHeader baseWS, headers, rowIndex, "VALIDACION_TECNICA", p.ValidTec
        WriteByHeader baseWS, headers, rowIndex, "VALIDACION_VALOR_CLIENTE", p.ValidVC
        
        WriteByHeader baseWS, headers, rowIndex, "VENTAS", ventasPlan
        WriteByHeader baseWS, headers, rowIndex, "MESES_DE_VENTA", mesesVentaPlan
        
        WriteByHeader baseWS, headers, rowIndex, "GWP", gwpCLP
        WriteByHeader baseWS, headers, rowIndex, "WRITTEN_PREMIUM_NET_TAX", writtenNetTaxCLP
        WriteByHeader baseWS, headers, rowIndex, "NEP", nepCLP
        WriteByHeader baseWS, headers, rowIndex, "CARGA_SINIESTROS", paidClaimsCLP
        WriteByHeader baseWS, headers, rowIndex, "COMISIONES_MONTO", comisionesMontoCLP
        
        'COMISIONES en Base es porcentual -> TODO
        WriteByHeader baseWS, headers, rowIndex, "COMISIONES", Empty
        
        WriteByHeader baseWS, headers, rowIndex, "SINIESTRALIDAD", lossRatio
        WriteByHeader baseWS, headers, rowIndex, "VALOR_CLIENTE", valorCliente
        
        WriteByHeader baseWS, headers, rowIndex, "DEVOLUCIONES", devolPct
        WriteByHeader baseWS, headers, rowIndex, "DEVOLUCIONES_MONTO", devolucionesCLP
        
        WriteByHeader baseWS, headers, rowIndex, "EXPUESTOS", expuestosPlan
        WriteByHeader baseWS, headers, rowIndex, "PERMANENCIA", permanenciaPlan
        WriteByHeader baseWS, headers, rowIndex, "DURACION_MEDIA_MESES", duracionMediaMeses
        
        WriteByHeader baseWS, headers, rowIndex, "PRIMA_CLIENTE_NETA", primaClienteNetaCalc
        WriteByHeader baseWS, headers, rowIndex, "UNIDAD_PRIMA_CLIENTE_NETA", "CLP"
        
        WriteByHeader baseWS, headers, rowIndex, "IVA_EFECTIVO", ivaEfectivo
        WriteByHeader baseWS, headers, rowIndex, "IVA_RECUPERABLE", ivaRecuperable
        
        WriteByHeader baseWS, headers, rowIndex, "GASTOS_DIRECTOS", gastosDirectosPct
        WriteByHeader baseWS, headers, rowIndex, "GASTOS_INDIRECTOS", gastosIndirectosPct
        WriteByHeader baseWS, headers, rowIndex, "GASTOS_DIRECTOS_MONTO", gastosDirectosMonto
        WriteByHeader baseWS, headers, rowIndex, "GASTOS_INDIRECTOS_MONTO", gastosIndirectosMonto
        
        WriteByHeader baseWS, headers, rowIndex, "INFLACION", inflacionTxt
        WriteByHeader baseWS, headers, rowIndex, "CUT_OFF_RUN_OFF", cutOffRunOffTxt
        WriteByHeader baseWS, headers, rowIndex, "FECHA_CUT_OFF", fechaCutOffVal
        
        WriteByHeader baseWS, headers, rowIndex, "PERIODICIDAD", periodicidadTxt
        WriteByHeader baseWS, headers, rowIndex, "PRODUCT_TYPE", productTypeTxt
        WriteByHeader baseWS, headers, rowIndex, "LOAN_DURATION", loanDurationVal
        
        WriteByHeader baseWS, headers, rowIndex, "COMISIONES_PCT_INPUT_C63", comisionesPctInput
        
        WriteByHeader baseWS, headers, rowIndex, "FECHA_FIN_TARIFA", Date
        WriteByHeader baseWS, headers, rowIndex, "OBSERVACION", p.Observacion
        
        'Estado del plan (vigente)
        WriteByHeader baseWS, headers, rowIndex, "ESTADO_PLAN", "Vigente"
        WriteByHeader baseWS, headers, rowIndex, "FECHA_ESTADO_PLAN", Date
        
        seen.Add key, True
    Next inputSheetName
    
    '========================================================
    ' 3) Marcar planes eliminados (para esta tarifa), excepto consolidado
    '========================================================
    Dim kDel As Variant
    Dim arrDel As Variant
    Dim rowDel As Long
    Dim planDel As String
    
    For Each kDel In idx.Keys
        If Not seen.Exists(CStr(kDel)) Then
            arrDel = idx(CStr(kDel))
            rowDel = CLng(arrDel(0))
            planDel = Trim$(CStr(arrDel(2)))
            
            If StrComp(planDel, "Consolidado", vbTextCompare) <> 0 Then
                WriteByHeader baseWS, headers, rowDel, "ESTADO_PLAN", "Eliminado"
                WriteByHeader baseWS, headers, rowDel, "FECHA_ESTADO_PLAN", Date
            End If
        End If
    Next kDel
    
    repoWB.Save
    
CLEANUP:
    On Error Resume Next
    
    If Not inWB Is Nothing Then inWB.Close SaveChanges:=False
    If Not outWB Is Nothing Then outWB.Close SaveChanges:=False
    
    If closeRepoAfter Then
        If Not repoWB Is Nothing Then repoWB.Close SaveChanges:=False
    End If
    
    Application.Calculation = prevCalculation
    Application.AskToUpdateLinks = prevAskToUpdateLinks
    Application.DisplayAlerts = prevDisplayAlerts
    Application.EnableEvents = prevEnableEvents
    Application.ScreenUpdating = prevScreenUpdating
    
    Exit Sub
    
FAIL:
    MsgBox "Error exportando al Repositorio: " & Err.Description, vbCritical
    Resume CLEANUP
End Sub

'========================================================
' Helpers (lista separada por ;)
'========================================================
Private Function ParseSemicolonList(ByVal rawText As String) As Collection
    Dim col As Collection
    Dim parts As Variant
    Dim i As Long
    Dim s As String
    Dim seen As Object
    
    Set col = New Collection
    Set seen = CreateObject("Scripting.Dictionary")
    seen.CompareMode = 1
    
    rawText = Trim$(rawText)
    If Len(rawText) = 0 Then
        Set ParseSemicolonList = col
        Exit Function
    End If
    
    parts = Split(rawText, ";")
    For i = LBound(parts) To UBound(parts)
        s = Trim$(CStr(parts(i)))
        If Len(s) > 0 Then
            If Not seen.Exists(UCase$(s)) Then
                col.Add s
                seen.Add UCase$(s), True
            End If
        End If
    Next i
    
    Set ParseSemicolonList = col
End Function

'========================================================
' Calcula permanencias desde tasa de caída mensual.
' - Caso mensual: permanencia(m) = permanencia(m-1) * (1 - tasaCaida(m))
' - Caso única: TODO (se deja para UpsertPermanencia)
'========================================================
Private Sub CalcPermanenciasFromTasaCaida(ByRef tasaCaida() As Double, ByRef permanencias() As Double)
    Dim m As Long
    Dim p As Double
    
    p = 1#
    For m = 1 To 144
        p = p * (1# - tasaCaida(m))
        permanencias(m) = p
    Next m
End Sub

'========================================================
' Upsert de Tasa_Caida en repo:
' - Borra filas existentes con el mismo ID_INTERNO
' - Inserta 144 filas: ID_INTERNO, PERIODO, TRAMO (vacío), TASA
'========================================================
Private Sub UpsertTasaCaida(ByRef repoWB As Workbook, ByRef tasaWS As Worksheet, ByRef tasaHeaders As Object, ByVal polizaId As Long, ByRef tasaCaida() As Double)
    Dim startRow As Long
    Dim outRow As Long
    Dim i As Long
    
    'Borrar lo existente para este ID
    Call DeleteRowsById(tasaWS, tasaHeaders, "ID_INTERNO", polizaId, 2)
    
    'Pegar al final
    startRow = NextFreeRowFromHeader(tasaWS, tasaHeaders, "ID_INTERNO", 2)
    outRow = startRow
    
    For i = 1 To 144
        WriteByHeader tasaWS, tasaHeaders, outRow, "ID_INTERNO", polizaId
        WriteByHeader tasaWS, tasaHeaders, outRow, "PERIODO", i
        WriteByHeader tasaWS, tasaHeaders, outRow, "TRAMO", Empty      'TODO más adelante
        WriteByHeader tasaWS, tasaHeaders, outRow, "TASA", tasaCaida(i)
        outRow = outRow + 1
    Next i
End Sub

'========================================================
' Upsert de Permanencia en repo:
' - Borra filas existentes con el mismo ID_INTERNO
' - Inserta 144 filas: ID_INTERNO, MES, VALOR, TIPO
'   * Si periodicidad es mensual -> VALOR = permanencias(m), TIPO="PERMANENCIA"
'   * Si periodicidad es única -> VALOR = Empty, TIPO="TODO"
'========================================================
Private Sub UpsertPermanencia(ByRef repoWB As Workbook, ByRef permWS As Worksheet, ByRef permHeaders As Object, ByVal polizaId As Long, ByRef permanencias() As Double, ByVal periodicidadTxt As String)
    Dim startRow As Long
    Dim outRow As Long
    Dim i As Long
    Dim isMensual As Boolean
    
    isMensual = False
    If Len(periodicidadTxt) > 0 Then
        If InStr(1, LCase$(periodicidadTxt), "mens", vbTextCompare) > 0 Or InStr(1, LCase$(periodicidadTxt), "month", vbTextCompare) > 0 Then
            isMensual = True
        End If
    End If
    
    'Borrar lo existente para este ID
    Call DeleteRowsById(permWS, permHeaders, "ID_INTERNO", polizaId, 2)
    
    'Pegar al final
    startRow = NextFreeRowFromHeader(permWS, permHeaders, "ID_INTERNO", 2)
    outRow = startRow
    
    For i = 1 To 144
        WriteByHeader permWS, permHeaders, outRow, "ID_INTERNO", polizaId
        WriteByHeader permWS, permHeaders, outRow, "MES", i
        
        If isMensual Then
            WriteByHeader permWS, permHeaders, outRow, "VALOR", permanencias(i)
            WriteByHeader permWS, permHeaders, outRow, "TIPO", "PERMANENCIA"
        Else
            'Única (u otras): TODO, fórmula pendiente
            WriteByHeader permWS, permHeaders, outRow, "VALOR", Empty
            WriteByHeader permWS, permHeaders, outRow, "TIPO", "TODO"
        End If
        
        outRow = outRow + 1
    Next i
End Sub

'========================================================
' Borra todas las filas (desde startRow) donde header(idHeaderName) = idValue.
' - Se usa para "upsert" (reemplazar completo por ese ID)
'========================================================
Private Sub DeleteRowsById(ByRef ws As Worksheet, ByRef headers As Object, ByVal idHeaderName As String, ByVal idValue As Long, ByVal startRow As Long)
    Dim idCol As Long
    Dim lastRow As Long
    Dim r As Long
    Dim v As Variant
    
    If Not headers.Exists(idHeaderName) Then Exit Sub
    
    idCol = CLng(headers(idHeaderName))
    lastRow = ws.Cells(ws.Rows.Count, idCol).End(xlUp).Row
    If lastRow < startRow Then Exit Sub
    
    'Borrar de abajo hacia arriba
    For r = lastRow To startRow Step -1
        v = ws.Cells(r, idCol).Value2
        If IsNumeric(v) Then
            If CLng(v) = idValue Then
                ws.Rows(r).Delete
            End If
        End If
    Next r
End Sub
