Option Explicit

'===========================================================
' Export Condor + BPs -> Repositorio (Base, Permanencia, Tasa_Caida)
'
' Flujo:
' 1) Abrimos repo y armamos index de filas existentes por (CODIGO_TARIFA + PLAN)
' 2) Abrimos Condor Input (BPInputTemplate...) y armamos diccionario:
'       X (hoja input) -> A (nombre plan real en C4)
'    + leemos inputs por plan (C9, C14, C39, C49, C270, C272, tasa caída fila 27 C:EP)
' 3) Abrimos Condor Output (Results_BPInputTemplate...) y leemos:
'    - Consolidado oficial desde hoja "Results_IFRS4_Net"
'    - Planes desde hoja "A", "B", "C" (nombres reales)
' 4) Abrimos BPs (solo como archivos):
'    - BP por plan: extraer "Parametros" (I53, M52, C8, C29:C43, D29:D43, E29:E43, y UF para conversión)
'    - BP consolidado ("...consolidado..."): extraer SOLO lo marcado como "BP Mensual Consolidado"
' 5) Upsert en Base (reemplaza si existe, inserta si no)
' 6) Upsert Tasa_Caida + Permanencia UNA sola vez por póliza (ID del consolidado)
' 7) Marca como "Eliminado" planes que existían para la tarifa y ya no vienen
'===========================================================

'-----------------------
' Parámetros de ejecución
'-----------------------
Public Type tExportParams
    RepoPath As String

    CondorInputPath As String          'BPInputTemplate...
    CondorOutputPath As String         'Results_BPInputTemplate...

    FilesFolder As String              'Carpeta donde están los BPs (por plan y consolidado)

    'Manual / formulario (se repite para consolidado y planes)
    CodigoTarifa As String
    IdBizagi As String
    Poliza As String
    Socio As String

    ValidTerr As Variant
    ValidTec As Variant
    ValidVC As Variant

    CuotasPromedio As Variant
    OtrosCostosDirectosFijos As Variant
    ProfitSharing As Variant
    PrimaCedida As Variant
    FormulaSiniestralidadAplica As Variant
    Brim As Variant
    Observacion As String
    PlanAccion As String
    ProductoCuentaAsistencia As Variant
    DescuentoAsistenciaPct As Variant
    TieneEcosistema As Variant
    CanalTMK As Variant
    ROP As Variant
    BonificacionROPPct As Variant
    VentaPorPlanes As Variant
    TarifaTieneModificaciones As Variant
    PolizaEsContinuacion As Variant

    'Lista de hojas INPUT separadas por ";", por ejemplo: "X;Y;Z"
    PlanSheetsRaw As String
End Type

'-----------------------
' Setup: nombres de hojas / celdas ajustables
'-----------------------
Private Const REPO_BASE_SHEET As String = "Base"
Private Const REPO_PERM_SHEET As String = "Permanencia"
Private Const REPO_TASA_SHEET As String = "Tasa_Caida"

Private Const CONDOR_SHEET_CONSOLIDADO As String = "Results_IFRS4_Net"
Private Const CONDOR_TOTAL_HEADER_ROW As Long = 17
Private Const CONDOR_TOTAL_HEADER_TEXT As String = "Total"
Private Const CONDOR_MIN_DATA_COL As Long = 3   'C

'Filas (Output Condor) — se asume mismo layout en consolidado y en plan
Private Const ROW_VENTAS As Long = 126
Private Const ROW_GWP As Long = 131
Private Const ROW_WRITTEN_NET_TAX As Long = 132
Private Const ROW_DEVOLUCIONES As Long = 137
Private Const ROW_NEP As Long = 139
Private Const ROW_COMISIONES_MONTO As Long = 163
Private Const ROW_CLAIMS As Long = 174
Private Const ROW_EXPUESTOS As Long = 288

'Input Condor (por hoja X/Y/Z)
Private Const IN_ADDR_PLANNAME As String = "C4"
Private Const IN_ADDR_MESES_VENTA As String = "C9"
Private Const IN_ADDR_INFLACION As String = "C14"
Private Const IN_ADDR_PERIODICIDAD As String = "C39"
Private Const IN_ADDR_PRODUCT_TYPE As String = "C49"
Private Const IN_ADDR_CUTOFF_RUNOFF As String = "C270"
Private Const IN_ADDR_FECHA_CUTOFF As String = "C272"

'Input Condor tasa caída: fila 27, columnas C:EP (144 meses)
Private Const IN_TASA_ROW As Long = 27
Private Const IN_TASA_COL_START As Long = 3     'C
Private Const IN_TASA_MONTHS As Long = 144

'BP por plan
Private Const BP_PARAMS_SHEET As String = "Parametros"
Private Const BP_PARAMS_ASIST_MENSUAL As String = "I53"
Private Const BP_PARAMS_COSTO_VENTA As String = "M52"
Private Const BP_PARAMS_MESES_CARENCIA As String = "C8"
Private Const BP_PARAMS_CAPITAL_ASEG_RNG As String = "C29:C43"
Private Const BP_PARAMS_SIN_MEDIO_RNG As String = "D29:D43"
Private Const BP_PARAMS_TASA_ENTR_RNG As String = "E29:E43"

'Para convertir UF -> CLP desde BP Parámetros:
'Regla: buscamos el label "UF" en una tabla de parámetros y leemos el valor al lado.
'Si tu BP tiene UF en otra ubicación, ajusta columnas o el label.
Private Const BP_UF_LABEL As String = "UF"
Private Const BP_UF_SEARCH_COL As Long = 2      'B (ajustable)
Private Const BP_UF_VALUE_OFFSET As Long = 1    'columna a la derecha del label (ajustable)

'BP consolidado (archivo que contiene "consolidado") — SOLO vars "BP Mensual Consolidado"
Private Const BP_MENSUAL_SHEET As String = "BP Mensual"
Private Const BP_CONS_REASEGURO_CELL As String = "KR50"
Private Const BP_CONS_SINIESTRO_CEDIDO_CELL As String = "KR49" 'TODO: confirmar si es monto o ratio KR49/KR37
Private Const BP_CONS_ASIST_CELL As String = "KR39"
Private Const BP_CONS_NEP_CELL As String = "KR18"

'Valores "pendientes": deben quedar como texto literal
Private Const TODO_TEXT As String = "TODO"

'===========================================================
' Entrada principal
'===========================================================
Public Sub ExportarRepositorio(ByRef p As tExportParams, ByVal closeRepoAfter As Boolean)

    Dim prevScreenUpdating As Boolean
    Dim prevEnableEvents As Boolean
    Dim prevDisplayAlerts As Boolean
    Dim prevAskToUpdateLinks As Boolean
    Dim prevCalculation As XlCalculation

    Dim repoWB As Workbook
    Dim baseWS As Worksheet, permWS As Worksheet, tasaWS As Worksheet
    Dim headers As Object, permHeaders As Object, tasaHeaders As Object

    Dim idx As Object, seen As Object
    Dim colId As Long, colTarifa As Long, colPlan As Long
    Dim nextId As Long, nextRow As Long, lastBaseRow As Long
    Dim r As Long

    Dim inWB As Workbook, outWB As Workbook
    Dim inputSheets As Collection
    Dim planMap As Object 'X -> A
    Dim planInputs As Object 'A -> dict(inputs)
    Dim planOrder As Collection 'A,B,C en el orden del input

    Dim folderPath As String
    Dim bpFiles As Variant

    On Error GoTo FAIL

    'Estabilidad Excel
    prevScreenUpdating = Application.ScreenUpdating
    prevEnableEvents = Application.EnableEvents
    prevDisplayAlerts = Application.DisplayAlerts
    prevAskToUpdateLinks = Application.AskToUpdateLinks
    prevCalculation = Application.Calculation

    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.DisplayAlerts = False
    Application.AskToUpdateLinks = False
    Application.Calculation = xlCalculationManual

    'Validaciones mínimas
    If Len(Trim$(p.RepoPath)) = 0 Then Err.Raise vbObjectError + 7001, "ExportarRepositorio", "RepoPath vacío."
    If Len(Trim$(p.CondorInputPath)) = 0 Then Err.Raise vbObjectError + 7002, "ExportarRepositorio", "CondorInputPath vacío."
    If Len(Trim$(p.CondorOutputPath)) = 0 Then Err.Raise vbObjectError + 7003, "ExportarRepositorio", "CondorOutputPath vacío."

    folderPath = NormalizeFolderPath(p.FilesFolder)

    'Abrir repo
    Set repoWB = Workbooks.Open(Filename:=p.RepoPath, UpdateLinks:=0, ReadOnly:=False, AddToMru:=False)
    Set baseWS = GetWorksheet(repoWB, REPO_BASE_SHEET)
    Set permWS = GetWorksheet(repoWB, REPO_PERM_SHEET)
    Set tasaWS = GetWorksheet(repoWB, REPO_TASA_SHEET)

    Set headers = BuildHeaderMap(baseWS, 1)
    Set permHeaders = BuildHeaderMap(permWS, 1)
    Set tasaHeaders = BuildHeaderMap(tasaWS, 1)

    'Headers mínimos
    RequireHeader headers, "ID_INTERNO", REPO_BASE_SHEET
    RequireHeader headers, "CODIGO_TARIFA", REPO_BASE_SHEET
    RequireHeader headers, "PLAN", REPO_BASE_SHEET

    RequireHeader permHeaders, "ID_INTERNO", REPO_PERM_SHEET
    RequireHeader permHeaders, "MES", REPO_PERM_SHEET
    RequireHeader permHeaders, "VALOR", REPO_PERM_SHEET
    RequireHeader permHeaders, "TIPO", REPO_PERM_SHEET

    RequireHeader tasaHeaders, "ID_INTERNO", REPO_TASA_SHEET
    RequireHeader tasaHeaders, "PERIODO", REPO_TASA_SHEET
    RequireHeader tasaHeaders, "TRAMO", REPO_TASA_SHEET
    RequireHeader tasaHeaders, "TASA", REPO_TASA_SHEET

    colId = CLng(headers("ID_INTERNO"))
    colTarifa = CLng(headers("CODIGO_TARIFA"))
    colPlan = CLng(headers("PLAN"))

    nextId = NextIdFromHeader(baseWS, colId, 2)
    nextRow = NextFreeRow(baseWS, colId, 2)

    'Index de filas existentes para la misma tarifa
    Set idx = CreateObject("Scripting.Dictionary")
    idx.CompareMode = vbTextCompare

    lastBaseRow = baseWS.Cells(baseWS.Rows.Count, colTarifa).End(xlUp).Row
    If lastBaseRow < 2 Then lastBaseRow = 1

    For r = 2 To lastBaseRow
        Dim tarifaBase As String
        Dim planBase As String
        Dim idBase As Long
        Dim key As String

        tarifaBase = Trim$(CStr(baseWS.Cells(r, colTarifa).Value2))
        If Len(tarifaBase) > 0 Then
            If StrComp(tarifaBase, p.CodigoTarifa, vbTextCompare) = 0 Then
                planBase = Trim$(CStr(baseWS.Cells(r, colPlan).Value2))
                idBase = CLng(ValSafe(baseWS.Cells(r, colId).Value2))
                key = UCase$(tarifaBase) & "|" & UCase$(planBase)
                If Not idx.Exists(key) Then idx.Add key, Array(r, idBase, planBase)
            End If
        End If
    Next r

    Set seen = CreateObject("Scripting.Dictionary")
    seen.CompareMode = vbTextCompare

    'Abrir Condor Input y armar mapping X->A
    Set inWB = Workbooks.Open(Filename:=p.CondorInputPath, UpdateLinks:=0, ReadOnly:=True, AddToMru:=False)

    Set inputSheets = ParseSemicolonList(p.PlanSheetsRaw)
    If inputSheets Is Nothing Or inputSheets.Count = 0 Then
        Err.Raise vbObjectError + 7101, "ExportarRepositorio", "No se ingresaron hojas INPUT (PlanSheetsRaw)."
    End If

    Set planMap = CreateObject("Scripting.Dictionary")
    planMap.CompareMode = vbTextCompare

    Set planInputs = CreateObject("Scripting.Dictionary")
    planInputs.CompareMode = vbTextCompare

    Set planOrder = New Collection

    BuildPlanMappingsAndInputs inWB, inputSheets, planMap, planInputs, planOrder

    'Abrir Condor Output
    Set outWB = Workbooks.Open(Filename:=p.CondorOutputPath, UpdateLinks:=0, ReadOnly:=True, AddToMru:=False)

    'Listar archivos BP en carpeta (excluye repo y condor input/output)
    bpFiles = FS_ListExcelFilesInFolder(folderPath, repoWB.FullName, p.CondorInputPath, p.CondorOutputPath)
    If IsEmpty(bpFiles) Then Err.Raise vbObjectError + 7201, "ExportarRepositorio", "No hay BPs en carpeta: " & folderPath

    FS_SortFilesNatural bpFiles

    '=========
    ' 1) CONSOLIDADO OFICIAL (Condor output: Results_IFRS4_Net)
    '=========
    Dim polizaId As Long
    polizaId = UpsertConsolidado baseWS, headers, idx, seen, nextRow, nextId, p, outWB, planInputs, bpFiles

    '=========
    ' 2) PLANES (Condor output: hojas A,B,C)
    '=========
    UpsertPlanes baseWS, headers, idx, seen, nextRow, nextId, p, outWB, planInputs, planOrder, bpFiles, polizaId

    '=========
    ' 3) Tasa_Caida + Permanencia (solo una vez por póliza)
    '    Regla actual: usa la tasa del primer plan en el orden del input.
    '    TODO: si en el futuro existen planes con tasas distintas, definir regla.
    '=========
    UpsertRatesAndPermanenciaOnce permWS, permHeaders, tasaWS, tasaHeaders, polizaId, planInputs, planOrder

    '=========
    ' 4) Marcar eliminados (planes que existían antes y ya no vienen)
    '=========
    MarkDeletedPlans baseWS, headers, idx, seen

    repoWB.Save

CLEANUP:
    On Error Resume Next
    If Not outWB Is Nothing Then outWB.Close SaveChanges:=False
    If Not inWB Is Nothing Then inWB.Close SaveChanges:=False

    If closeRepoAfter Then
        If Not repoWB Is Nothing Then repoWB.Close SaveChanges:=False
    End If

    Application.Calculation = prevCalculation
    Application.AskToUpdateLinks = prevAskToUpdateLinks
    Application.DisplayAlerts = prevDisplayAlerts
    Application.EnableEvents = prevEnableEvents
    Application.ScreenUpdating = prevScreenUpdating
    Exit Sub

FAIL:
    MsgBox "Error exportando al Repositorio: " & Err.Description, vbCritical
    Resume CLEANUP
End Sub

'===========================================================
' Condor Input: mapping X->A y lectura inputs por plan
' planInputs(A) = dict con keys: meses_venta, inflacion, periodicidad, product_type, cut_off_run_off, fecha_cut_off, tasa(1..144)
'===========================================================
Private Sub BuildPlanMappingsAndInputs(ByVal inWB As Workbook, ByVal inputSheets As Collection, _
                                      ByRef planMap As Object, ByRef planInputs As Object, ByRef planOrder As Collection)

    Dim s As Variant
    For Each s In inputSheets
        Dim inputSheetName As String
        Dim planName As String

        inputSheetName = CStr(s)
        planName = Trim$(CStr(ReadCell(inWB, inputSheetName, IN_ADDR_PLANNAME)))
        If Len(planName) = 0 Then
            Err.Raise vbObjectError + 7301, "BuildPlanMappingsAndInputs", "C4 vacío (nombre plan) en hoja INPUT: " & inputSheetName
        End If

        planMap(inputSheetName) = planName

        'Guardar orden (A,B,C...) tal como viene del input
        planOrder.Add planName

        'Inputs por plan
        Dim d As Object
        Set d = CreateObject("Scripting.Dictionary")
        d.CompareMode = vbTextCompare

        d("meses_venta") = ReadCell(inWB, inputSheetName, IN_ADDR_MESES_VENTA)
        d("inflacion") = Trim$(CStr(ReadCell(inWB, inputSheetName, IN_ADDR_INFLACION)))
        d("periodicidad") = Trim$(CStr(ReadCell(inWB, inputSheetName, IN_ADDR_PERIODICIDAD)))
        d("product_type") = Trim$(CStr(ReadCell(inWB, inputSheetName, IN_ADDR_PRODUCT_TYPE)))

        Dim cutTxt As String
        cutTxt = Trim$(CStr(ReadCell(inWB, inputSheetName, IN_ADDR_CUTOFF_RUNOFF)))
        d("cut_off_run_off") = cutTxt

        If StrComp(cutTxt, "Cut-Off", vbTextCompare) = 0 Then
            d("fecha_cut_off") = ReadCell(inWB, inputSheetName, IN_ADDR_FECHA_CUTOFF)
        Else
            d("fecha_cut_off") = Empty
        End If

        'Tasa caída 144 meses (fila 27, C:EP)
        Dim tasa(1 To IN_TASA_MONTHS) As Double
        Dim k As Long
        For k = 1 To IN_TASA_MONTHS
            tasa(k) = CDbl(ValSafe(inWB.Worksheets(inputSheetName).Cells(IN_TASA_ROW, IN_TASA_COL_START + (k - 1)).Value2))
        Next k
        d("tasa") = tasa

        planInputs(planName) = d
    Next s
End Sub

'===========================================================
' Upsert Consolidado oficial (Results_IFRS4_Net) + BP consolidado vars
' Devuelve polizaId (ID_INTERNO del consolidado)
'===========================================================
Private Function UpsertConsolidado(ByVal baseWS As Worksheet, ByVal headers As Object, _
                                  ByVal idx As Object, ByVal seen As Object, _
                                  ByRef nextRow As Long, ByRef nextId As Long, _
                                  ByRef p As tExportParams, ByVal outWB As Workbook, _
                                  ByVal planInputs As Object, ByVal bpFiles As Variant) As Long

    Dim ws As Worksheet
    If Not WorksheetExists(outWB, CONDOR_SHEET_CONSOLIDADO) Then
        Err.Raise vbObjectError + 7401, "UpsertConsolidado", "No existe hoja '" & CONDOR_SHEET_CONSOLIDADO & "' en " & outWB.Name
    End If
    Set ws = outWB.Worksheets(CONDOR_SHEET_CONSOLIDADO)

    Dim totalCol As Long
    totalCol = FindTotalCol(ws, CONDOR_TOTAL_HEADER_ROW, CONDOR_MIN_DATA_COL)

    Dim m As tMetrics
    m = ReadCondorMetrics(ws, totalCol)

    'Derivadas Condor
    Dim comPct As Variant
    If m.NEP <> 0# Then comPct = m.ComisionesMonto / m.NEP Else comPct = Empty

    Dim valorCliente As Variant
    If m.NEP <> 0# Then valorCliente = m.Claims / m.NEP Else valorCliente = Empty

    Dim siniestralidad As Variant
    Dim denomLR As Double
    denomLR = m.NEP - m.ComisionesMonto
    If denomLR <> 0# Then siniestralidad = m.Claims / denomLR Else siniestralidad = Empty

    Dim permanencia As Variant
    If m.Ventas <> 0# Then permanencia = m.Expuestos / m.Ventas Else permanencia = Empty

    Dim duracionMediaMeses As Variant
    duracionMediaMeses = permanencia  'misma definición por ahora

    Dim primaClienteNeta As Variant
    primaClienteNeta = CalcPrimaClienteNeta(m.GWP, m.Expuestos, m.Ventas, "")

    Dim ivaEfectivo As Variant
    Dim ivaRec As Variant
    If m.WrittenNetTax <> 0# Then
        ivaEfectivo = (m.GWP - m.WrittenNetTax) / m.WrittenNetTax
        ivaRec = 0.19 - CDbl(ivaEfectivo)
    Else
        ivaEfectivo = Empty
        ivaRec = Empty
    End If

    Dim gastosDirectosMonto As Double
    Dim gastosIndirectosMonto As Double
    gastosDirectosMonto = m.GastosDirectosMonto
    gastosIndirectosMonto = m.GastosIndirectosMonto

    Dim gastosDirectosPct As Variant
    Dim gastosIndirectosPct As Variant
    If m.NEP <> 0# Then
        gastosDirectosPct = gastosDirectosMonto / m.NEP
        gastosIndirectosPct = gastosIndirectosMonto / m.NEP
    Else
        gastosDirectosPct = Empty
        gastosIndirectosPct = Empty
    End If

    'Inputs consolidado: NO los tomamos del input por plan. Se dejan como TODO/Empty.
    Dim mesesVenta As Variant: mesesVenta = Empty
    Dim inflacionTxt As String: inflacionTxt = vbNullString
    Dim cutOffRunOffTxt As String: cutOffRunOffTxt = vbNullString
    Dim fechaCutOff As Variant: fechaCutOff = Empty
    Dim periodicidadTxt As String: periodicidadTxt = vbNullString
    Dim productTypeTxt As String: productTypeTxt = vbNullString

    'BP consolidado: SOLO vars "BP Mensual Consolidado"
    Dim reaseguroFlag As Variant
    Dim siniestroCedido As Variant
    Dim ratioAsistSobreNEP As Variant
    ReadBPConsolidadoVars bpFiles, reaseguroFlag, siniestroCedido, ratioAsistSobreNEP

    'Key y row/id
    Dim key As String
    key = UCase$(Trim$(p.CodigoTarifa)) & "|" & UCase$("Consolidado")

    Dim rowIndex As Long
    Dim idValue As Long
    If idx.Exists(key) Then
        Dim arr As Variant
        arr = idx(key)
        rowIndex = CLng(arr(0))
        idValue = CLng(arr(1))
    Else
        rowIndex = nextRow
        idValue = nextId
        nextRow = nextRow + 1
        nextId = nextId + 1
    End If

    'Escritura Base (Consolidado)
    WriteBaseCommon baseWS, headers, rowIndex, idValue, p, "Consolidado", True

    WriteByHeader baseWS, headers, rowIndex, "RUTA", NormalizeFolderPath(p.FilesFolder)

    'Output Condor
    WriteByHeader baseWS, headers, rowIndex, "VENTAS", m.Ventas
    WriteByHeader baseWS, headers, rowIndex, "GWP", m.GWP
    WriteByHeader baseWS, headers, rowIndex, "WRITTEN_PREMIUM_NET_TAX", m.WrittenNetTax
    WriteByHeader baseWS, headers, rowIndex, "NEP", m.NEP
    WriteByHeader baseWS, headers, rowIndex, "CARGA_SINIESTROS", m.Claims
    WriteByHeader baseWS, headers, rowIndex, "COMISIONES", comPct
    WriteByHeader baseWS, headers, rowIndex, "EXPUESTOS", m.Expuestos

    WriteByHeader baseWS, headers, rowIndex, "VALOR_CLIENTE", valorCliente
    WriteByHeader baseWS, headers, rowIndex, "SINIESTRALIDAD", siniestralidad

    WriteByHeader baseWS, headers, rowIndex, "PERMANENCIA", permanencia
    WriteByHeader baseWS, headers, rowIndex, "DURACION_MEDIA_MESES", duracionMediaMeses
    WriteByHeader baseWS, headers, rowIndex, "PRIMA_CLIENTE_NETA", primaClienteNeta

    WriteByHeader baseWS, headers, rowIndex, "IVA_EFECTIVO", ivaEfectivo
    WriteByHeader baseWS, headers, rowIndex, "IVA_RECUPERABLE", ivaRec

    WriteByHeader baseWS, headers, rowIndex, "GASTOS_DIRECTOS", gastosDirectosMonto
    WriteByHeader baseWS, headers, rowIndex, "GASTOS_INDIRECTOS", gastosIndirectosMonto
    WriteByHeader baseWS, headers, rowIndex, "GASTOS_DIRECTOS / NEP", gastosDirectosPct
    WriteByHeader baseWS, headers, rowIndex, "GASTOS_INDIRECTOS / NEP", gastosIndirectosPct

    WriteByHeader baseWS, headers, rowIndex, "FECHA_FIN_TARIFA", Date

    'Input Condor (consolidado) — pendiente/empty
    WriteByHeader baseWS, headers, rowIndex, "MESES DE VENTA", mesesVenta
    WriteByHeader baseWS, headers, rowIndex, "INFLACION", inflacionTxt
    WriteByHeader baseWS, headers, rowIndex, "CUT_OFF_RUN_OFF", cutOffRunOffTxt
    WriteByHeader baseWS, headers, rowIndex, "FECHA_CUT_OFF", fechaCutOff
    WriteByHeader baseWS, headers, rowIndex, "PERIODICIDAD", periodicidadTxt
    WriteByHeader baseWS, headers, rowIndex, "Product Type", productTypeTxt

    'BP Mensual Consolidado (solo estas)
    WriteByHeader baseWS, headers, rowIndex, "REASEGURO (SI/NO)", reaseguroFlag
    WriteByHeader baseWS, headers, rowIndex, "SINIESTRO_CEDIDO", siniestroCedido
    WriteByHeader baseWS, headers, rowIndex, "RATIO ASISTENCIA SOBRE LA NEP", ratioAsistSobreNEP

    'Pendiente explícito
    WriteByHeader baseWS, headers, rowIndex, "COMISION BRUTA SOBRE PRIMA BRUTA", TODO_TEXT

    seen.Add key, True

    UpsertConsolidado = idValue
End Function

'===========================================================
' Upsert Planes: recorre A,B,C (orden del input), lee Condor output hoja plan y BP Parametros
'===========================================================
Private Sub UpsertPlanes(ByVal baseWS As Worksheet, ByVal headers As Object, _
                         ByVal idx As Object, ByVal seen As Object, _
                         ByRef nextRow As Long, ByRef nextId As Long, _
                         ByRef p As tExportParams, ByVal outWB As Workbook, _
                         ByVal planInputs As Object, ByVal planOrder As Collection, _
                         ByVal bpFiles As Variant, ByVal polizaId As Long)

    Dim i As Long
    For i = 1 To planOrder.Count
        Dim planName As String
        planName = CStr(planOrder(i))

        If Not WorksheetExists(outWB, planName) Then
            Err.Raise vbObjectError + 7501, "UpsertPlanes", "No existe hoja de plan '" & planName & "' en " & outWB.Name
        End If

        Dim ws As Worksheet
        Set ws = outWB.Worksheets(planName)

        Dim totalCol As Long
        totalCol = FindTotalCol(ws, CONDOR_TOTAL_HEADER_ROW, CONDOR_MIN_DATA_COL)

        Dim m As tMetrics
        m = ReadCondorMetrics(ws, totalCol)

        'Inputs desde Condor input (por plan)
        Dim d As Object
        Set d = planInputs(planName)

        Dim mesesVenta As Variant: mesesVenta = d("meses_venta")
        Dim inflacionTxt As String: inflacionTxt = CStr(d("inflacion"))
        Dim cutOffRunOffTxt As String: cutOffRunOffTxt = CStr(d("cut_off_run_off"))
        Dim fechaCutOff As Variant: fechaCutOff = d("fecha_cut_off")
        Dim periodicidadTxt As String: periodicidadTxt = CStr(d("periodicidad"))
        Dim productTypeTxt As String: productTypeTxt = CStr(d("product_type"))

        'Derivadas Condor
        Dim comPct As Variant
        If m.NEP <> 0# Then comPct = m.ComisionesMonto / m.NEP Else comPct = Empty

        Dim valorCliente As Variant
        If m.NEP <> 0# Then valorCliente = m.Claims / m.NEP Else valorCliente = Empty

        Dim siniestralidad As Variant
        Dim denomLR As Double
        denomLR = m.NEP - m.ComisionesMonto
        If denomLR <> 0# Then siniestralidad = m.Claims / denomLR Else siniestralidad = Empty

        Dim permanencia As Variant
        If m.Ventas <> 0# Then permanencia = m.Expuestos / m.Ventas Else permanencia = Empty

        Dim duracionMediaMeses As Variant
        duracionMediaMeses = CalcDuracionMedia(m.Expuestos, m.Ventas, periodicidadTxt)

        Dim primaClienteNeta As Variant
        primaClienteNeta = CalcPrimaClienteNeta(m.GWP, m.Expuestos, m.Ventas, periodicidadTxt)

        Dim ivaEfectivo As Variant
        Dim ivaRec As Variant
        If m.WrittenNetTax <> 0# Then
            ivaEfectivo = (m.GWP - m.WrittenNetTax) / m.WrittenNetTax
            ivaRec = 0.19 - CDbl(ivaEfectivo)
        Else
            ivaEfectivo = Empty
            ivaRec = Empty
        End If

        Dim gastosDirectosMonto As Double
        Dim gastosIndirectosMonto As Double
        gastosDirectosMonto = m.GastosDirectosMonto
        gastosIndirectosMonto = m.GastosIndirectosMonto

        Dim gastosDirectosPct As Variant
        Dim gastosIndirectosPct As Variant
        If m.NEP <> 0# Then
            gastosDirectosPct = gastosDirectosMonto / m.NEP
            gastosIndirectosPct = gastosIndirectosMonto / m.NEP
        Else
            gastosDirectosPct = Empty
            gastosIndirectosPct = Empty
        End If

        'BP por plan: Parametros (conversión UF->CLP)
        Dim asistMensualCLP As Variant
        Dim asistVentaCLP As Variant
        Dim costosMensualesCLP As Variant
        Dim costosVentaCLP As Variant
        Dim mesesCarencia As Variant
        Dim capitalAsegCLP As Variant
        Dim sinMedioRiesgoCLP As Variant
        Dim tasaEntradaRiesgo As Variant

        ReadBPPlanParametros bpFiles, planName, _
            asistMensualCLP, asistVentaCLP, costosMensualesCLP, costosVentaCLP, _
            mesesCarencia, capitalAsegCLP, sinMedioRiesgoCLP, tasaEntradaRiesgo

        'Key y row/id
        Dim key As String
        key = UCase$(Trim$(p.CodigoTarifa)) & "|" & UCase$(Trim$(planName))

        Dim rowIndex As Long
        Dim idValue As Long
        If idx.Exists(key) Then
            Dim arr As Variant
            arr = idx(key)
            rowIndex = CLng(arr(0))
            idValue = CLng(arr(1))
        Else
            rowIndex = nextRow
            idValue = nextId
            nextRow = nextRow + 1
            nextId = nextId + 1
        End If

        'Escritura Base (Plan)
        WriteBaseCommon baseWS, headers, rowIndex, idValue, p, planName, False

        WriteByHeader baseWS, headers, rowIndex, "RUTA", NormalizeFolderPath(p.FilesFolder)

        'Input Condor
        WriteByHeader baseWS, headers, rowIndex, "MESES DE VENTA", mesesVenta
        WriteByHeader baseWS, headers, rowIndex, "INFLACION", inflacionTxt
        WriteByHeader baseWS, headers, rowIndex, "CUT_OFF_RUN_OFF", cutOffRunOffTxt
        WriteByHeader baseWS, headers, rowIndex, "FECHA_CUT_OFF", fechaCutOff
        WriteByHeader baseWS, headers, rowIndex, "PERIODICIDAD", periodicidadTxt
        WriteByHeader baseWS, headers, rowIndex, "Product Type", productTypeTxt

        'Output Condor
        WriteByHeader baseWS, headers, rowIndex, "VENTAS", m.Ventas
        WriteByHeader baseWS, headers, rowIndex, "GWP", m.GWP
        WriteByHeader baseWS, headers, rowIndex, "WRITTEN_PREMIUM_NET_TAX", m.WrittenNetTax
        WriteByHeader baseWS, headers, rowIndex, "NEP", m.NEP
        WriteByHeader baseWS, headers, rowIndex, "CARGA SINIESTROS", m.Claims
        WriteByHeader baseWS, headers, rowIndex, "COMISIONES", comPct
        WriteByHeader baseWS, headers, rowIndex, "EXPUESTOS", m.Expuestos

        WriteByHeader baseWS, headers, rowIndex, "VALOR_CLIENTE", valorCliente
        WriteByHeader baseWS, headers, rowIndex, "SINIESTRALIDAD", siniestralidad

        WriteByHeader baseWS, headers, rowIndex, "PERMANENCIA", permanencia
        WriteByHeader baseWS, headers, rowIndex, "DURACION_MEDIA_MESES", duracionMediaMeses
        WriteByHeader baseWS, headers, rowIndex, "PRIMA_CLIENTE_NETA", primaClienteNeta

        WriteByHeader baseWS, headers, rowIndex, "IVA EFECTIVO", ivaEfectivo
        WriteByHeader baseWS, headers, rowIndex, "IVA RECUPERABLE", ivaRec

        WriteByHeader baseWS, headers, rowIndex, "GASTOS_DIRECTOS", gastosDirectosMonto
        WriteByHeader baseWS, headers, rowIndex, "GASTOS_INDIRECTOS", gastosIndirectosMonto
        WriteByHeader baseWS, headers, rowIndex, "GASTOS DIRECTOS / NEP", gastosDirectosPct
        WriteByHeader baseWS, headers, rowIndex, "GASTOS INDIRECTOS / NEP", gastosIndirectosPct

        WriteByHeader baseWS, headers, rowIndex, "FECHA_FIN_TARIFA", Date

        'Parámetros (por plan)
        WriteByHeader baseWS, headers, rowIndex, "ASISTENCIA_MENSUAL", asistMensualCLP
        WriteByHeader baseWS, headers, rowIndex, "ASISTENCIA_VENTA", asistVentaCLP
        WriteByHeader baseWS, headers, rowIndex, "COSTOS_MENSUALES", costosMensualesCLP
        WriteByHeader baseWS, headers, rowIndex, "COSTOS_VENTA", costosVentaCLP
        WriteByHeader baseWS, headers, rowIndex, "CAPITAL ASEGURADO", capitalAsegCLP
        WriteByHeader baseWS, headers, rowIndex, "SINIESTRO MEDIO POR RIESGO", sinMedioRiesgoCLP
        WriteByHeader baseWS, headers, rowIndex, "TASA DE ENTRADA POR RIESGO", tasaEntradaRiesgo
        WriteByHeader baseWS, headers, rowIndex, "MESES DE CARENCIA", mesesCarencia

        'Pendiente explícito
        WriteByHeader baseWS, headers, rowIndex, "COMISION BRUTA SOBRE PRIMA BRUTA", TODO_TEXT

        seen.Add key, True
    Next i
End Sub

'===========================================================
' Tasa caída + permanencias (una sola vez por póliza)
'===========================================================
Private Sub UpsertRatesAndPermanenciaOnce(ByVal permWS As Worksheet, ByVal permHeaders As Object, _
                                         ByVal tasaWS As Worksheet, ByVal tasaHeaders As Object, _
                                         ByVal polizaId As Long, ByVal planInputs As Object, ByVal planOrder As Collection)

    If planOrder.Count = 0 Then Exit Sub

    Dim firstPlan As String
    firstPlan = CStr(planOrder(1))

    Dim d As Object
    Set d = planInputs(firstPlan)

    Dim tasa() As Double
    tasa = d("tasa")

    Dim permanencias(1 To IN_TASA_MONTHS) As Double
    CalcPermanenciasFromTasaCaida tasa, permanencias

    'Periodicidad del primer plan (proxy)
    Dim periodicidadTxt As String
    periodicidadTxt = CStr(d("periodicidad"))

    UpsertTasaCaida tasaWS, tasaHeaders, polizaId, tasa
    UpsertPermanencia permWS, permHeaders, polizaId, permanencias, periodicidadTxt
End Sub

'===========================================================
' Marcar eliminados (excepto "Consolidado")
'===========================================================
Private Sub MarkDeletedPlans(ByVal baseWS As Worksheet, ByVal headers As Object, ByVal idx As Object, ByVal seen As Object)
    Dim k As Variant
    For Each k In idx.Keys
        If Not seen.Exists(CStr(k)) Then
            Dim arr As Variant
            arr = idx(CStr(k))

            Dim rowDel As Long
            Dim planDel As String
            rowDel = CLng(arr(0))
            planDel = Trim$(CStr(arr(2)))

            If StrComp(planDel, "Consolidado", vbTextCompare) <> 0 Then
                WriteByHeader baseWS, headers, rowDel, "ESTADO_PLAN", "Eliminado"
                WriteByHeader baseWS, headers, rowDel, "FECHA_ESTADO_PLAN", Date
            End If
        End If
    Next k
End Sub

'===========================================================
' Escritura común de Base (campos manuales/formulario)
'===========================================================
Private Sub WriteBaseCommon(ByVal baseWS As Worksheet, ByVal headers As Object, _
                            ByVal rowIndex As Long, ByVal idValue As Long, _
                            ByRef p As tExportParams, ByVal planLabel As String, ByVal isConsolidado As Boolean)

    WriteByHeader baseWS, headers, rowIndex, "ID_INTERNO", idValue
    WriteByHeader baseWS, headers, rowIndex, "CODIGO_TARIFA", p.CodigoTarifa
    WriteByHeader baseWS, headers, rowIndex, "PLAN", planLabel

    WriteByHeader baseWS, headers, rowIndex, "ID_BIZAGI", p.IdBizagi
    WriteByHeader baseWS, headers, rowIndex, "POLIZA", p.Poliza
    WriteByHeader baseWS, headers, rowIndex, "SOCIO", p.Socio

    WriteByHeader baseWS, headers, rowIndex, "VALIDACION_TERRITORIAL", p.ValidTerr
    WriteByHeader baseWS, headers, rowIndex, "VALIDACION_TECNICA", p.ValidTec
    WriteByHeader baseWS, headers, rowIndex, "VALIDACION_VALOR_CLIENTE", p.ValidVC

    WriteByHeader baseWS, headers, rowIndex, "CUOTAS_PROMEDIO", p.CuotasPromedio
    WriteByHeader baseWS, headers, rowIndex, "OTROS_COSTOS_DIRECTOS_FIJOS", p.OtrosCostosDirectosFijos
    WriteByHeader baseWS, headers, rowIndex, "PROFIT SHARING (SI/NO)", p.ProfitSharing
    WriteByHeader baseWS, headers, rowIndex, "PRIMA_CEDIDA", p.PrimaCedida
    WriteByHeader baseWS, headers, rowIndex, "FORMULA_SINIESTRALIDAD_APLICA (SI/NO)", p.FormulaSiniestralidadAplica
    WriteByHeader baseWS, headers, rowIndex, "BRIM", p.Brim
    WriteByHeader baseWS, headers, rowIndex, "OBSERVACIÓN", p.Observacion
    WriteByHeader baseWS, headers, rowIndex, "PLAN DE ACCIÓN", p.PlanAccion

    WriteByHeader baseWS, headers, rowIndex, "PRODUCTO CUENTA CON ASISTENCIA (SI/NO)", p.ProductoCuentaAsistencia
    WriteByHeader baseWS, headers, rowIndex, "%DE DESCUENTO ASISTENCIA", p.DescuentoAsistenciaPct

    WriteByHeader baseWS, headers, rowIndex, "TIENE ECOSISTEMA (SI/NO)", p.TieneEcosistema
    WriteByHeader baseWS, headers, rowIndex, "CANAL TMK (SI/NO)", p.CanalTMK

    WriteByHeader baseWS, headers, rowIndex, "ROP (SI/NO)", p.ROP
    WriteByHeader baseWS, headers, rowIndex, "BONIFICACION ROP %", p.BonificacionROPPct

    WriteByHeader baseWS, headers, rowIndex, "VENTA POR PLANES (SI/NO)", p.VentaPorPlanes
    WriteByHeader baseWS, headers, rowIndex, "SI LA TARIFA TIENE MODIFICACIONES", p.TarifaTieneModificaciones
    WriteByHeader baseWS, headers, rowIndex, "POLIZA ES CONTINUACION (SI/NO)", p.PolizaEsContinuacion

    If Not isConsolidado Then
        WriteByHeader baseWS, headers, rowIndex, "ESTADO_PLAN", "Vigente"
        WriteByHeader baseWS, headers, rowIndex, "FECHA_ESTADO_PLAN", Date
    End If
End Sub

'===========================================================
' Lectura de métricas desde Condor Output (consolidado o plan)
'===========================================================
Private Type tMetrics
    Ventas As Double
    GWP As Double
    WrittenNetTax As Double
    Devoluciones As Double
    NEP As Double
    ComisionesMonto As Double
    Claims As Double
    Expuestos As Double
    GastosDirectosMonto As Double
    GastosIndirectosMonto As Double
End Type

Private Function ReadCondorMetrics(ByVal ws As Worksheet, ByVal totalCol As Long) As tMetrics
    Dim m As tMetrics

    m.Ventas = CDbl(ValSafe(ws.Cells(ROW_VENTAS, totalCol).Value2))
    m.GWP = CDbl(ValSafe(ws.Cells(ROW_GWP, totalCol).Value2))
    m.WrittenNetTax = CDbl(ValSafe(ws.Cells(ROW_WRITTEN_NET_TAX, totalCol).Value2))
    m.Devoluciones = CDbl(ValSafe(ws.Cells(ROW_DEVOLUCIONES, totalCol).Value2))
    m.NEP = CDbl(ValSafe(ws.Cells(ROW_NEP, totalCol).Value2))
    m.ComisionesMonto = CDbl(ValSafe(ws.Cells(ROW_COMISIONES_MONTO, totalCol).Value2))
    m.Claims = CDbl(ValSafe(ws.Cells(ROW_CLAIMS, totalCol).Value2))

    'Expuestos: sumar fila 288 desde C hasta última celda no vacía (incluye ColTotal)
    m.Expuestos = SumRowFromCToLastNonEmpty(ws, ROW_EXPUESTOS)

    'Gastos directos / indirectos: filas 191+192 y 196+197 (monto)
    m.GastosDirectosMonto = CDbl(ValSafe(ws.Cells(191, totalCol).Value2)) + CDbl(ValSafe(ws.Cells(192, totalCol).Value2))
    m.GastosIndirectosMonto = CDbl(ValSafe(ws.Cells(196, totalCol).Value2)) + CDbl(ValSafe(ws.Cells(197, totalCol).Value2))

    ReadCondorMetrics = m
End Function

Private Function SumRowFromCToLastNonEmpty(ByVal ws As Worksheet, ByVal rowNum As Long) As Double
    Dim lastCol As Long
    lastCol = ws.Cells(rowNum, ws.Columns.Count).End(xlToLeft).Column
    If lastCol < CONDOR_MIN_DATA_COL Then lastCol = CONDOR_MIN_DATA_COL

    Dim c As Long, v As Variant, acc As Double
    acc = 0#
    For c = CONDOR_MIN_DATA_COL To lastCol
        v = ws.Cells(rowNum, c).Value2
        If IsNumeric(v) Then acc = acc + CDbl(v)
    Next c
    SumRowFromCToLastNonEmpty = acc
End Function

'===========================================================
' Cálculos derivados
'===========================================================
Private Function CalcDuracionMedia(ByVal expuestos As Double, ByVal ventas As Double, ByVal periodicidadTxt As String) As Variant
    If ventas = 0# Then
        CalcDuracionMedia = Empty
        Exit Function
    End If

    'Mensual: permanencia promedio = expuestos / ventas
    'Prima única: duracion = expuestos / ventas (misma fórmula por ahora)
    CalcDuracionMedia = expuestos / ventas
End Function

Private Function CalcPrimaClienteNeta(ByVal gwp As Double, ByVal expuestos As Double, ByVal ventas As Double, ByVal periodicidadTxt As String) As Variant
    Dim s As String
    s = LCase$(Trim$(periodicidadTxt))

    If Len(s) = 0 Then
        CalcPrimaClienteNeta = Empty
        Exit Function
    End If

    If InStr(1, s, "mens", vbTextCompare) > 0 Or InStr(1, s, "month", vbTextCompare) > 0 Then
        If expuestos <> 0# Then
            CalcPrimaClienteNeta = gwp / expuestos
        Else
            CalcPrimaClienteNeta = Empty
        End If
        Exit Function
    End If

    If InStr(1, s, "unic", vbTextCompare) > 0 Or InStr(1, s, "single", vbTextCompare) > 0 Then
        If ventas <> 0# Then
            CalcPrimaClienteNeta = gwp / ventas
        Else
            CalcPrimaClienteNeta = Empty
        End If
        Exit Function
    End If

    'Si aparece otro tipo de periodicidad, queda pendiente explícito
    CalcPrimaClienteNeta = TODO_TEXT
End Function

'===========================================================
' BP consolidado: SOLO vars "BP Mensual Consolidado"
'===========================================================
Private Sub ReadBPConsolidadoVars(ByVal files As Variant, _
                                 ByRef reaseguroFlag As Variant, ByRef siniestroCedido As Variant, ByRef ratioAsistSobreNEP As Variant)

    Dim consPath As String
    consPath = FS_FindBestFileByTokenFiltered(files, "consolidado", True)

    If Len(consPath) = 0 Then
        'Si no existe, lo dejamos como TODO (texto)
        reaseguroFlag = TODO_TEXT
        siniestroCedido = TODO_TEXT
        ratioAsistSobreNEP = TODO_TEXT
        Exit Sub
    End If

    Dim wb As Workbook
    Set wb = Workbooks.Open(Filename:=consPath, UpdateLinks:=0, ReadOnly:=True, AddToMru:=False)

    If Not WorksheetExists(wb, BP_MENSUAL_SHEET) Then
        wb.Close SaveChanges:=False
        reaseguroFlag = TODO_TEXT
        siniestroCedido = TODO_TEXT
        ratioAsistSobreNEP = TODO_TEXT
        Exit Sub
    End If

    Dim ws As Worksheet
    Set ws = wb.Worksheets(BP_MENSUAL_SHEET)

    Dim vRea As Double
    vRea = CDbl(ValSafe(ws.Range(BP_CONS_REASEGURO_CELL).Value2))
    If vRea > 0# Then reaseguroFlag = "SI" Else reaseguroFlag = "NO"

    siniestroCedido = ws.Range(BP_CONS_SINIESTRO_CEDIDO_CELL).Value2

    Dim vAsist As Double
    Dim vNep As Double
    vAsist = CDbl(ValSafe(ws.Range(BP_CONS_ASIST_CELL).Value2))
    vNep = CDbl(ValSafe(ws.Range(BP_CONS_NEP_CELL).Value2))
    If vNep <> 0# Then ratioAsistSobreNEP = vAsist / vNep Else ratioAsistSobreNEP = Empty

    wb.Close SaveChanges:=False
End Sub

'===========================================================
' BP por plan: Parametros (I53, M52, C8, C29:C43, D29:D43, E29:E43) + UF para CLP
'
' Nota:
' - ASISTENCIA_VENTA queda como TODO (pendiente ubicación)
' - Se convierte UF -> CLP multiplicando por UF_CLP (leído por label "UF").
' - Rangos por riesgo se guardan como texto "v1;v2;...;vN" (CLP para capital/siniestro medio, % para tasa entrada)
'   TODO: si el repositorio define otra estructura para estas listas, se ajusta acá.
'===========================================================
Private Sub ReadBPPlanParametros(ByVal files As Variant, ByVal planName As String, _
                                ByRef asistMensualCLP As Variant, ByRef asistVentaCLP As Variant, _
                                ByRef costosMensualesCLP As Variant, ByRef costosVentaCLP As Variant, _
                                ByRef mesesCarencia As Variant, _
                                ByRef capitalAsegCLP As Variant, ByRef sinMedioRiesgoCLP As Variant, ByRef tasaEntradaRiesgo As Variant)

    Dim planPath As String
    planPath = FS_FindBestFileByTokenFiltered(files, planName, False)

    If Len(planPath) = 0 Then
        asistMensualCLP = TODO_TEXT
        asistVentaCLP = TODO_TEXT
        costosMensualesCLP = TODO_TEXT
        costosVentaCLP = TODO_TEXT
        mesesCarencia = TODO_TEXT
        capitalAsegCLP = TODO_TEXT
        sinMedioRiesgoCLP = TODO_TEXT
        tasaEntradaRiesgo = TODO_TEXT
        Exit Sub
    End If

    Dim wb As Workbook
    Set wb = Workbooks.Open(Filename:=planPath, UpdateLinks:=0, ReadOnly:=True, AddToMru:=False)

    If Not WorksheetExists(wb, BP_PARAMS_SHEET) Then
        wb.Close SaveChanges:=False
        asistMensualCLP = TODO_TEXT
        asistVentaCLP = TODO_TEXT
        costosMensualesCLP = TODO_TEXT
        costosVentaCLP = TODO_TEXT
        mesesCarencia = TODO_TEXT
        capitalAsegCLP = TODO_TEXT
        sinMedioRiesgoCLP = TODO_TEXT
        tasaEntradaRiesgo = TODO_TEXT
        Exit Sub
    End If

    Dim ws As Worksheet
    Set ws = wb.Worksheets(BP_PARAMS_SHEET)

    Dim ufCLP As Variant
    ufCLP = ReadUF_CLP_FromParametros(ws)

    'Asistencia mensual (I53). Se asume UF si UF_CLP existe, si no queda TODO.
    Dim vI53 As Variant
    vI53 = ws.Range(BP_PARAMS_ASIST_MENSUAL).Value2

    If IsNumeric(ufCLP) Then
        asistMensualCLP = CDbl(ValSafe(vI53)) * CDbl(ufCLP)
    Else
        asistMensualCLP = TODO_TEXT
    End If

    'Asistencia venta: pendiente ubicación
    asistVentaCLP = TODO_TEXT

    'Costo venta (M52) -> CLP
    Dim vM52 As Variant
    vM52 = ws.Range(BP_PARAMS_COSTO_VENTA).Value2
    If IsNumeric(ufCLP) Then
        costosVentaCLP = CDbl(ValSafe(vM52)) * CDbl(ufCLP)
    Else
        costosVentaCLP = TODO_TEXT
    End If

    'Costos mensuales: (I53 + F55 + BTG) -> CLP
    'TODO: si tu BP tiene BTG en otras celdas o ya está en CLP, ajustar.
    If IsNumeric(ufCLP) Then
        Dim costoRecaudF55 As Double
        costoRecaudF55 = CDbl(ValSafe(ws.Range("F55").Value2))

        Dim primaNetaC6 As Double
        primaNetaC6 = CDbl(ValSafe(ws.Range("C6").Value2))

        Dim pctBTG_C14 As Double
        pctBTG_C14 = CDbl(ValSafe(ws.Range("C14").Value2))

        Dim btgUF As Double
        btgUF = primaNetaC6 * pctBTG_C14

        Dim totalUF As Double
        totalUF = CDbl(ValSafe(vI53)) + costoRecaudF55 + btgUF

        costosMensualesCLP = totalUF * CDbl(ufCLP)
    Else
        costosMensualesCLP = TODO_TEXT
    End If

    'Meses carencia (C8)
    mesesCarencia = ws.Range(BP_PARAMS_MESES_CARENCIA).Value2

    'Capital asegurado (C29:C43) -> CLP lista
    If IsNumeric(ufCLP) Then
        capitalAsegCLP = RangeToSemicolonList_CLP(ws.Range(BP_PARAMS_CAPITAL_ASEG_RNG), CDbl(ufCLP))
        sinMedioRiesgoCLP = RangeToSemicolonList_CLP(ws.Range(BP_PARAMS_SIN_MEDIO_RNG), CDbl(ufCLP))
    Else
        capitalAsegCLP = TODO_TEXT
        sinMedioRiesgoCLP = TODO_TEXT
    End If

    'Tasa entrada por riesgo (E29:E43) -> lista (se guarda como texto tal cual)
    tasaEntradaRiesgo = RangeToSemicolonList_RAW(ws.Range(BP_PARAMS_TASA_ENTR_RNG))

    wb.Close SaveChanges:=False
End Sub

Private Function ReadUF_CLP_FromParametros(ByVal wsParametros As Worksheet) As Variant
    Dim lastRow As Long
    lastRow = wsParametros.Cells(wsParametros.Rows.Count, BP_UF_SEARCH_COL).End(xlUp).Row
    If lastRow < 1 Then
        ReadUF_CLP_FromParametros = Empty
        Exit Function
    End If

    Dim r As Long
    For r = 1 To lastRow
        Dim label As String
        label = Trim$(CStr(wsParametros.Cells(r, BP_UF_SEARCH_COL).Value2))
        If StrComp(label, BP_UF_LABEL, vbTextCompare) = 0 Then
            Dim v As Variant
            v = wsParametros.Cells(r, BP_UF_SEARCH_COL + BP_UF_VALUE_OFFSET).Value2
            If IsNumeric(v) Then
                ReadUF_CLP_FromParametros = CDbl(v)
            Else
                ReadUF_CLP_FromParametros = Empty
            End If
            Exit Function
        End If
    Next r

    ReadUF_CLP_FromParametros = Empty
End Function

Private Function RangeToSemicolonList_CLP(ByVal rng As Range, ByVal ufCLP As Double) As String
    Dim arr As Variant
    arr = rng.Value2

    Dim r As Long, s As String, v As Variant
    For r = 1 To UBound(arr, 1)
        v = arr(r, 1)
        If IsNumeric(v) Then
            If Len(s) > 0 Then s = s & ";"
            s = s & CStr(CDbl(v) * ufCLP)
        Else
            If Len(s) > 0 Then s = s & ";"
            s = s & ""
        End If
    Next r

    RangeToSemicolonList_CLP = s
End Function

Private Function RangeToSemicolonList_RAW(ByVal rng As Range) As String
    Dim arr As Variant
    arr = rng.Value2

    Dim r As Long, s As String, v As Variant
    For r = 1 To UBound(arr, 1)
        v = arr(r, 1)
        If Len(s) > 0 Then s = s & ";"
        s = s & Trim$(CStr(v))
    Next r

    RangeToSemicolonList_RAW = s
End Function

'===========================================================
' Permanencias desde tasa de caída
'===========================================================
Private Sub CalcPermanenciasFromTasaCaida(ByRef tasa() As Double, ByRef permanencias() As Double)
    Dim m As Long, pp As Double
    pp = 1#
    For m = 1 To IN_TASA_MONTHS
        pp = pp * (1# - CDbl(tasa(m)))
        permanencias(m) = pp
    Next m
End Sub

'===========================================================
' Upsert Tasa_Caida / Permanencia (por ID_INTERNO = polizaId)
'===========================================================
Private Sub UpsertTasaCaida(ByVal tasaWS As Worksheet, ByVal headers As Object, ByVal polizaId As Long, ByRef tasa() As Double)
    DeleteRowsById tasaWS, headers, "ID_INTERNO", polizaId, 2

    Dim startRow As Long, outRow As Long, i As Long
    startRow = NextFreeRow(tasaWS, CLng(headers("ID_INTERNO")), 2)
    outRow = startRow

    For i = 1 To IN_TASA_MONTHS
        WriteByHeader tasaWS, headers, outRow, "ID_INTERNO", polizaId
        WriteByHeader tasaWS, headers, outRow, "PERIODO", i
        WriteByHeader tasaWS, headers, outRow, "TRAMO", Empty
        WriteByHeader tasaWS, headers, outRow, "TASA", tasa(i)
        outRow = outRow + 1
    Next i
End Sub

Private Sub UpsertPermanencia(ByVal permWS As Worksheet, ByVal headers As Object, ByVal polizaId As Long, ByRef permanencias() As Double, ByVal periodicidadTxt As String)
    DeleteRowsById permWS, headers, "ID_INTERNO", polizaId, 2

    Dim isMensual As Boolean
    isMensual = IsMensualText(periodicidadTxt)

    Dim startRow As Long, outRow As Long, i As Long
    startRow = NextFreeRow(permWS, CLng(headers("ID_INTERNO")), 2)
    outRow = startRow

    For i = 1 To IN_TASA_MONTHS
        WriteByHeader permWS, headers, outRow, "ID_INTERNO", polizaId
        WriteByHeader permWS, headers, outRow, "MES", i

        If isMensual Then
            WriteByHeader permWS, headers, outRow, "VALOR", permanencias(i)
            WriteByHeader permWS, headers, outRow, "TIPO", "PERMANENCIA"
        Else
            'Pendiente para otras periodicidades
            WriteByHeader permWS, headers, outRow, "VALOR", Empty
            WriteByHeader permWS, headers, outRow, "TIPO", TODO_TEXT
        End If

        outRow = outRow + 1
    Next i
End Sub

Private Function IsMensualText(ByVal periodicidadTxt As String) As Boolean
    Dim s As String
    s = LCase$(Trim$(periodicidadTxt))
    IsMensualText = (InStr(1, s, "mens", vbTextCompare) > 0 Or InStr(1, s, "month", vbTextCompare) > 0)
End Function

Private Sub DeleteRowsById(ByVal ws As Worksheet, ByVal headers As Object, ByVal idHeaderName As String, ByVal idValue As Long, ByVal startRow As Long)
    If Not headers.Exists(idHeaderName) Then Exit Sub

    Dim idCol As Long, lastRow As Long, r As Long, vv As Variant
    idCol = CLng(headers(idHeaderName))
    lastRow = ws.Cells(ws.Rows.Count, idCol).End(xlUp).Row
    If lastRow < startRow Then Exit Sub

    For r = lastRow To startRow Step -1
        vv = ws.Cells(r, idCol).Value2
        If IsNumeric(vv) Then
            If CLng(vv) = idValue Then ws.Rows(r).Delete
        End If
    Next r
End Sub

'===========================================================
' Files: listar / match (solo BPs)
' - Excluye repo y condor input/output por path exacto
' - Además filtra nombres de Condor (BPInputTemplate / Results_BPInputTemplate) para evitar falsos positivos
'===========================================================
Private Function FS_ListExcelFilesInFolder(ByVal folderPath As String, ByVal excludeRepo As String, ByVal excludeCondorIn As String, ByVal excludeCondorOut As String) As Variant
    Dim f As String, full As String
    Dim col As Collection: Set col = New Collection

    If Right$(folderPath, 1) <> "\" Then folderPath = folderPath & "\"

    f = Dir(folderPath & "*.xls*")
    Do While Len(f) > 0
        If Left$(f, 2) <> "~$" Then
            full = folderPath & f

            If StrComp(full, excludeRepo, vbTextCompare) <> 0 _
                And StrComp(full, excludeCondorIn, vbTextCompare) <> 0 _
                And StrComp(full, excludeCondorOut, vbTextCompare) <> 0 Then

                Dim fn As String
                fn = LCase$(f)

                'Filtrar archivos de condor por prefijo
                If Left$(fn, Len("bpinputtemplate")) <> "bpinputtemplate" Then
                    If Left$(fn, Len("results_bpinputtemplate")) <> "results_bpinputtemplate" Then
                        col.Add full
                    End If
                End If
            End If
        End If
        f = Dir()
    Loop

    If col.Count = 0 Then Exit Function

    Dim arr() As String, i As Long
    ReDim arr(0 To col.Count - 1)
    For i = 1 To col.Count
        arr(i - 1) = CStr(col(i))
    Next i

    FS_ListExcelFilesInFolder = arr
End Function

Private Sub FS_SortFilesNatural(ByRef files As Variant)
    If IsEmpty(files) Then Exit Sub
    FS_QuickSortNatural files, LBound(files), UBound(files)
End Sub

Private Sub FS_QuickSortNatural(ByRef arr As Variant, ByVal lo As Long, ByVal hi As Long)
    Dim i As Long, j As Long
    Dim pivot As String, tmp As String

    i = lo: j = hi
    pivot = arr((lo + hi) \ 2)

    Do While i <= j
        Do While FS_NaturalCompare(arr(i), pivot) < 0
            i = i + 1
        Loop
        Do While FS_NaturalCompare(arr(j), pivot) > 0
            j = j - 1
        Loop

        If i <= j Then
            tmp = arr(i): arr(i) = arr(j): arr(j) = tmp
            i = i + 1: j = j - 1
        End If
    Loop

    If lo < j Then FS_QuickSortNatural arr, lo, j
    If i < hi Then FS_QuickSortNatural arr, i, hi
End Sub

Private Function FS_NaturalCompare(ByVal a As String, ByVal b As String) As Long
    Dim i As Long, j As Long
    Dim ca As String, cb As String
    Dim na As String, nb As String

    a = LCase$(GetFileFromFullName(a))
    b = LCase$(GetFileFromFullName(b))

    i = 1: j = 1
    Do While i <= Len(a) And j <= Len(b)
        ca = Mid$(a, i, 1)
        cb = Mid$(b, j, 1)

        If FS_IsDigit(ca) And FS_IsDigit(cb) Then
            na = FS_ReadNumber(a, i)
            nb = FS_ReadNumber(b, j)

            If CLng(na) <> CLng(nb) Then
                FS_NaturalCompare = Sgn(CLng(na) - CLng(nb))
                Exit Function
            End If
        Else
            If ca <> cb Then
                FS_NaturalCompare = Sgn(StrComp(ca, cb, vbTextCompare))
                Exit Function
            End If
            i = i + 1
            j = j + 1
        End If
    Loop

    FS_NaturalCompare = Sgn(Len(a) - Len(b))
End Function

Private Function FS_IsDigit(ByVal ch As String) As Boolean
    FS_IsDigit = (ch >= "0" And ch <= "9")
End Function

Private Function FS_ReadNumber(ByVal s As String, ByRef idx As Long) As String
    Dim startPos As Long
    startPos = idx
    Do While idx <= Len(s) And FS_IsDigit(Mid$(s, idx, 1))
        idx = idx + 1
    Loop
    FS_ReadNumber = Mid$(s, startPos, idx - startPos)
End Function

'Match por contención (case-insensitive), con score por largo de filename.
'filterConsolidado = True: prioriza que contenga "consolidado"
Private Function FS_FindBestFileByTokenFiltered(ByVal files As Variant, ByVal token As String, ByVal filterConsolidado As Boolean) As String
    Dim best As String
    Dim bestScore As Long
    Dim i As Long, fn As String
    Dim t As String

    t = LCase$(Trim$(token))
    If Len(t) = 0 Then Exit Function

    bestScore = 2147483647

    For i = LBound(files) To UBound(files)
        fn = LCase$(GetFileFromFullName(CStr(files(i))))

        If filterConsolidado Then
            If InStr(1, fn, "consolidado", vbTextCompare) = 0 Then GoTo NextI
        End If

        If InStr(1, fn, t, vbTextCompare) > 0 Then
            Dim score As Long
            score = Len(fn)
            If score < bestScore Then
                bestScore = score
                best = CStr(files(i))
            End If
        End If
NextI:
    Next i

    FS_FindBestFileByTokenFiltered = best
End Function

'===========================================================
' Helpers básicos
'===========================================================
Private Function ParseSemicolonList(ByVal rawText As String) As Collection
    Dim col As Collection: Set col = New Collection
    Dim seen As Object: Set seen = CreateObject("Scripting.Dictionary")
    seen.CompareMode = vbTextCompare

    rawText = Trim$(rawText)
    If Len(rawText) = 0 Then
        Set ParseSemicolonList = col
        Exit Function
    End If

    Dim parts As Variant, i As Long, s As String
    parts = Split(rawText, ";")
    For i = LBound(parts) To UBound(parts)
        s = Trim$(CStr(parts(i)))
        If Len(s) > 0 Then
            If Not seen.Exists(UCase$(s)) Then
                col.Add s
                seen.Add UCase$(s), True
            End If
        End If
    Next i

    Set ParseSemicolonList = col
End Function

Private Function WorksheetExists(ByVal wb As Workbook, ByVal sheetName As String) As Boolean
    Dim ws As Worksheet
    On Error Resume Next
    Set ws = wb.Worksheets(sheetName)
    On Error GoTo 0
    WorksheetExists = Not ws Is Nothing
End Function

Private Function GetWorksheet(ByVal wb As Workbook, ByVal sheetName As String) As Worksheet
    If Not WorksheetExists(wb, sheetName) Then
        Err.Raise vbObjectError + 9001, "GetWorksheet", "No existe la hoja '" & sheetName & "' en " & wb.Name
    End If
    Set GetWorksheet = wb.Worksheets(sheetName)
End Function

Private Sub RequireHeader(ByVal headers As Object, ByVal headerName As String, ByVal sheetName As String)
    If Not headers.Exists(headerName) Then
        Err.Raise vbObjectError + 9101, "RequireHeader", "Falta header '" & headerName & "' en hoja " & sheetName
    End If
End Sub

Private Function BuildHeaderMap(ByVal ws As Worksheet, ByVal headerRow As Long) As Object
    Dim dict As Object: Set dict = CreateObject("Scripting.Dictionary")
    dict.CompareMode = vbTextCompare

    Dim lastCol As Long
    lastCol = ws.Cells(headerRow, ws.Columns.Count).End(xlToLeft).Column
    If lastCol < 1 Then lastCol = 1

    Dim c As Long, h As String
    For c = 1 To lastCol
        h = Trim$(CStr(ws.Cells(headerRow, c).Value2))
        If Len(h) > 0 Then
            If Not dict.Exists(h) Then dict.Add h, c
        End If
    Next c

    Set BuildHeaderMap = dict
End Function

Private Sub WriteByHeader(ByVal ws As Worksheet, ByVal headers As Object, ByVal rowIndex As Long, ByVal headerName As String, ByVal value As Variant)
    If Not headers.Exists(headerName) Then Exit Sub
    ws.Cells(rowIndex, CLng(headers(headerName))).Value2 = value
End Sub

Private Function NextIdFromHeader(ByVal ws As Worksheet, ByVal idCol As Long, ByVal startRow As Long) As Long
    Dim lastRow As Long
    lastRow = ws.Cells(ws.Rows.Count, idCol).End(xlUp).Row
    If lastRow < startRow Then
        NextIdFromHeader = 1
        Exit Function
    End If

    Dim maxId As Long, r As Long, v As Variant
    maxId = 0
    For r = startRow To lastRow
        v = ws.Cells(r, idCol).Value2
        If IsNumeric(v) Then
            If CLng(v) > maxId Then maxId = CLng(v)
        End If
    Next r

    NextIdFromHeader = maxId + 1
End Function

Private Function NextFreeRow(ByVal ws As Worksheet, ByVal idCol As Long, ByVal startRow As Long) As Long
    Dim lastRow As Long
    lastRow = ws.Cells(ws.Rows.Count, idCol).End(xlUp).Row
    If lastRow < startRow Then
        NextFreeRow = startRow
    Else
        NextFreeRow = lastRow + 1
    End If
End Function

Private Function ReadCell(ByVal wb As Workbook, ByVal wsName As String, ByVal addr As String) As Variant
    ReadCell = wb.Worksheets(wsName).Range(addr).Value2
End Function

Private Function ValSafe(ByVal v As Variant) As Double
    If IsError(v) Or IsEmpty(v) Or IsNull(v) Or (VarType(v) = vbString And Len(Trim$(v)) = 0) Then
        ValSafe = 0#
    ElseIf IsNumeric(v) Then
        ValSafe = CDbl(v)
    Else
        ValSafe = CDbl(Val(v))
    End If
End Function

Private Function FindTotalCol(ByVal ws As Worksheet, ByVal headerRow As Long, ByVal startCol As Long) As Long
    Dim lastCol As Long, c As Long, h As String
    lastCol = ws.Cells(headerRow, ws.Columns.Count).End(xlToLeft).Column
    If lastCol < startCol Then lastCol = startCol

    For c = startCol To lastCol
        h = Trim$(CStr(ws.Cells(headerRow, c).Value2))
        If StrComp(h, CONDOR_TOTAL_HEADER_TEXT, vbTextCompare) = 0 Then
            FindTotalCol = c
            Exit Function
        End If
    Next c

    FindTotalCol = lastCol
End Function

Private Function GetFolderFromFullName(ByVal fullName As String) As String
    Dim p As Long
    p = InStrRev(fullName, "\")
    If p = 0 Then Err.Raise vbObjectError + 2101, "GetFolderFromFullName", "Ruta inválida: " & fullName
    GetFolderFromFullName = Left$(fullName, p)
End Function

Private Function GetFileFromFullName(ByVal fullName As String) As String
    Dim p As Long
    p = InStrRev(fullName, "\")
    If p = 0 Then Err.Raise vbObjectError + 2102, "GetFileFromFullName", "Ruta inválida: " & fullName
    GetFileFromFullName = Mid$(fullName, p + 1)
End Function

Private Function NormalizeFolderPath(ByVal pth As String) As String
    pth = Trim$(pth)
    If Len(pth) = 0 Then Err.Raise vbObjectError + 4001, "NormalizeFolderPath", "FilesFolder vacío."

    If InStr(1, pth, ".xls", vbTextCompare) > 0 Then
        NormalizeFolderPath = GetFolderFromFullName(pth)
    Else
        If Right$(pth, 1) <> "\" Then pth = pth & "\"
        NormalizeFolderPath = pth
    End If
End Function
