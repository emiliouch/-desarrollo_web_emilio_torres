Option Explicit

'===========================================================
' EXPORT CONDOR + BPs -> REPOSITORIO (Base, Tasa_Caida)
'
'-----------------------------------------------------------
' FLUJO GENERAL (qué hace esta macro, en orden)
'-----------------------------------------------------------
' 0) Ajusta settings de Excel para que corra rápido (sin pantalla, sin eventos, sin recálculo).
'
' 1) Valida que existan rutas mínimas:
'       - p.RepoPath (Repositorio.xlsx)
'       - p.CondorInputPath (BPInputTemplate...xlsm)
'       - p.CondorOutputPath (Results_BPInputTemplate...xlsm)
'
' 2) Calcula AUTOMÁTICAMENTE la carpeta donde están los BPs:
'       folderPath = carpeta de p.CondorOutputPath
'    (o sea, no se pide por formulario)
'
' 3) Abre el Repositorio y arma diccionarios de headers para escribir por nombre de columna:
'       - Base (REPO_BASE_SHEET)
'       - Tasa_Caida (REPO_TASA_SHEET)
'       - (Opcional) Permanencia (REPO_PERM_SHEET) si ENABLE_PERMANENCIA = True
'
' 4) Determina el siguiente ID disponible y la próxima fila libre en Base.
'    Importante: NO hace upsert ni reemplazo. Cada ejecución agrega registros NUEVOS.
'
' 5) Abre Condor Input:
'       - Lee nombre de plan desde C4 de cada hoja INPUT indicada en p.PlanSheetsRaw
'       - Lee variables del input (meses venta, inflación, periodicidad, etc.)
'       - Lee tasa caída desde fila 27, columnas C hasta la última con contenido
'       - Define LOAN_DURATION:
'            - Si periodicidad es prima única => usa C35
'            - Si es mensual => "N/A"
'
' 6) Abre Condor Output y busca archivos BP en la carpeta (excluye repo/condor input/condor output).
'
' 7) Inserta 1 registro "Consolidado" en Base:
'       - Saca métricas desde Results_IFRS4_Net (columna "Total")
'       - Lee SOLO el BP consolidado (archivo que contiene "consolidado") y extrae:
'            - Reaseguro (SI/NO), Siniestro cedido, Ratio asistencia/NEP
'
' 8) Inserta 1 registro por plan en Base:
'       - Saca métricas desde la hoja del plan en Condor Output
'       - Escribe inputs del plan (incluye LOAN_DURATION)
'       - Busca el BP del plan y lee hoja "Parametros" (I53, M52, C8, etc.)
'
' 9) Inserta Tasa_Caida por plan en la hoja Tasa_Caida:
'       - Estructura: ID_INTERNO (del plan), PERIODO (1..N), PLAN, TASA
'
' 10) Guarda el repositorio y cierra archivos según closeRepoAfter.
'
'-----------------------------------------------------------
' Notas importantes de diseño
'-----------------------------------------------------------
' - No hay reemplazo: se agregan filas nuevas siempre (esto es intencional).
' - FECHA_INGRESO se setea como Date (fecha de ejecución).
' - Permanencia está desactivada por defecto (flag ENABLE_PERMANENCIA).
'===========================================================

'-----------------------
' Parámetros de ejecución
'-----------------------
Public Type tExportParams
    RepoPath As String

    CondorInputPath As String          'BPInputTemplate...
    CondorOutputPath As String         'Results_BPInputTemplate...

    'Manual / formulario (se repite para consolidado y planes)
    CodigoTarifa As String
    IdBizagi As String
    Poliza As String
    Socio As String

    ValidTerr As Variant
    ValidTec As Variant
    ValidVC As Variant

    CuotasPromedio As Variant
    OtrosCostosDirectosFijos As Variant
    ProfitSharing As Variant
    PrimaCedida As Variant
    FormulaSiniestralidadAplica As Variant
    Brim As Variant
    Observacion As String
    PlanAccion As String
    ProductoCuentaAsistencia As Variant
    DescuentoAsistenciaPct As Variant
    TieneEcosistema As Variant
    CanalTMK As Variant
    ROP As Variant
    BonificacionROPPct As Variant
    VentaPorPlanes As Variant
    TarifaTieneModificaciones As Variant
    PolizaEsContinuacion As Variant

    'Lista de hojas INPUT separadas por ";", por ejemplo: "X;Y;Z"
    PlanSheetsRaw As String
End Type

'-----------------------
' Setup: nombres de hojas / celdas ajustables
'-----------------------
Private Const REPO_BASE_SHEET As String = "Base"
Private Const REPO_PERM_SHEET As String = "Permanencia"   'queda para futuro (no se usa por defecto)
Private Const REPO_TASA_SHEET As String = "Tasa_Caida"

'Flag para reactivar fácilmente el bloque de Permanencia en el futuro
Private Const ENABLE_PERMANENCIA As Boolean = False

Private Const CONDOR_SHEET_CONSOLIDADO As String = "Results_IFRS4_Net"
Private Const CONDOR_TOTAL_HEADER_ROW As Long = 17
Private Const CONDOR_TOTAL_HEADER_TEXT As String = "Total"
Private Const CONDOR_MIN_DATA_COL As Long = 3   'C

'Filas (Output Condor) — se asume mismo layout en consolidado y en plan
Private Const ROW_VENTAS As Long = 126
Private Const ROW_GWP As Long = 131
Private Const ROW_WRITTEN_NET_TAX As Long = 132
Private Const ROW_DEVOLUCIONES As Long = 137
Private Const ROW_NEP As Long = 139
Private Const ROW_COMISIONES_MONTO As Long = 163
Private Const ROW_CLAIMS As Long = 174
Private Const ROW_EXPUESTOS As Long = 288

'Input Condor (por hoja X/Y/Z)
Private Const IN_ADDR_PLANNAME As String = "C4"
Private Const IN_ADDR_MESES_VENTA As String = "C9"
Private Const IN_ADDR_INFLACION As String = "C14"
Private Const IN_ADDR_LOAN_DURATION As String = "C35"   'solo prima única
Private Const IN_ADDR_PERIODICIDAD As String = "C39"
Private Const IN_ADDR_PRODUCT_TYPE As String = "C49"
Private Const IN_ADDR_CUTOFF_RUNOFF As String = "C270"
Private Const IN_ADDR_FECHA_CUTOFF As String = "C272"

'Input Condor tasa caída: fila 27, columnas desde C hasta última con contenido (dinámico)
Private Const IN_TASA_ROW As Long = 27
Private Const IN_TASA_COL_START As Long = 3     'C

'BP por plan
Private Const BP_PARAMS_SHEET As String = "Parametros"
Private Const BP_PARAMS_ASIST_MENSUAL As String = "I53"
Private Const BP_PARAMS_COSTO_VENTA As String = "M52"
Private Const BP_PARAMS_MESES_CARENCIA As String = "C8"
Private Const BP_PARAMS_CAPITAL_ASEG_RNG As String = "C29:C43"
Private Const BP_PARAMS_SIN_MEDIO_RNG As String = "D29:D43"
Private Const BP_PARAMS_TASA_ENTR_RNG As String = "E29:E43"

'Para convertir UF -> CLP desde BP Parámetros:
Private Const BP_UF_LABEL As String = "UF"
Private Const BP_UF_SEARCH_COL As Long = 2      'B
Private Const BP_UF_VALUE_OFFSET As Long = 1    'columna a la derecha del label

'BP consolidado (archivo que contiene "consolidado") — SOLO vars "BP Mensual Consolidado"
Private Const BP_MENSUAL_SHEET As String = "BP Mensual"
Private Const BP_CONS_REASEGURO_CELL As String = "KR50"
Private Const BP_CONS_SINIESTRO_CEDIDO_CELL As String = "KR49"
Private Const BP_CONS_ASIST_CELL As String = "KR39"
Private Const BP_CONS_NEP_CELL As String = "KR18"

Private Const TODO_TEXT As String = "TODO"

'===========================================================
' Entrada principal
'===========================================================
Public Sub ExportarRepositorio(ByRef p As tExportParams, ByVal closeRepoAfter As Boolean)

    '--- Guardar settings actuales para restaurarlos al final
    Dim prevScreenUpdating As Boolean
    Dim prevEnableEvents As Boolean
    Dim prevDisplayAlerts As Boolean
    Dim prevAskToUpdateLinks As Boolean
    Dim prevCalculation As XlCalculation

    Dim repoWB As Workbook
    Dim baseWS As Worksheet, permWS As Worksheet, tasaWS As Worksheet
    Dim headers As Object, permHeaders As Object, tasaHeaders As Object

    Dim colId As Long
    Dim nextId As Long, nextRow As Long

    Dim inWB As Workbook, outWB As Workbook
    Dim inputSheets As Collection
    Dim planMap As Object
    Dim planInputs As Object
    Dim planOrder As Collection

    Dim folderPath As String
    Dim bpFiles As Variant

    On Error GoTo FAIL

    prevScreenUpdating = Application.ScreenUpdating
    prevEnableEvents = Application.EnableEvents
    prevDisplayAlerts = Application.DisplayAlerts
    prevAskToUpdateLinks = Application.AskToUpdateLinks
    prevCalculation = Application.Calculation

    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.DisplayAlerts = False
    Application.AskToUpdateLinks = False
    Application.Calculation = xlCalculationManual

    '--- Validaciones mínimas
    If Len(Trim$(p.RepoPath)) = 0 Then Err.Raise vbObjectError + 7001, "ExportarRepositorio", "RepoPath vacío."
    If Len(Trim$(p.CondorInputPath)) = 0 Then Err.Raise vbObjectError + 7002, "ExportarRepositorio", "CondorInputPath vacío."
    If Len(Trim$(p.CondorOutputPath)) = 0 Then Err.Raise vbObjectError + 7003, "ExportarRepositorio", "CondorOutputPath vacío."

    '--- Carpeta de BPs automática: misma carpeta del Condor Output
    folderPath = GetFolderFromFullName(p.CondorOutputPath)

    '--- Abrir repo
    Set repoWB = Workbooks.Open(Filename:=p.RepoPath, UpdateLinks:=0, ReadOnly:=False, AddToMru:=False)
    Set baseWS = GetWorksheet(repoWB, REPO_BASE_SHEET)
    Set tasaWS = GetWorksheet(repoWB, REPO_TASA_SHEET)

    '--- Permanencia queda opcional (si se activa, se carga aquí)
    If ENABLE_PERMANENCIA Then
        Set permWS = GetWorksheet(repoWB, REPO_PERM_SHEET)
        Set permHeaders = BuildHeaderMap(permWS, 1)
    End If

    '--- Diccionarios header -> columna
    Set headers = BuildHeaderMap(baseWS, 1)
    Set tasaHeaders = BuildHeaderMap(tasaWS, 1)

    '--- Headers mínimos Base
    RequireHeader headers, "ID_INTERNO", REPO_BASE_SHEET
    RequireHeader headers, "CODIGO_TARIFA", REPO_BASE_SHEET
    RequireHeader headers, "PLAN", REPO_BASE_SHEET
    RequireHeader headers, "FECHA_INGRESO", REPO_BASE_SHEET
    RequireHeader headers, "LOAN_DURATION", REPO_BASE_SHEET

    '--- Headers mínimos Tasa_Caida (nueva estructura)
    RequireHeader tasaHeaders, "ID_INTERNO", REPO_TASA_SHEET
    RequireHeader tasaHeaders, "PERIODO", REPO_TASA_SHEET
    RequireHeader tasaHeaders, "PLAN", REPO_TASA_SHEET
    RequireHeader tasaHeaders, "TASA", REPO_TASA_SHEET

    colId = CLng(headers("ID_INTERNO"))

    '--- Siguiente ID y siguiente fila libre (NO se reemplaza nada)
    nextId = NextIdFromHeader(baseWS, colId, 2)
    nextRow = NextFreeRow(baseWS, colId, 2)

    '--- Abrir Condor Input y leer inputs por plan
    Set inWB = Workbooks.Open(Filename:=p.CondorInputPath, UpdateLinks:=0, ReadOnly:=True, AddToMru:=False)

    Set inputSheets = ParseSemicolonList(p.PlanSheetsRaw)
    If inputSheets Is Nothing Or inputSheets.Count = 0 Then
        Err.Raise vbObjectError + 7101, "ExportarRepositorio", "No se ingresaron hojas INPUT (PlanSheetsRaw)."
    End If

    Set planMap = CreateObject("Scripting.Dictionary")
    planMap.CompareMode = vbTextCompare

    Set planInputs = CreateObject("Scripting.Dictionary")
    planInputs.CompareMode = vbTextCompare

    Set planOrder = New Collection

    BuildPlanMappingsAndInputs inWB, inputSheets, planMap, planInputs, planOrder

    '--- Abrir Condor Output
    Set outWB = Workbooks.Open(Filename:=p.CondorOutputPath, UpdateLinks:=0, ReadOnly:=True, AddToMru:=False)

    '--- Listar archivos BP dentro de la carpeta (y excluir archivos no-BP)
    bpFiles = FS_ListExcelFilesInFolder(folderPath, repoWB.FullName, p.CondorInputPath, p.CondorOutputPath)
    If IsEmpty(bpFiles) Then Err.Raise vbObjectError + 7201, "ExportarRepositorio", "No hay BPs en carpeta: " & folderPath
    FS_SortFilesNatural bpFiles

    '=========
    ' 1) CONSOLIDADO (SIEMPRE NUEVO registro)
    '=========
    Dim polizaId As Long
    polizaId = AppendConsolidado(baseWS, headers, nextRow, nextId, p, outWB, bpFiles, folderPath)

    '=========
    ' 2) PLANES (SIEMPRE NUEVOS) + Tasa_Caida por plan
    '=========
    AppendPlanesAndRates baseWS, headers, tasaWS, tasaHeaders, nextRow, nextId, p, outWB, planInputs, planOrder, bpFiles, folderPath, polizaId

    '=========
    ' 3) (Opcional futuro) Permanencia
    '=========
    If ENABLE_PERMANENCIA Then
        'Dejar aquí el bloque cuando se reactive con su estructura definitiva.
    End If

    repoWB.Save

CLEANUP:
    On Error Resume Next
    If Not outWB Is Nothing Then outWB.Close SaveChanges:=False
    If Not inWB Is Nothing Then inWB.Close SaveChanges:=False

    If closeRepoAfter Then
        If Not repoWB Is Nothing Then repoWB.Close SaveChanges:=False
    End If

    '--- Restaurar settings Excel
    Application.Calculation = prevCalculation
    Application.AskToUpdateLinks = prevAskToUpdateLinks
    Application.DisplayAlerts = prevDisplayAlerts
    Application.EnableEvents = prevEnableEvents
    Application.ScreenUpdating = prevScreenUpdating
    Exit Sub

FAIL:
    MsgBox "Error exportando al Repositorio: " & Err.Description, vbCritical
    Resume CLEANUP
End Sub

'===========================================================
' Condor Input: mapping y lectura inputs por plan
'
' planInputs(planName) guarda un diccionario con:
'   - meses_venta
'   - inflacion
'   - periodicidad
'   - product_type
'   - cut_off_run_off
'   - fecha_cut_off (solo si es Cut-Off)
'   - loan_duration (C35 si prima única, si no "N/A")
'   - tasa (array 1..N)
'   - tasa_n (N)
'===========================================================
Private Sub BuildPlanMappingsAndInputs(ByVal inWB As Workbook, ByVal inputSheets As Collection, _
                                      ByRef planMap As Object, ByRef planInputs As Object, ByRef planOrder As Collection)

    Dim s As Variant
    For Each s In inputSheets
        Dim inputSheetName As String
        Dim planName As String

        inputSheetName = CStr(s)

        'Nombre del plan (este nombre debe existir en Condor Output como hoja)
        planName = Trim$(CStr(ReadCell(inWB, inputSheetName, IN_ADDR_PLANNAME)))
        If Len(planName) = 0 Then
            Err.Raise vbObjectError + 7301, "BuildPlanMappingsAndInputs", "C4 vacío (nombre plan) en hoja INPUT: " & inputSheetName
        End If

        planMap(inputSheetName) = planName
        planOrder.Add planName

        Dim d As Object
        Set d = CreateObject("Scripting.Dictionary")
        d.CompareMode = vbTextCompare

        'Inputs básicos
        d("meses_venta") = ReadCell(inWB, inputSheetName, IN_ADDR_MESES_VENTA)
        d("inflacion") = Trim$(CStr(ReadCell(inWB, inputSheetName, IN_ADDR_INFLACION)))

        Dim periodicidadTxt As String
        periodicidadTxt = Trim$(CStr(ReadCell(inWB, inputSheetName, IN_ADDR_PERIODICIDAD)))
        d("periodicidad") = periodicidadTxt

        d("product_type") = Trim$(CStr(ReadCell(inWB, inputSheetName, IN_ADDR_PRODUCT_TYPE)))

        'Cut-Off / Run-Off
        Dim cutTxt As String
        cutTxt = Trim$(CStr(ReadCell(inWB, inputSheetName, IN_ADDR_CUTOFF_RUNOFF)))
        d("cut_off_run_off") = cutTxt

        If StrComp(cutTxt, "Cut-Off", vbTextCompare) = 0 Then
            d("fecha_cut_off") = ReadCell(inWB, inputSheetName, IN_ADDR_FECHA_CUTOFF)
        Else
            d("fecha_cut_off") = Empty
        End If

        'LOAN_DURATION: solo prima única
        If IsPrimaUnicaText(periodicidadTxt) Then
            d("loan_duration") = ReadCell(inWB, inputSheetName, IN_ADDR_LOAN_DURATION)
        Else
            d("loan_duration") = "N/A"
        End If

        'Tasa caída: fila 27, desde C hasta última columna con contenido
        Dim ws As Worksheet
        Set ws = inWB.Worksheets(inputSheetName)

        Dim lastCol As Long
        lastCol = ws.Cells(IN_TASA_ROW, ws.Columns.Count).End(xlToLeft).Column
        If lastCol < IN_TASA_COL_START Then lastCol = IN_TASA_COL_START

        Dim n As Long
        n = lastCol - IN_TASA_COL_START + 1

        Dim tasa() As Double
        ReDim tasa(1 To n)

        Dim k As Long
        For k = 1 To n
            tasa(k) = CDbl(ValSafe(ws.Cells(IN_TASA_ROW, IN_TASA_COL_START + (k - 1)).Value2))
        Next k

        d("tasa") = tasa
        d("tasa_n") = n

        planInputs(planName) = d
    Next s
End Sub

Private Function IsPrimaUnicaText(ByVal periodicidadTxt As String) As Boolean
    Dim s As String
    s = LCase$(Trim$(periodicidadTxt))
    IsPrimaUnicaText = (InStr(1, s, "unic", vbTextCompare) > 0 Or InStr(1, s, "single", vbTextCompare) > 0)
End Function

'===========================================================
' Append Consolidado (siempre nuevo)
' Devuelve polizaId (ID_INTERNO del consolidado insertado)
'===========================================================
Private Function AppendConsolidado(ByVal baseWS As Worksheet, ByVal headers As Object, _
                                  ByRef nextRow As Long, ByRef nextId As Long, _
                                  ByRef p As tExportParams, ByVal outWB As Workbook, _
                                  ByVal bpFiles As Variant, ByVal folderPath As String) As Long

    Dim ws As Worksheet
    If Not WorksheetExists(outWB, CONDOR_SHEET_CONSOLIDADO) Then
        Err.Raise vbObjectError + 7401, "AppendConsolidado", "No existe hoja '" & CONDOR_SHEET_CONSOLIDADO & "' en " & outWB.Name
    End If
    Set ws = outWB.Worksheets(CONDOR_SHEET_CONSOLIDADO)

    'Buscar la columna "Total" (headerRow=17). Si no la encuentra, usa la última.
    Dim totalCol As Long
    totalCol = FindTotalCol(ws, CONDOR_TOTAL_HEADER_ROW, CONDOR_MIN_DATA_COL)

    'Leer métricas desde filas fijas del Output
    Dim m As tMetrics
    m = ReadCondorMetrics(ws, totalCol)

    'Derivados (porcentajes/ratios)
    Dim comPct As Variant
    If m.NEP <> 0# Then comPct = m.ComisionesMonto / m.NEP Else comPct = Empty

    Dim valorCliente As Variant
    If m.NEP <> 0# Then valorCliente = m.Claims / m.NEP Else valorCliente = Empty

    Dim siniestralidad As Variant
    Dim denomLR As Double
    denomLR = m.NEP - m.ComisionesMonto
    If denomLR <> 0# Then siniestralidad = m.Claims / denomLR Else siniestralidad = Empty

    Dim permanencia As Variant
    If m.Ventas <> 0# Then permanencia = m.Expuestos / m.Ventas Else permanencia = Empty

    Dim duracionMediaMeses As Variant
    duracionMediaMeses = permanencia

    Dim primaClienteNeta As Variant
    primaClienteNeta = CalcPrimaClienteNeta(m.GWP, m.Expuestos, m.Ventas, "")

    Dim ivaEfectivo As Variant
    Dim ivaRec As Variant
    If m.WrittenNetTax <> 0# Then
        ivaEfectivo = (m.GWP - m.WrittenNetTax) / m.WrittenNetTax
        ivaRec = 0.19 - CDbl(ivaEfectivo)
    Else
        ivaEfectivo = Empty
        ivaRec = Empty
    End If

    Dim gastosDirectosMonto As Double
    Dim gastosIndirectosMonto As Double
    gastosDirectosMonto = m.GastosDirectosMonto
    gastosIndirectosMonto = m.GastosIndirectosMonto

    Dim gastosDirectosPct As Variant
    Dim gastosIndirectosPct As Variant
    If m.NEP <> 0# Then
        gastosDirectosPct = gastosDirectosMonto / m.NEP
        gastosIndirectosPct = gastosIndirectosMonto / m.NEP
    Else
        gastosDirectosPct = Empty
        gastosIndirectosPct = Empty
    End If

    'BP consolidado: SOLO vars "BP Mensual Consolidado"
    Dim reaseguroFlag As Variant
    Dim siniestroCedido As Variant
    Dim ratioAsistSobreNEP As Variant
    ReadBPConsolidadoVars bpFiles, reaseguroFlag, siniestroCedido, ratioAsistSobreNEP

    'Asignar ID/row y avanzar contadores
    Dim rowIndex As Long, idValue As Long
    rowIndex = nextRow
    idValue = nextId
    nextRow = nextRow + 1
    nextId = nextId + 1

    'Escritura común (formulario) + campos calculados
    WriteBaseCommon baseWS, headers, rowIndex, idValue, p, "Consolidado", True
    WriteByHeader baseWS, headers, rowIndex, "RUTA", folderPath

    WriteByHeader baseWS, headers, rowIndex, "VENTAS", m.Ventas
    WriteByHeader baseWS, headers, rowIndex, "GWP", m.GWP
    WriteByHeader baseWS, headers, rowIndex, "WRITTEN_PREMIUM_NET_TAX", m.WrittenNetTax
    WriteByHeader baseWS, headers, rowIndex, "NEP", m.NEP
    WriteByHeader baseWS, headers, rowIndex, "CARGA_SINIESTROS", m.Claims
    WriteByHeader baseWS, headers, rowIndex, "COMISIONES", comPct
    WriteByHeader baseWS, headers, rowIndex, "EXPUESTOS", m.Expuestos

    WriteByHeader baseWS, headers, rowIndex, "VALOR_CLIENTE", valorCliente
    WriteByHeader baseWS, headers, rowIndex, "SINIESTRALIDAD", siniestralidad

    WriteByHeader baseWS, headers, rowIndex, "PERMANENCIA", permanencia
    WriteByHeader baseWS, headers, rowIndex, "DURACION_MEDIA_MESES", duracionMediaMeses
    WriteByHeader baseWS, headers, rowIndex, "PRIMA_CLIENTE_NETA", primaClienteNeta

    WriteByHeader baseWS, headers, rowIndex, "IVA_EFECTIVO", ivaEfectivo
    WriteByHeader baseWS, headers, rowIndex, "IVA_RECUPERABLE", ivaRec

    WriteByHeader baseWS, headers, rowIndex, "GASTOS_DIRECTOS", gastosDirectosMonto
    WriteByHeader baseWS, headers, rowIndex, "GASTOS_INDIRECTOS", gastosIndirectosMonto
    WriteByHeader baseWS, headers, rowIndex, "GASTOS_DIRECTOS / NEP", gastosDirectosPct
    WriteByHeader baseWS, headers, rowIndex, "GASTOS_INDIRECTOS / NEP", gastosIndirectosPct

    WriteByHeader baseWS, headers, rowIndex, "FECHA_FIN_TARIFA", Date

    'Consolidado no trae inputs por plan => vacío
    WriteByHeader baseWS, headers, rowIndex, "MESES DE VENTA", Empty
    WriteByHeader baseWS, headers, rowIndex, "INFLACION", vbNullString
    WriteByHeader baseWS, headers, rowIndex, "CUT_OFF_RUN_OFF", vbNullString
    WriteByHeader baseWS, headers, rowIndex, "FECHA_CUT_OFF", Empty
    WriteByHeader baseWS, headers, rowIndex, "PERIODICIDAD", vbNullString
    WriteByHeader baseWS, headers, rowIndex, "Product Type", vbNullString

    'LOAN_DURATION no aplica al consolidado
    WriteByHeader baseWS, headers, rowIndex, "LOAN_DURATION", "N/A"

    'BP Mensual Consolidado
    WriteByHeader baseWS, headers, rowIndex, "REASEGURO (SI/NO)", reaseguroFlag
    WriteByHeader baseWS, headers, rowIndex, "SINIESTRO_CEDIDO", siniestroCedido
    WriteByHeader baseWS, headers, rowIndex, "RATIO ASISTENCIA SOBRE LA NEP", ratioAsistSobreNEP

    WriteByHeader baseWS, headers, rowIndex, "COMISION BRUTA SOBRE PRIMA BRUTA", TODO_TEXT

    AppendConsolidado = idValue
End Function

'===========================================================
' Append Planes (siempre nuevos) + Tasa_Caida por plan (ID del plan)
'===========================================================
Private Sub AppendPlanesAndRates(ByVal baseWS As Worksheet, ByVal headers As Object, _
                                ByVal tasaWS As Worksheet, ByVal tasaHeaders As Object, _
                                ByRef nextRow As Long, ByRef nextId As Long, _
                                ByRef p As tExportParams, ByVal outWB As Workbook, _
                                ByVal planInputs As Object, ByVal planOrder As Collection, _
                                ByVal bpFiles As Variant, ByVal folderPath As String, ByVal polizaId As Long)

    Dim i As Long
    For i = 1 To planOrder.Count
        Dim planName As String
        planName = CStr(planOrder(i))

        'Cada plan debe existir como hoja en Condor Output
        If Not WorksheetExists(outWB, planName) Then
            Err.Raise vbObjectError + 7501, "AppendPlanesAndRates", "No existe hoja de plan '" & planName & "' en " & outWB.Name
        End If

        Dim ws As Worksheet
        Set ws = outWB.Worksheets(planName)

        Dim totalCol As Long
        totalCol = FindTotalCol(ws, CONDOR_TOTAL_HEADER_ROW, CONDOR_MIN_DATA_COL)

        Dim m As tMetrics
        m = ReadCondorMetrics(ws, totalCol)

        Dim d As Object
        Set d = planInputs(planName)

        'Inputs del plan
        Dim mesesVenta As Variant: mesesVenta = d("meses_venta")
        Dim inflacionTxt As String: inflacionTxt = CStr(d("inflacion"))
        Dim cutOffRunOffTxt As String: cutOffRunOffTxt = CStr(d("cut_off_run_off"))
        Dim fechaCutOff As Variant: fechaCutOff = d("fecha_cut_off")
        Dim periodicidadTxt As String: periodicidadTxt = CStr(d("periodicidad"))
        Dim productTypeTxt As String: productTypeTxt = CStr(d("product_type"))
        Dim loanDuration As Variant: loanDuration = d("loan_duration")

        'Derivados
        Dim comPct As Variant
        If m.NEP <> 0# Then comPct = m.ComisionesMonto / m.NEP Else comPct = Empty

        Dim valorCliente As Variant
        If m.NEP <> 0# Then valorCliente = m.Claims / m.NEP Else valorCliente = Empty

        Dim siniestralidad As Variant
        Dim denomLR As Double
        denomLR = m.NEP - m.ComisionesMonto
        If denomLR <> 0# Then siniestralidad = m.Claims / denomLR Else siniestralidad = Empty

        Dim permanencia As Variant
        If m.Ventas <> 0# Then permanencia = m.Expuestos / m.Ventas Else permanencia = Empty

        Dim duracionMediaMeses As Variant
        duracionMediaMeses = CalcDuracionMedia(m.Expuestos, m.Ventas, periodicidadTxt)

        Dim primaClienteNeta As Variant
        primaClienteNeta = CalcPrimaClienteNeta(m.GWP, m.Expuestos, m.Ventas, periodicidadTxt)

        Dim ivaEfectivo As Variant
        Dim ivaRec As Variant
        If m.WrittenNetTax <> 0# Then
            ivaEfectivo = (m.GWP - m.WrittenNetTax) / m.WrittenNetTax
            ivaRec = 0.19 - CDbl(ivaEfectivo)
        Else
            ivaEfectivo = Empty
            ivaRec = Empty
        End If

        Dim gastosDirectosMonto As Double
        Dim gastosIndirectosMonto As Double
        gastosDirectosMonto = m.GastosDirectosMonto
        gastosIndirectosMonto = m.GastosIndirectosMonto

        Dim gastosDirectosPct As Variant
        Dim gastosIndirectosPct As Variant
        If m.NEP <> 0# Then
            gastosDirectosPct = gastosDirectosMonto / m.NEP
            gastosIndirectosPct = gastosIndirectosMonto / m.NEP
        Else
            gastosDirectosPct = Empty
            gastosIndirectosPct = Empty
        End If

        'BP por plan
        Dim asistMensualCLP As Variant
        Dim asistVentaCLP As Variant
        Dim costosMensualesCLP As Variant
        Dim costosVentaCLP As Variant
        Dim mesesCarencia As Variant
        Dim capitalAsegCLP As Variant
        Dim sinMedioRiesgoCLP As Variant
        Dim tasaEntradaRiesgo As Variant

        ReadBPPlanParametros bpFiles, planName, _
            asistMensualCLP, asistVentaCLP, costosMensualesCLP, costosVentaCLP, _
            mesesCarencia, capitalAsegCLP, sinMedioRiesgoCLP, tasaEntradaRiesgo

        'Nuevo ID/row (siempre append)
        Dim rowIndex As Long, idValue As Long
        rowIndex = nextRow
        idValue = nextId
        nextRow = nextRow + 1
        nextId = nextId + 1

        'Escritura común + ruta
        WriteBaseCommon baseWS, headers, rowIndex, idValue, p, planName, False
        WriteByHeader baseWS, headers, rowIndex, "RUTA", folderPath

        'Inputs Condor
        WriteByHeader baseWS, headers, rowIndex, "MESES DE VENTA", mesesVenta
        WriteByHeader baseWS, headers, rowIndex, "INFLACION", inflacionTxt
        WriteByHeader baseWS, headers, rowIndex, "CUT_OFF_RUN_OFF", cutOffRunOffTxt
        WriteByHeader baseWS, headers, rowIndex, "FECHA_CUT_OFF", fechaCutOff
        WriteByHeader baseWS, headers, rowIndex, "PERIODICIDAD", periodicidadTxt
        WriteByHeader baseWS, headers, rowIndex, "Product Type", productTypeTxt
        WriteByHeader baseWS, headers, rowIndex, "LOAN_DURATION", loanDuration

        'Output Condor
        WriteByHeader baseWS, headers, rowIndex, "VENTAS", m.Ventas
        WriteByHeader baseWS, headers, rowIndex, "GWP", m.GWP
        WriteByHeader baseWS, headers, rowIndex, "WRITTEN_PREMIUM_NET_TAX", m.WrittenNetTax
        WriteByHeader baseWS, headers, rowIndex, "NEP", m.NEP
        WriteByHeader baseWS, headers, rowIndex, "CARGA SINIESTROS", m.Claims
        WriteByHeader baseWS, headers, rowIndex, "COMISIONES", comPct
        WriteByHeader baseWS, headers, rowIndex, "EXPUESTOS", m.Expuestos

        WriteByHeader baseWS, headers, rowIndex, "VALOR_CLIENTE", valorCliente
        WriteByHeader baseWS, headers, rowIndex, "SINIESTRALIDAD", siniestralidad

        WriteByHeader baseWS, headers, rowIndex, "PERMANENCIA", permanencia
        WriteByHeader baseWS, headers, rowIndex, "DURACION_MEDIA_MESES", duracionMediaMeses
        WriteByHeader baseWS, headers, rowIndex, "PRIMA_CLIENTE_NETA", primaClienteNeta

        WriteByHeader baseWS, headers, rowIndex, "IVA EFECTIVO", ivaEfectivo
        WriteByHeader baseWS, headers, rowIndex, "IVA RECUPERABLE", ivaRec

        WriteByHeader baseWS, headers, rowIndex, "GASTOS_DIRECTOS", gastosDirectosMonto
        WriteByHeader baseWS, headers, rowIndex, "GASTOS_INDIRECTOS", gastosIndirectosMonto
        WriteByHeader baseWS, headers, rowIndex, "GASTOS DIRECTOS / NEP", gastosDirectosPct
        WriteByHeader baseWS, headers, rowIndex, "GASTOS INDIRECTOS / NEP", gastosIndirectosPct

        WriteByHeader baseWS, headers, rowIndex, "FECHA_FIN_TARIFA", Date

        'Parámetros BP (por plan)
        WriteByHeader baseWS, headers, rowIndex, "ASISTENCIA_MENSUAL", asistMensualCLP
        WriteByHeader baseWS, headers, rowIndex, "ASISTENCIA_VENTA", asistVentaCLP
        WriteByHeader baseWS, headers, rowIndex, "COSTOS_MENSUALES", costosMensualesCLP
        WriteByHeader baseWS, headers, rowIndex, "COSTOS_VENTA", costosVentaCLP
        WriteByHeader baseWS, headers, rowIndex, "CAPITAL ASEGURADO", capitalAsegCLP
        WriteByHeader baseWS, headers, rowIndex, "SINIESTRO MEDIO POR RIESGO", sinMedioRiesgoCLP
        WriteByHeader baseWS, headers, rowIndex, "TASA DE ENTRADA POR RIESGO", tasaEntradaRiesgo
        WriteByHeader baseWS, headers, rowIndex, "MESES DE CARENCIA", mesesCarencia

        WriteByHeader baseWS, headers, rowIndex, "COMISION BRUTA SOBRE PRIMA BRUTA", TODO_TEXT

        'Tasa_Caida por plan (ID_INTERNO = idValue del plan)
        AppendTasaCaidaPlan tasaWS, tasaHeaders, idValue, planName, d
    Next i
End Sub

Private Sub AppendTasaCaidaPlan(ByVal tasaWS As Worksheet, ByVal headers As Object, _
                               ByVal planId As Long, ByVal planName As String, ByVal planDict As Object)

    Dim tasa() As Double
    tasa = planDict("tasa")

    Dim n As Long
    n = CLng(planDict("tasa_n"))

    'Primera fila libre en Tasa_Caida
    Dim outRow As Long
    outRow = NextFreeRow(tasaWS, CLng(headers("ID_INTERNO")), 2)

    'Inserta N filas: PERIODO=1..N
    Dim i As Long
    For i = 1 To n
        WriteByHeader tasaWS, headers, outRow, "ID_INTERNO", planId
        WriteByHeader tasaWS, headers, outRow, "PERIODO", i
        WriteByHeader tasaWS, headers, outRow, "PLAN", planName
        WriteByHeader tasaWS, headers, outRow, "TASA", tasa(i)
        outRow = outRow + 1
    Next i
End Sub

'===========================================================
' Escritura común en Base (campos de formulario + fechas)
'===========================================================
Private Sub WriteBaseCommon(ByVal baseWS As Worksheet, ByVal headers As Object, _
                            ByVal rowIndex As Long, ByVal idValue As Long, _
                            ByRef p As tExportParams, ByVal planLabel As String, ByVal isConsolidado As Boolean)

    WriteByHeader baseWS, headers, rowIndex, "ID_INTERNO", idValue
    WriteByHeader baseWS, headers, rowIndex, "CODIGO_TARIFA", p.CodigoTarifa
    WriteByHeader baseWS, headers, rowIndex, "PLAN", planLabel

    'Fecha en que se insertó el registro (nuevo)
    WriteByHeader baseWS, headers, rowIndex, "FECHA_INGRESO", Date

    WriteByHeader baseWS, headers, rowIndex, "ID_BIZAGI", p.IdBizagi
    WriteByHeader baseWS, headers, rowIndex, "POLIZA", p.Poliza
    WriteByHeader baseWS, headers, rowIndex, "SOCIO", p.Socio

    WriteByHeader baseWS, headers, rowIndex, "VALIDACION_TERRITORIAL", p.ValidTerr
    WriteByHeader baseWS, headers, rowIndex, "VALIDACION_TECNICA", p.ValidTec
    WriteByHeader baseWS, headers, rowIndex, "VALIDACION_VALOR_CLIENTE", p.ValidVC

    WriteByHeader baseWS, headers, rowIndex, "CUOTAS_PROMEDIO", p.CuotasPromedio
    WriteByHeader baseWS, headers, rowIndex, "OTROS_COSTOS_DIRECTOS_FIJOS", p.OtrosCostosDirectosFijos
    WriteByHeader baseWS, headers, rowIndex, "PROFIT SHARING (SI/NO)", p.ProfitSharing
    WriteByHeader baseWS, headers, rowIndex, "PRIMA_CEDIDA", p.PrimaCedida
    WriteByHeader baseWS, headers, rowIndex, "FORMULA_SINIESTRALIDAD_APLICA (SI/NO)", p.FormulaSiniestralidadAplica
    WriteByHeader baseWS, headers, rowIndex, "BRIM", p.Brim
    WriteByHeader baseWS, headers, rowIndex, "OBSERVACIÓN", p.Observacion
    WriteByHeader baseWS, headers, rowIndex, "PLAN DE ACCIÓN", p.PlanAccion

    WriteByHeader baseWS, headers, rowIndex, "PRODUCTO CUENTA CON ASISTENCIA (SI/NO)", p.ProductoCuentaAsistencia
    WriteByHeader baseWS, headers, rowIndex, "%DE DESCUENTO ASISTENCIA", p.DescuentoAsistenciaPct

    WriteByHeader baseWS, headers, rowIndex, "TIENE ECOSISTEMA (SI/NO)", p.TieneEcosistema
    WriteByHeader baseWS, headers, rowIndex, "CANAL TMK (SI/NO)", p.CanalTMK

    WriteByHeader baseWS, headers, rowIndex, "ROP (SI/NO)", p.ROP
    WriteByHeader baseWS, headers, rowIndex, "BONIFICACION ROP %", p.BonificacionROPPct

    WriteByHeader baseWS, headers, rowIndex, "VENTA POR PLANES (SI/NO)", p.VentaPorPlanes
    WriteByHeader baseWS, headers, rowIndex, "SI LA TARIFA TIENE MODIFICACIONES", p.TarifaTieneModificaciones
    WriteByHeader baseWS, headers, rowIndex, "POLIZA ES CONTINUACION (SI/NO)", p.PolizaEsContinuacion

    'Solo planes (no consolidado)
    If Not isConsolidado Then
        WriteByHeader baseWS, headers, rowIndex, "ESTADO_PLAN", "Vigente"
        WriteByHeader baseWS, headers, rowIndex, "FECHA_ESTADO_PLAN", Date
    End If
End Sub

'===========================================================
' Métricas Condor Output (consolidado o plan)
'===========================================================
Private Type tMetrics
    Ventas As Double
    GWP As Double
    WrittenNetTax As Double
    Devoluciones As Double
    NEP As Double
    ComisionesMonto As Double
    Claims As Double
    Expuestos As Double
    GastosDirectosMonto As Double
    GastosIndirectosMonto As Double
End Type

Private Function ReadCondorMetrics(ByVal ws As Worksheet, ByVal totalCol As Long) As tMetrics
    Dim m As tMetrics

    m.Ventas = CDbl(ValSafe(ws.Cells(ROW_VENTAS, totalCol).Value2))
    m.GWP = CDbl(ValSafe(ws.Cells(ROW_GWP, totalCol).Value2))
    m.WrittenNetTax = CDbl(ValSafe(ws.Cells(ROW_WRITTEN_NET_TAX, totalCol).Value2))
    m.Devoluciones = CDbl(ValSafe(ws.Cells(ROW_DEVOLUCIONES, totalCol).Value2))
    m.NEP = CDbl(ValSafe(ws.Cells(ROW_NEP, totalCol).Value2))
    m.ComisionesMonto = CDbl(ValSafe(ws.Cells(ROW_COMISIONES_MONTO, totalCol).Value2))
    m.Claims = CDbl(ValSafe(ws.Cells(ROW_CLAIMS, totalCol).Value2))

    'Expuestos: no está en una sola celda, se suma desde C hasta última col con datos en la fila 288
    m.Expuestos = SumRowFromCToLastNonEmpty(ws, ROW_EXPUESTOS)

    'Gastos directos / indirectos: filas fijas (según tu layout)
    m.GastosDirectosMonto = CDbl(ValSafe(ws.Cells(191, totalCol).Value2)) + CDbl(ValSafe(ws.Cells(192, totalCol).Value2))
    m.GastosIndirectosMonto = CDbl(ValSafe(ws.Cells(196, totalCol).Value2)) + CDbl(ValSafe(ws.Cells(197, totalCol).Value2))

    ReadCondorMetrics = m
End Function

Private Function SumRowFromCToLastNonEmpty(ByVal ws As Worksheet, ByVal rowNum As Long) As Double
    Dim lastCol As Long
    lastCol = ws.Cells(rowNum, ws.Columns.Count).End(xlToLeft).Column
    If lastCol < CONDOR_MIN_DATA_COL Then lastCol = CONDOR_MIN_DATA_COL

    Dim c As Long, v As Variant, acc As Double
    acc = 0#
    For c = CONDOR_MIN_DATA_COL To lastCol
        v = ws.Cells(rowNum, c).Value2
        If IsNumeric(v) Then acc = acc + CDbl(v)
    Next c
    SumRowFromCToLastNonEmpty = acc
End Function

'===========================================================
' Cálculos derivados
'===========================================================
Private Function CalcDuracionMedia(ByVal expuestos As Double, ByVal ventas As Double, ByVal periodicidadTxt As String) As Variant
    If ventas = 0# Then
        CalcDuracionMedia = Empty
        Exit Function
    End If
    CalcDuracionMedia = expuestos / ventas
End Function

Private Function CalcPrimaClienteNeta(ByVal gwp As Double, ByVal expuestos As Double, ByVal ventas As Double, ByVal periodicidadTxt As String) As Variant
    Dim s As String
    s = LCase$(Trim$(periodicidadTxt))

    If Len(s) = 0 Then
        CalcPrimaClienteNeta = Empty
        Exit Function
    End If

    'Mensual: GWP / expuestos
    If InStr(1, s, "mens", vbTextCompare) > 0 Or InStr(1, s, "month", vbTextCompare) > 0 Then
        If expuestos <> 0# Then
            CalcPrimaClienteNeta = gwp / expuestos
        Else
            CalcPrimaClienteNeta = Empty
        End If
        Exit Function
    End If

    'Prima única: GWP / ventas
    If InStr(1, s, "unic", vbTextCompare) > 0 Or InStr(1, s, "single", vbTextCompare) > 0 Then
        If ventas <> 0# Then
            CalcPrimaClienteNeta = gwp / ventas
        Else
            CalcPrimaClienteNeta = Empty
        End If
        Exit Function
    End If

    CalcPrimaClienteNeta = TODO_TEXT
End Function

'===========================================================
' BP consolidado (archivo con "consolidado" en el nombre)
'===========================================================
Private Sub ReadBPConsolidadoVars(ByVal files As Variant, _
                                 ByRef reaseguroFlag As Variant, ByRef siniestroCedido As Variant, ByRef ratioAsistSobreNEP As Variant)

    Dim consPath As String
    consPath = FS_FindBestFileByTokenFiltered(files, "consolidado", True)

    If Len(consPath) = 0 Then
        reaseguroFlag = TODO_TEXT
        siniestroCedido = TODO_TEXT
        ratioAsistSobreNEP = TODO_TEXT
        Exit Sub
    End If

    Dim wb As Workbook
    Set wb = Workbooks.Open(Filename:=consPath, UpdateLinks:=0, ReadOnly:=True, AddToMru:=False)

    If Not WorksheetExists(wb, BP_MENSUAL_SHEET) Then
        wb.Close SaveChanges:=False
        reaseguroFlag = TODO_TEXT
        siniestroCedido = TODO_TEXT
        ratioAsistSobreNEP = TODO_TEXT
        Exit Sub
    End If

    Dim ws As Worksheet
    Set ws = wb.Worksheets(BP_MENSUAL_SHEET)

    Dim vRea As Double
    vRea = CDbl(ValSafe(ws.Range(BP_CONS_REASEGURO_CELL).Value2))
    If vRea > 0# Then reaseguroFlag = "SI" Else reaseguroFlag = "NO"

    siniestroCedido = ws.Range(BP_CONS_SINIESTRO_CEDIDO_CELL).Value2

    Dim vAsist As Double
    Dim vNep As Double
    vAsist = CDbl(ValSafe(ws.Range(BP_CONS_ASIST_CELL).Value2))
    vNep = CDbl(ValSafe(ws.Range(BP_CONS_NEP_CELL).Value2))
    If vNep <> 0# Then ratioAsistSobreNEP = vAsist / vNep Else ratioAsistSobreNEP = Empty

    wb.Close SaveChanges:=False
End Sub

'===========================================================
' BP por plan: lee hoja Parametros y convierte UF -> CLP
'===========================================================
Private Sub ReadBPPlanParametros(ByVal files As Variant, ByVal planName As String, _
                                ByRef asistMensualCLP As Variant, ByRef asistVentaCLP As Variant, _
                                ByRef costosMensualesCLP As Variant, ByRef costosVentaCLP As Variant, _
                                ByRef mesesCarencia As Variant, _
                                ByRef capitalAsegCLP As Variant, ByRef sinMedioRiesgoCLP As Variant, ByRef tasaEntradaRiesgo As Variant)

    Dim planPath As String
    planPath = FS_FindBestFileByTokenFiltered(files, planName, False)

    If Len(planPath) = 0 Then
        asistMensualCLP = TODO_TEXT
        asistVentaCLP = TODO_TEXT
        costosMensualesCLP = TODO_TEXT
        costosVentaCLP = TODO_TEXT
        mesesCarencia = TODO_TEXT
        capitalAsegCLP = TODO_TEXT
        sinMedioRiesgoCLP = TODO_TEXT
        tasaEntradaRiesgo = TODO_TEXT
        Exit Sub
    End If

    Dim wb As Workbook
    Set wb = Workbooks.Open(Filename:=planPath, UpdateLinks:=0, ReadOnly:=True, AddToMru:=False)

    If Not WorksheetExists(wb, BP_PARAMS_SHEET) Then
        wb.Close SaveChanges:=False
        asistMensualCLP = TODO_TEXT
        asistVentaCLP = TODO_TEXT
        costosMensualesCLP = TODO_TEXT
        costosVentaCLP = TODO_TEXT
        mesesCarencia = TODO_TEXT
        capitalAsegCLP = TODO_TEXT
        sinMedioRiesgoCLP = TODO_TEXT
        tasaEntradaRiesgo = TODO_TEXT
        Exit Sub
    End If

    Dim ws As Worksheet
    Set ws = wb.Worksheets(BP_PARAMS_SHEET)

    Dim ufCLP As Variant
    ufCLP = ReadUF_CLP_FromParametros(ws)

    'Asistencia mensual UF (I53) -> CLP
    Dim vI53 As Variant
    vI53 = ws.Range(BP_PARAMS_ASIST_MENSUAL).Value2

    If IsNumeric(ufCLP) Then
        asistMensualCLP = CDbl(ValSafe(vI53)) * CDbl(ufCLP)
    Else
        asistMensualCLP = TODO_TEXT
    End If

    'No definido en tu instrucción (queda TODO)
    asistVentaCLP = TODO_TEXT

    'Costo venta UF (M52) -> CLP
    Dim vM52 As Variant
    vM52 = ws.Range(BP_PARAMS_COSTO_VENTA).Value2
    If IsNumeric(ufCLP) Then
        costosVentaCLP = CDbl(ValSafe(vM52)) * CDbl(ufCLP)
    Else
        costosVentaCLP = TODO_TEXT
    End If

    'Costos mensuales: sumatoria UF (asistencia + recaudación + BTG) -> CLP
    If IsNumeric(ufCLP) Then
        Dim costoRecaudF55 As Double
        costoRecaudF55 = CDbl(ValSafe(ws.Range("F55").Value2))

        Dim primaNetaC6 As Double
        primaNetaC6 = CDbl(ValSafe(ws.Range("C6").Value2))

        Dim pctBTG_C14 As Double
        pctBTG_C14 = CDbl(ValSafe(ws.Range("C14").Value2))

        Dim btgUF As Double
        btgUF = primaNetaC6 * pctBTG_C14

        Dim totalUF As Double
        totalUF = CDbl(ValSafe(vI53)) + costoRecaudF55 + btgUF

        costosMensualesCLP = totalUF * CDbl(ufCLP)
    Else
        costosMensualesCLP = TODO_TEXT
    End If

    mesesCarencia = ws.Range(BP_PARAMS_MESES_CARENCIA).Value2

    'Listas por tramo en UF -> CLP
    If IsNumeric(ufCLP) Then
        capitalAsegCLP = RangeToSemicolonList_CLP(ws.Range(BP_PARAMS_CAPITAL_ASEG_RNG), CDbl(ufCLP))
        sinMedioRiesgoCLP = RangeToSemicolonList_CLP(ws.Range(BP_PARAMS_SIN_MEDIO_RNG), CDbl(ufCLP))
    Else
        capitalAsegCLP = TODO_TEXT
        sinMedioRiesgoCLP = TODO_TEXT
    End If

    'Tasa entrada: se deja tal cual (no se convierte)
    tasaEntradaRiesgo = RangeToSemicolonList_RAW(ws.Range(BP_PARAMS_TASA_ENTR_RNG))

    wb.Close SaveChanges:=False
End Sub

Private Function ReadUF_CLP_FromParametros(ByVal wsParametros As Worksheet) As Variant
    Dim lastRow As Long
    lastRow = wsParametros.Cells(wsParametros.Rows.Count, BP_UF_SEARCH_COL).End(xlUp).Row
    If lastRow < 1 Then
        ReadUF_CLP_FromParametros = Empty
        Exit Function
    End If

    Dim r As Long
    For r = 1 To lastRow
        Dim label As String
        label = Trim$(CStr(wsParametros.Cells(r, BP_UF_SEARCH_COL).Value2))
        If StrComp(label, BP_UF_LABEL, vbTextCompare) = 0 Then
            Dim v As Variant
            v = wsParametros.Cells(r, BP_UF_SEARCH_COL + BP_UF_VALUE_OFFSET).Value2
            If IsNumeric(v) Then
                ReadUF_CLP_FromParametros = CDbl(v)
            Else
                ReadUF_CLP_FromParametros = Empty
            End If
            Exit Function
        End If
    Next r

    ReadUF_CLP_FromParametros = Empty
End Function

Private Function RangeToSemicolonList_CLP(ByVal rng As Range, ByVal ufCLP As Double) As String
    Dim arr As Variant
    arr = rng.Value2

    Dim r As Long, s As String, v As Variant
    For r = 1 To UBound(arr, 1)
        v = arr(r, 1)
        If IsNumeric(v) Then
            If Len(s) > 0 Then s = s & ";"
            s = s & CStr(CDbl(v) * ufCLP)
        Else
            If Len(s) > 0 Then s = s & ";"
            s = s & ""
        End If
    Next r

    RangeToSemicolonList_CLP = s
End Function

Private Function RangeToSemicolonList_RAW(ByVal rng As Range) As String
    Dim arr As Variant
    arr = rng.Value2

    Dim r As Long, s As String, v As Variant
    For r = 1 To UBound(arr, 1)
        v = arr(r, 1)
        If Len(s) > 0 Then s = s & ";"
        s = s & Trim$(CStr(v))
    Next r

    RangeToSemicolonList_RAW = s
End Function

'===========================================================
' Files: listar / match (solo BPs)
'===========================================================
Private Function FS_ListExcelFilesInFolder(ByVal folderPath As String, ByVal excludeRepo As String, ByVal excludeCondorIn As String, ByVal excludeCondorOut As String) As Variant
    Dim f As String, full As String
    Dim col As Collection: Set col = New Collection

    If Right$(folderPath, 1) <> "\" Then folderPath = folderPath & "\"

    f = Dir(folderPath & "*.xls*")
    Do While Len(f) > 0
        If Left$(f, 2) <> "~$" Then
            full = folderPath & f

            'Excluir los archivos base del proceso
            If StrComp(full, excludeRepo, vbTextCompare) <> 0 _
                And StrComp(full, excludeCondorIn, vbTextCompare) <> 0 _
                And StrComp(full, excludeCondorOut, vbTextCompare) <> 0 Then

                'Excluir archivos Condor por prefijo
                Dim fn As String
                fn = LCase$(f)

                If Left$(fn, Len("bpinputtemplate")) <> "bpinputtemplate" Then
                    If Left$(fn, Len("results_bpinputtemplate")) <> "results_bpinputtemplate" Then
                        col.Add full
                    End If
                End If
            End If
        End If
        f = Dir()
    Loop

    If col.Count = 0 Then Exit Function

    Dim arr() As String, i As Long
    ReDim arr(0 To col.Count - 1)
    For i = 1 To col.Count
        arr(i - 1) = CStr(col(i))
    Next i

    FS_ListExcelFilesInFolder = arr
End Function

Private Sub FS_SortFilesNatural(ByRef files As Variant)
    If IsEmpty(files) Then Exit Sub
    FS_QuickSortNatural files, LBound(files), UBound(files)
End Sub

Private Sub FS_QuickSortNatural(ByRef arr As Variant, ByVal lo As Long, ByVal hi As Long)
    Dim i As Long, j As Long
    Dim pivot As String, tmp As String

    i = lo: j = hi
    pivot = arr((lo + hi) \ 2)

    Do While i <= j
        Do While FS_NaturalCompare(arr(i), pivot) < 0
            i = i + 1
        Loop
        Do While FS_NaturalCompare(arr(j), pivot) > 0
            j = j - 1
        Loop

        If i <= j Then
            tmp = arr(i): arr(i) = arr(j): arr(j) = tmp
            i = i + 1: j = j - 1
        End If
    Loop

    If lo < j Then FS_QuickSortNatural arr, lo, j
    If i < hi Then FS_QuickSortNatural arr, i, hi
End Sub

Private Function FS_NaturalCompare(ByVal a As String, ByVal b As String) As Long
    Dim i As Long, j As Long
    Dim ca As String, cb As String
    Dim na As String, nb As String

    a = LCase$(GetFileFromFullName(a))
    b = LCase$(GetFileFromFullName(b))

    i = 1: j = 1
    Do While i <= Len(a) And j <= Len(b)
        ca = Mid$(a, i, 1)
        cb = Mid$(b, j, 1)

        If FS_IsDigit(ca) And FS_IsDigit(cb) Then
            na = FS_ReadNumber(a, i)
            nb = FS_ReadNumber(b, j)

            If CLng(na) <> CLng(nb) Then
                FS_NaturalCompare = Sgn(CLng(na) - CLng(nb))
                Exit Function
            End If
        Else
            If ca <> cb Then
                FS_NaturalCompare = Sgn(StrComp(ca, cb, vbTextCompare))
                Exit Function
            End If
            i = i + 1
            j = j + 1
        End If
    Loop

    FS_NaturalCompare = Sgn(Len(a) - Len(b))
End Function

Private Function FS_IsDigit(ByVal ch As String) As Boolean
    FS_IsDigit = (ch >= "0" And ch <= "9")
End Function

Private Function FS_ReadNumber(ByVal s As String, ByRef idx As Long) As String
    Dim startPos As Long
    startPos = idx
    Do While idx <= Len(s) And FS_IsDigit(Mid$(s, idx, 1))
        idx = idx + 1
    Loop
    FS_ReadNumber = Mid$(s, startPos, idx - startPos)
End Function

'Encuentra "mejor match" por token:
' - filterConsolidado=True obliga a que el nombre contenga "consolidado"
' - Para plan: token=nombre del plan (busca substring)
Private Function FS_FindBestFileByTokenFiltered(ByVal files As Variant, ByVal token As String, ByVal filterConsolidado As Boolean) As String
    Dim best As String
    Dim bestScore As Long
    Dim i As Long, fn As String
    Dim t As String

    t = LCase$(Trim$(token))
    If Len(t) = 0 Then Exit Function

    bestScore = 2147483647

    For i = LBound(files) To UBound(files)
        fn = LCase$(GetFileFromFullName(CStr(files(i))))

        If filterConsolidado Then
            If InStr(1, fn, "consolidado", vbTextCompare) = 0 Then GoTo NextI
        End If

        If InStr(1, fn, t, vbTextCompare) > 0 Then
            'Score simple: preferir nombre más corto (suele ser match más “limpio”)
            Dim score As Long
            score = Len(fn)
            If score < bestScore Then
                bestScore = score
                best = CStr(files(i))
            End If
        End If
NextI:
    Next i

    FS_FindBestFileByTokenFiltered = best
End Function

'===========================================================
' Helpers básicos
'===========================================================
Private Function ParseSemicolonList(ByVal rawText As String) As Collection
    Dim col As Collection: Set col = New Collection
    Dim seen As Object: Set seen = CreateObject("Scripting.Dictionary")
    seen.CompareMode = vbTextCompare

    rawText = Trim$(rawText)
    If Len(rawText) = 0 Then
        Set ParseSemicolonList = col
        Exit Function
    End If

    Dim parts As Variant, i As Long, s As String
    parts = Split(rawText, ";")
    For i = LBound(parts) To UBound(parts)
        s = Trim$(CStr(parts(i)))
        If Len(s) > 0 Then
            If Not seen.Exists(UCase$(s)) Then
                col.Add s
                seen.Add UCase$(s), True
            End If
        End If
    Next i

    Set ParseSemicolonList = col
End Function

Private Function WorksheetExists(ByVal wb As Workbook, ByVal sheetName As String) As Boolean
    Dim ws As Worksheet
    On Error Resume Next
    Set ws = wb.Worksheets(sheetName)
    On Error GoTo 0
    WorksheetExists = Not ws Is Nothing
End Function

Private Function GetWorksheet(ByVal wb As Workbook, ByVal sheetName As String) As Worksheet
    If Not WorksheetExists(wb, sheetName) Then
        Err.Raise vbObjectError + 9001, "GetWorksheet", "No existe la hoja '" & sheetName & "' en " & wb.Name
    End If
    Set GetWorksheet = wb.Worksheets(sheetName)
End Function

Private Sub RequireHeader(ByVal headers As Object, ByVal headerName As String, ByVal sheetName As String)
    If Not headers.Exists(headerName) Then
        Err.Raise vbObjectError + 9101, "RequireHeader", "Falta header '" & headerName & "' en hoja " & sheetName
    End If
End Sub

'Construye diccionario "Header -> Número de columna" leyendo la fila de headers
Private Function BuildHeaderMap(ByVal ws As Worksheet, ByVal headerRow As Long) As Object
    Dim dict As Object: Set dict = CreateObject("Scripting.Dictionary")
    dict.CompareMode = vbTextCompare

    Dim lastCol As Long
    lastCol = ws.Cells(headerRow, ws.Columns.Count).End(xlToLeft).Column
    If lastCol < 1 Then lastCol = 1

    Dim c As Long, h As String
    For c = 1 To lastCol
        h = Trim$(CStr(ws.Cells(headerRow, c).Value2))
        If Len(h) > 0 Then
            If Not dict.Exists(h) Then dict.Add h, c
        End If
    Next c

    Set BuildHeaderMap = dict
End Function

'Escritura por nombre de header (evita hardcodear columnas)
Private Sub WriteByHeader(ByVal ws As Worksheet, ByVal headers As Object, ByVal rowIndex As Long, ByVal headerName As String, ByVal value As Variant)
    If Not headers.Exists(headerName) Then Exit Sub
    ws.Cells(rowIndex, CLng(headers(headerName))).Value2 = value
End Sub

'Busca el máximo ID en columna idCol desde startRow y devuelve max+1
Private Function NextIdFromHeader(ByVal ws As Worksheet, ByVal idCol As Long, ByVal startRow As Long) As Long
    Dim lastRow As Long
    lastRow = ws.Cells(ws.Rows.Count, idCol).End(xlUp).Row
    If lastRow < startRow Then
        NextIdFromHeader = 1
        Exit Function
    End If

    Dim maxId As Long, r As Long, v As Variant
    maxId = 0
    For r = startRow To lastRow
        v = ws.Cells(r, idCol).Value2
        If IsNumeric(v) Then
            If CLng(v) > maxId Then maxId = CLng(v)
        End If
    Next r

    NextIdFromHeader = maxId + 1
End Function

'Devuelve primera fila libre usando la columna ID como referencia
Private Function NextFreeRow(ByVal ws As Worksheet, ByVal idCol As Long, ByVal startRow As Long) As Long
    Dim lastRow As Long
    lastRow = ws.Cells(ws.Rows.Count, idCol).End(xlUp).Row
    If lastRow < startRow Then
        NextFreeRow = startRow
    Else
        NextFreeRow = lastRow + 1
    End If
End Function

Private Function ReadCell(ByVal wb As Workbook, ByVal wsName As String, ByVal addr As String) As Variant
    ReadCell = wb.Worksheets(wsName).Range(addr).Value2
End Function

'Convierte variantes “raros” a número seguro (errores/empty/string vacío => 0)
Private Function ValSafe(ByVal v As Variant) As Double
    If IsError(v) Or IsEmpty(v) Or IsNull(v) Or (VarType(v) = vbString And Len(Trim$(v)) = 0) Then
        ValSafe = 0#
    ElseIf IsNumeric(v) Then
        ValSafe = CDbl(v)
    Else
        ValSafe = CDbl(Val(v))
    End If
End Function

'Busca la columna donde en headerRow aparece "Total" (desde startCol)
Private Function FindTotalCol(ByVal ws As Worksheet, ByVal headerRow As Long, ByVal startCol As Long) As Long
    Dim lastCol As Long, c As Long, h As String
    lastCol = ws.Cells(headerRow, ws.Columns.Count).End(xlToLeft).Column
    If lastCol < startCol Then lastCol = startCol

    For c = startCol To lastCol
        h = Trim$(CStr(ws.Cells(headerRow, c).Value2))
        If StrComp(h, CONDOR_TOTAL_HEADER_TEXT, vbTextCompare) = 0 Then
            FindTotalCol = c
            Exit Function
        End If
    Next c

    FindTotalCol = lastCol
End Function

Private Function GetFolderFromFullName(ByVal fullName As String) As String
    Dim p As Long
    p = InStrRev(fullName, "\")
    If p = 0 Then Err.Raise vbObjectError + 2101, "GetFolderFromFullName", "Ruta inválida: " & fullName
    GetFolderFromFullName = Left$(fullName, p)
End Function

Private Function GetFileFromFullName(ByVal fullName As String) As String
    Dim p As Long
    p = InStrRev(fullName, "\")
    If p = 0 Then Err.Raise vbObjectError + 2102, "GetFileFromFullName", "Ruta inválida: " & fullName
    GetFileFromFullName = Mid$(fullName, p + 1)
End Function
