Option Explicit

Public Cancelled As Boolean
Public CloseRepoAfter As Boolean  'no lo estás usando -> queda False

Private Sub UserForm_Initialize()
    Cancelled = True
    CloseRepoAfter = False

    'Dejar captions “cuadrado” vacíos al inicio
    ApplyToggleCaption "tglProductoCuentaAsistencia"
    ApplyToggleCaption "tglTieneEcosistema"
    ApplyToggleCaption "tglCanalTMK"
    ApplyToggleCaption "tglROP"
    ApplyToggleCaption "tglVentaPorPlanes"

    ApplyToggleCaption "tglProfitSharing"
    ApplyToggleCaption "tglBrim"
    ApplyToggleCaption "tglFormulaSiniestralidad"
    ApplyToggleCaption "tglPolizaContinuacion"

    SyncConditionalFields
End Sub

' Clicks toggles
Private Sub tglROP_Click(): ApplyToggleCaption "tglROP": SyncConditionalFields: End Sub
Private Sub tglVentaPorPlanes_Click(): ApplyToggleCaption "tglVentaPorPlanes": SyncConditionalFields: End Sub

Private Sub tglProfitSharing_Click(): ApplyToggleCaption "tglProfitSharing": SyncConditionalFields: End Sub
Private Sub tglBrim_Click(): ApplyToggleCaption "tglBrim": SyncConditionalFields: End Sub
Private Sub tglFormulaSiniestralidad_Click(): ApplyToggleCaption "tglFormulaSiniestralidad": SyncConditionalFields: End Sub
Private Sub tglPolizaContinuacion_Click(): ApplyToggleCaption "tglPolizaContinuacion": SyncConditionalFields: End Sub

Private Sub tglProductoCuentaAsistencia_Click(): ApplyToggleCaption "tglProductoCuentaAsistencia": End Sub
Private Sub tglTieneEcosistema_Click(): ApplyToggleCaption "tglTieneEcosistema": End Sub
Private Sub tglCanalTMK_Click(): ApplyToggleCaption "tglCanalTMK": End Sub

'========================
' Botones
'========================
Private Sub cmdCancelar_Click()
    Cancelled = True
    Me.Hide
End Sub

Private Sub cmdExportar_Click()
    On Error GoTo EH

    Dim p As tExportParams

    'Textos
    p.CodigoTarifa = Trim$(txtCodigoTarifa.Text)
    p.Poliza = Trim$(txtPoliza.Text)
    p.Observacion = Trim$(txtObservacion.Text)
    p.PlanAccion = Trim$(txtPlanAccion.Text)

    'Numéricos
    p.CuotasPromedio = ParseNum(txtCuotasPromedio.Text)
    p.PrimaCedida = ParseNum(txtPrimaCedida.Text)
    p.DescuentoAsistenciaPct = ParseNum(txtDescuentoAsistenciaPct.Text)

    'SI/NO
    p.ProductoCuentaAsistencia = ToggleToSiNo("tglProductoCuentaAsistencia")
    p.TieneEcosistema = ToggleToSiNo("tglTieneEcosistema")
    p.CanalTMK = ToggleToSiNo("tglCanalTMK")

    p.FormulaSiniestralidadAplica = ToggleToSiNo("tglFormulaSiniestralidad")

    p.ProfitSharing = ToggleToSiNo("tglProfitSharing")

    p.Brim = ToggleToSiNo("tglBrim")

    p.ROP = ToggleToSiNo("tglROP")
    If p.ROP = "SI" Then
        p.BonificacionROPPct = ParseNum(txtBonificacionROPPct.Text)
    Else
        p.BonificacionROPPct = "N/A"
    End If

    p.VentaPorPlanes = ToggleToSiNo("tglVentaPorPlanes")
    If p.VentaPorPlanes = "SI" Then
        p.PlanSheetsRaw = Trim$(txtPlanSheetsRaw.Text)
    Else
        p.PlanSheetsRaw = vbNullString
    End If

    'Póliza continuación (NO / SI: <nro>)
    If ToggleToSiNo("tglPolizaContinuacion") = "SI" Then
        Dim nro As String
        nro = Trim$(txtPolizaContinuacion.Text)
        If Len(nro) = 0 Or Not IsNumeric(nro) Then
            Err.Raise vbObjectError + 900, "frmExportRepo", "Póliza continuación: ingresa solo el número."
        End If
        p.PolizaEsContinuacion = "SI: " & nro
    Else
        p.PolizaEsContinuacion = "NO"
    End If

    'Validación central del módulo
    ValidateManualFields p

    gExportParams = p
    Cancelled = False
    Me.Hide
    Exit Sub

EH:
    MsgBox Err.Description, vbExclamation
End Sub

' UI helpers
Private Sub SyncConditionalFields()
    Dim ropOn As Boolean
    Dim contOn As Boolean
    Dim psOn As Boolean
    Dim psKpiOn As Boolean
    Dim vppOn As Boolean

    ropOn = (ToggleToSiNo("tglROP") = "SI")
    contOn = (ToggleToSiNo("tglPolizaContinuacion") = "SI")
    psOn = (ToggleToSiNo("tglProfitSharing") = "SI")
    vppOn = (ToggleToSiNo("tglVentaPorPlanes") = "SI")

    'ROP -> Bonificación visible solo si ROP=SI
    SetVisibleEnabled "txtBonificacionROPPct", ropOn
    SetVisibleEnabled "lblBonificacionROPPct", ropOn
    SetVisibleEnabled "Label13", ropOn  '<< este es el que te falta

    If Not ropOn Then ClearIfExists "txtBonificacionROPPct"

    'Continuación -> textbox visible solo si SI
    SetVisibleEnabled "txtPolizaContinuacion", contOn
    SetVisibleEnabled "lblPolizaContinuacion", contOn

    If Not contOn Then ClearIfExists "txtPolizaContinuacion"

    'ProfitSharing -> % visible solo si SI
    SetVisibleEnabled "txtProfitSharing", False
    SetVisibleEnabled "lblProfitSharingPct", False

    ClearIfExists "txtProfitSharing"

    'Venta por planes -> PlanSheetsRaw + labels visibles solo si SI
    SetVisibleEnabled "txtPlanSheetsRaw", vppOn
    SetVisibleEnabled "Label5", vppOn
    SetVisibleEnabled "Label21", vppOn
    SetVisibleEnabled "Label22", vppOn

    If Not vppOn Then ClearIfExists "txtPlanSheetsRaw"
End Sub


Private Sub ApplyToggleCaption(ByVal ctlName As String)
    If Not ControlExists(ctlName) Then Exit Sub
    With Me.Controls(ctlName)
        If CBool(.Value) Then
            .Caption = "X"
        Else
            .Caption = vbNullString
        End If
        On Error Resume Next
        .TakeFocusOnClick = False
        On Error GoTo 0
    End With
End Sub

Private Function ToggleToSiNo(ByVal ctlName As String) As String
    If Not ControlExists(ctlName) Then
        ToggleToSiNo = "NO"
        Exit Function
    End If
    ToggleToSiNo = IIf(CBool(Me.Controls(ctlName).Value), "SI", "NO")
End Function

Private Sub SetVisibleEnabled(ByVal ctlName As String, ByVal onOff As Boolean)
    If Not ControlExists(ctlName) Then Exit Sub
    With Me.Controls(ctlName)
        .Visible = onOff
        .Enabled = onOff
    End With
End Sub

Private Sub ClearIfExists(ByVal ctlName As String)
    If Not ControlExists(ctlName) Then Exit Sub
    On Error Resume Next
    Me.Controls(ctlName).Text = vbNullString
    On Error GoTo 0
End Sub

Private Function ControlExists(ByVal ctlName As String) As Boolean
    On Error Resume Next
    Dim o As Object
    Set o = Me.Controls(ctlName)
    ControlExists = Not o Is Nothing
    On Error GoTo 0
End Function

Private Function ParseNum(ByVal s As String) As Variant
    s = Trim$(s)
    If Len(s) = 0 Then
        ParseNum = Empty
        Exit Function
    End If

    s = Replace(s, ".", "")
    s = Replace(s, ",", ".")
    ParseNum = CDbl(Val(s))
End Function
