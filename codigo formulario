Option Explicit

Public Cancelled As Boolean
Public OutParams As tExportParams
Public CloseRepoAfter As Boolean  'no lo estás usando -> queda False

Private Sub UserForm_Initialize()
    Cancelled = True
    CloseRepoAfter = False

    'Dejar captions “cuadrado” vacíos al inicio
    ApplyToggleCaption "tglProductoCuentaAsistencia"
    ApplyToggleCaption "tglTieneEcosistema"
    ApplyToggleCaption "tglCanalTMK"
    ApplyToggleCaption "tglROP"
    ApplyToggleCaption "tglVentaPorPlanes"

    ApplyToggleCaption "tglProfitSharing"
    ApplyToggleCaption "tglBrim"
    ApplyToggleCaption "tglFormulaSiniestralidad"
    ApplyToggleCaption "tglPolizaContinuacion"

    SyncConditionalFields
End Sub

' Clicks toggles
Private Sub tglROP_Click(): ApplyToggleCaption "tglROP": SyncConditionalFields: End Sub
Private Sub tglVentaPorPlanes_Click(): ApplyToggleCaption "tglVentaPorPlanes": SyncConditionalFields: End Sub

Private Sub tglProfitSharing_Click(): ApplyToggleCaption "tglProfitSharing": SyncConditionalFields: End Sub
Private Sub tglBrim_Click(): ApplyToggleCaption "tglBrim": SyncConditionalFields: End Sub
Private Sub tglFormulaSiniestralidad_Click(): ApplyToggleCaption "tglFormulaSiniestralidad": SyncConditionalFields: End Sub
Private Sub tglPolizaContinuacion_Click(): ApplyToggleCaption "tglPolizaContinuacion": SyncConditionalFields: End Sub

Private Sub tglProductoCuentaAsistencia_Click(): ApplyToggleCaption "tglProductoCuentaAsistencia": End Sub
Private Sub tglTieneEcosistema_Click(): ApplyToggleCaption "tglTieneEcosistema": End Sub
Private Sub tglCanalTMK_Click(): ApplyToggleCaption "tglCanalTMK": End Sub

'========================
' Botones
'========================
Private Sub cmdCancelar_Click()
    Cancelled = True
    Me.Hide
End Sub

Private Sub cmdExportar_Click()
    On Error GoTo EH

    Dim p As tExportParams

    'Textos
    p.CodigoTarifa = Trim$(txtCodigoTarifa.Text)
    p.Poliza = Trim$(txtPoliza.Text)
    p.Observacion = Trim$(txtObservacion.Text)
    p.PlanAccion = Trim$(txtPlanAccion.Text)

    'Numéricos
    p.UF_CLP = ParseNum(txtUF_CLP.Text)
    p.CuotasPromedio = ParseNum(txtCuotasPromedio.Text)
    p.PrimaCedida = ParseNum(txtPrimaCedida.Text)
    p.DescuentoAsistenciaPct = ParseNum(txtDescuentoAsistenciaPct.Text)

    'SI/NO
    p.ProductoCuentaAsistencia = ToggleToSiNo("tglProductoCuentaAsistencia")
    p.TieneEcosistema = ToggleToSiNo("tglTieneEcosistema")
    p.CanalTMK = ToggleToSiNo("tglCanalTMK")

    p.FormulaSiniestralidadAplica = ToggleToSiNo("tglFormulaSiniestralidad")

    p.ProfitSharing = ToggleToSiNo("tglProfitSharing")
    If p.ProfitSharing = "SI" Then
        p.ProfitSharingPct = ParseNum(txtProfitSharing.Text)
    Else
        p.ProfitSharingPct = "N/A"
    End If

    p.Brim = ToggleToSiNo("tglBrim")
    If p.Brim = "SI" Then
        p.KpiBrim = ParseNum(txtBrim.Text)
    Else
        p.KpiBrim = "N/A"
    End If

    p.ROP = ToggleToSiNo("tglROP")
    If p.ROP = "SI" Then
        p.BonificacionROPPct = ParseNum(txtBonificacionROPPct.Text)
    Else
        p.BonificacionROPPct = "N/A"
    End If

    p.VentaPorPlanes = ToggleToSiNo("tglVentaPorPlanes")
    If p.VentaPorPlanes = "SI" Then
        p.PlanSheetsRaw = Trim$(txtPlanSheetsRaw.Text)
    Else
        p.PlanSheetsRaw = vbNullString
    End If

    'Póliza continuación (NO / SI: <nro>)
    If ToggleToSiNo("tglPolizaContinuacion") = "SI" Then
        Dim nro As String
        nro = Trim$(txtPolizaContinuacion.Text)
        If Len(nro) = 0 Or Not IsNumeric(nro) Then
            Err.Raise vbObjectError + 900, "frmExportRepo", "Póliza continuación: ingresa solo el número."
        End If
        p.PolizaEsContinuacion = "SI: " & nro
    Else
        p.PolizaEsContinuacion = "NO"
    End If

    'Validación central del módulo
    ValidateManualFields p

    OutParams = p
    Cancelled = False
    Me.Hide
    Exit Sub

EH:
    MsgBox Err.Description, vbExclamation
End Sub

' UI helpers
Private Sub SyncConditionalFields()
    'ROP -> Bonificación visible solo si ROP=SI
    SetVisibleEnabled "txtBonificacionROPPct", (ToggleToSiNo("tglROP") = "SI")
    SetVisibleEnabled "lblBonificacionROPPct", (ToggleToSiNo("tglROP") = "SI")

    If ToggleToSiNo("tglROP") <> "SI" Then ClearIfExists "txtBonificacionROPPct"

    'Continuación -> textbox visible solo si SI
    SetVisibleEnabled "txtPolizaContinuacion", (ToggleToSiNo("tglPolizaContinuacion") = "SI")
    SetVisibleEnabled "lblPolizaContinuacion", (ToggleToSiNo("tglPolizaContinuacion") = "SI")

    If ToggleToSiNo("tglPolizaContinuacion") <> "SI" Then ClearIfExists "txtPolizaContinuacion"

    'ProfitSharing -> % visible solo si SI
    SetVisibleEnabled "txtProfitSharing", (ToggleToSiNo("tglProfitSharing") = "SI")
    SetVisibleEnabled "lblProfitSharingPct", (ToggleToSiNo("tglProfitSharing") = "SI")

    If ToggleToSiNo("tglProfitSharing") <> "SI" Then ClearIfExists "txtProfitSharing"

    'BRIM -> KPI visible solo si SI
    SetVisibleEnabled "txtBrim", (ToggleToSiNo("tglBrim") = "SI")
    SetVisibleEnabled "lblKpiBrim", (ToggleToSiNo("tglBrim") = "SI")

    If ToggleToSiNo("tglBrim") <> "SI" Then ClearIfExists "txtBrim"

    'Venta por planes -> PlanSheetsRaw habilitado solo si SI
    SetVisibleEnabled "txtPlanSheetsRaw", (ToggleToSiNo("tglVentaPorPlanes") = "SI")
    If ToggleToSiNo("tglVentaPorPlanes") <> "SI" Then ClearIfExists "txtPlanSheetsRaw"
End Sub

Private Sub ApplyToggleCaption(ByVal ctlName As String)
    If Not ControlExists(ctlName) Then Exit Sub
    With Me.Controls(ctlName)
        If CBool(.Value) Then
            .Caption = "X"
        Else
            .Caption = vbNullString
        End If
        On Error Resume Next
        .TakeFocusOnClick = False
        On Error GoTo 0
    End With
End Sub

Private Function ToggleToSiNo(ByVal ctlName As String) As String
    If Not ControlExists(ctlName) Then
        ToggleToSiNo = "NO"
        Exit Function
    End If
    ToggleToSiNo = IIf(CBool(Me.Controls(ctlName).Value), "SI", "NO")
End Function

Private Sub SetVisibleEnabled(ByVal ctlName As String, ByVal onOff As Boolean)
    If Not ControlExists(ctlName) Then Exit Sub
    With Me.Controls(ctlName)
        .Visible = onOff
        .Enabled = onOff
    End With
End Sub

Private Sub ClearIfExists(ByVal ctlName As String)
    If Not ControlExists(ctlName) Then Exit Sub
    On Error Resume Next
    Me.Controls(ctlName).Text = vbNullString
    On Error GoTo 0
End Sub

Private Function ControlExists(ByVal ctlName As String) As Boolean
    On Error Resume Next
    Dim o As Object
    Set o = Me.Controls(ctlName)
    ControlExists = Not o Is Nothing
    On Error GoTo 0
End Function

Private Function ParseNum(ByVal s As String) As Variant
    s = Trim$(s)
    If Len(s) = 0 Then
        ParseNum = Empty
        Exit Function
    End If

    'Chile típico: 1.234,56 -> 1234.56
    s = Replace(s, ".", "")
    s = Replace(s, ",", ".")
    ParseNum = CDbl(Val(s))
End Function
