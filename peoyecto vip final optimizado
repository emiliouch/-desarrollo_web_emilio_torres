Option Explicit

'========================
' Config
'========================
Private Const BP_SHEET_NAME As String = "BP Mensual"
Private Const BP_RANGE_FIRST_COL As String = "C"
Private Const BP_RANGE_LAST_COL As String = "KP"
Private Const BP_FIRST_ROW As Long = 6
Private Const BP_LAST_ROW As Long = 68

Private Const RES_SHEET_NAME As String = "Resumen Consolidado"
Private Const RES_FIRST_COL As Long = 3          'C
Private Const RES_FIRST_ROW As Long = 6
Private Const RES_LAST_ROW As Long = 68
Private Const RES_SRC_COL_LETTER As String = "KR" 'columna origen en BP Mensual hijos

'Filas a saltar: BP y Resumen (independientes)
Private BP_SKIP_ROWS As Variant
Private RES_SKIP_ROWS As Variant

'========================
' Public (botón)
'========================
Public Sub ActualizarBP()
    Dim wbMaster As Workbook
    Dim prevCalc As XlCalculation
    Dim stage As String

    On Error GoTo CleanFail

    Set wbMaster = ActiveWorkbook

    prevCalc = Application.Calculation
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.DisplayAlerts = False
    Application.Calculation = xlCalculationManual

    '--- filas que NO se tocan
    BP_SKIP_ROWS = Array(11, 19, 28, 31, 32, 33, 34, 35, 38, 47, 51, 54, 55, 60, 62, 64, 67, 69)
    RES_SKIP_ROWS = Array(11, 19, 28, 31, 32, 33, 34, 35, 38, 47, 51, 54, 55, 60, 62, 64, 67, 69) 'cámbiala cuando corresponda

    stage = "Validar hojas"
    RequireSheet wbMaster, BP_SHEET_NAME
    RequireSheet wbMaster, RES_SHEET_NAME

    stage = "Obtener carpeta"
    Dim folderPath As String
    folderPath = GetPlansFolderPath(wbMaster)

    stage = "Listar y ordenar archivos"
    Dim files As Variant
    files = ListExcelFilesInFolder(folderPath, wbMaster.FullName)
    If IsEmpty(files) Then GoTo CleanOk

    SortFilesNatural files

    '=========================================================
    ' 1) BP Mensual: SUMA vinculada (ULTRA optimizado)
    '    Se escribe por BLOQUES usando FormulaR1C1Local y !RC
    '=========================================================
    stage = "Actualizar BP Mensual"
    BuildBP_LinkedSums_R1C1 wbMaster.Worksheets(BP_SHEET_NAME), files, BP_SKIP_ROWS

    '=========================================================
    ' 2) Resumen Consolidado: KR6..KR68 a columnas C,D,E...
    '    También por BLOQUES usando !RC[KRcol] (col fija)
    '=========================================================
    stage = "Actualizar Resumen Consolidado"
    BuildResumen_ByColumns_R1C1 wbMaster.Worksheets(RES_SHEET_NAME), files, RES_SKIP_ROWS

CleanOk:
    Application.Calculation = prevCalc
    Application.DisplayAlerts = True
    Application.EnableEvents = True
    Application.ScreenUpdating = True
    Exit Sub

CleanFail:
    Application.Calculation = prevCalc
    Application.DisplayAlerts = True
    Application.EnableEvents = True
    Application.ScreenUpdating = True

    MsgBox "Error etapa: " & stage & vbCrLf & _
           "N°: " & Err.Number & vbCrLf & _
           "Desc: " & Err.Description, vbCritical, "ActualizarBP"
End Sub

'========================
' (Opcional) Botón
'========================
Public Sub RecrearBotonActualizarBP()
    Dim ws As Worksheet
    Set ws = ThisWorkbook.Worksheets(BP_SHEET_NAME)

    Dim shp As Shape
    Const shpName As String = "btnActualizarBP"

    On Error Resume Next
    ws.Shapes(shpName).Delete
    On Error GoTo 0

    Dim anchor As Range
    Set anchor = ws.Range("B2")

    Set shp = ws.Shapes.AddShape(Type:=msoShapeRoundedRectangle, _
                                 Left:=anchor.Left, Top:=anchor.Top, _
                                 Width:=140, Height:=32)

    With shp
        .Name = shpName
        .TextFrame2.TextRange.Text = "Actualizar BP"
        .OnAction = "'" & ThisWorkbook.Name & "'!ActualizarBP"
        .Placement = xlFreeFloating
    End With
End Sub

'========================
' Funciones auxiliares
'========================

'--- Validación simple: si falta hoja, corta con error claro
Private Sub RequireSheet(ByVal wb As Workbook, ByVal sheetName As String)
    If Not WorksheetExists(wb, sheetName) Then
        Err.Raise vbObjectError + 9001, "RequireSheet", _
                  "No existe la hoja '" & sheetName & "' en " & wb.Name
    End If
End Sub

Private Function WorksheetExists(ByVal wb As Workbook, ByVal sheetName As String) As Boolean
    Dim ws As Worksheet
    On Error Resume Next
    Set ws = wb.Worksheets(sheetName)
    On Error GoTo 0
    WorksheetExists = Not ws Is Nothing
End Function

'--- Carpeta del madre (misma carpeta siempre)
Private Function GetPlansFolderPath(ByVal wbMaster As Workbook) As String
    Dim p As String
    p = wbMaster.Path
    If Len(p) = 0 Then Err.Raise vbObjectError + 2001, "GetPlansFolderPath", "El archivo madre debe estar guardado."
    If Right$(p, 1) <> "\" Then p = p & "\"
    GetPlansFolderPath = p
End Function

'--- Listar Excel en carpeta, excluyendo el madre y temporales (~$)
Private Function ListExcelFilesInFolder(ByVal folderPath As String, ByVal excludeFullName As String) As Variant
    Dim f As String, full As String
    Dim col As Collection: Set col = New Collection

    If Right$(folderPath, 1) <> "\" Then folderPath = folderPath & "\"

    f = Dir(folderPath & "*.xls*")
    Do While Len(f) > 0
        If Left$(f, 2) <> "~$" Then
            full = folderPath & f
            If StrComp(full, excludeFullName, vbTextCompare) <> 0 Then col.Add full
        End If
        f = Dir()
    Loop

    If col.Count = 0 Then Exit Function

    Dim arr() As String, i As Long
    ReDim arr(0 To col.Count - 1)
    For i = 1 To col.Count
        arr(i - 1) = CStr(col(i))
    Next i
    ListExcelFilesInFolder = arr
End Function

'=========================================================
' OPTIMIZACIÓN CLAVE #1:
' BP Mensual en BLOQUES con FormulaR1C1Local
'
' Fórmula única para todo el rango:
' =SUMA('...\[f1]BP Mensual'!RC; '...\[f2]BP Mensual'!RC; ...)
'
' RC hace que cada celda apunte a su misma fila/col en cada archivo.
'=========================================================
Private Sub BuildBP_LinkedSums_R1C1(ByVal wsBP As Worksheet, ByVal files As Variant, ByVal skipRows As Variant)
    Dim sep As String
    sep = Application.International(xlListSeparator) 'normalmente ";"

    Dim sumExpr As String
    sumExpr = BuildSumExpr_R1C1(files, BP_SHEET_NAME, sep) 'sin "="

    Dim formulaLocal As String
    formulaLocal = "=SUMA(" & sumExpr & ")"

    'Rango total objetivo (C6:KP68)
    Dim rngAll As Range
    Set rngAll = wsBP.Range(BP_RANGE_FIRST_COL & BP_FIRST_ROW & ":" & BP_RANGE_LAST_COL & BP_LAST_ROW)

    'Aplicar por BLOQUES de filas contiguas (saltando filas)
    ApplyFormulaByRowBlocks_R1C1Local rngAll, formulaLocal, skipRows
End Sub

'Construye el interior de SUMA(...) usando !RC
' Ej:  '...\[a.xlsm]BP Mensual'!RC ; '...\[b.xlsm]BP Mensual'!RC ; ...
Private Function BuildSumExpr_R1C1(ByVal files As Variant, ByVal sheetName As String, ByVal sep As String) As String
    Dim i As Long
    Dim s As String

    For i = LBound(files) To UBound(files)
        If Len(s) > 0 Then s = s & sep
        s = s & ExternalRef_R1C1_RC(CStr(files(i)), sheetName) 'termina en !RC
    Next i

    BuildSumExpr_R1C1 = s
End Function

'Devuelve: 'C:\ruta\[Archivo.xlsm]BP Mensual'!RC
Private Function ExternalRef_R1C1_RC(ByVal fullName As String, ByVal sheetName As String) As String
    Dim folderPath As String, fileName As String
    folderPath = GetFolderFromFullName(fullName)
    fileName = GetFileFromFullName(fullName)

    ExternalRef_R1C1_RC = "'" & EscapeApostrophes(folderPath) & "[" & EscapeApostrophes(fileName) & "]" & _
                          EscapeApostrophes(sheetName) & "'!RC"
End Function

'=========================================================
' OPTIMIZACIÓN CLAVE #2:
' Resumen Consolidado por columnas, también por BLOQUES
'
' Cada columna i:
'   = '...\[file_i]BP Mensual'!RC276   (276 = columna KR)
' aplicado en C6:C68, D6:D68, etc.
'=========================================================
Private Sub BuildResumen_ByColumns_R1C1(ByVal wsRes As Worksheet, ByVal files As Variant, ByVal skipRows As Variant)
    Dim srcColNum As Long
    srcColNum = ColLetterToNum(RES_SRC_COL_LETTER) 'KR -> 276

    Dim i As Long, dstCol As Long
    Dim formula As String
    Dim rngCol As Range

    For i = LBound(files) To UBound(files)
        dstCol = RES_FIRST_COL + (i - LBound(files))

        'Fórmula R1C1: misma fila, columna fija KR (276)
        'Ojo: acá NO usamos SUMA, es referencia directa por archivo.
        formula = "=" & ExternalRef_R1C1_RC_AbsCol(CStr(files(i)), BP_SHEET_NAME, srcColNum)

        Set rngCol = wsRes.Range(wsRes.Cells(RES_FIRST_ROW, dstCol), wsRes.Cells(RES_LAST_ROW, dstCol))
        ApplyFormulaByRowBlocks_R1C1Local rngCol, formula, skipRows
    Next i
End Sub

'Devuelve: 'C:\ruta\[Archivo.xlsm]BP Mensual'!RC276
Private Function ExternalRef_R1C1_RC_AbsCol(ByVal fullName As String, ByVal sheetName As String, ByVal absCol As Long) As String
    Dim folderPath As String, fileName As String
    folderPath = GetFolderFromFullName(fullName)
    fileName = GetFileFromFullName(fullName)

    ExternalRef_R1C1_RC_AbsCol = "'" & EscapeApostrophes(folderPath) & "[" & EscapeApostrophes(fileName) & "]" & _
                                 EscapeApostrophes(sheetName) & "'!RC" & CStr(absCol)
End Function

'=========================================================
' Aplicar fórmula por bloques de filas (para "no tocar" filas)
' - rng puede ser multi-columna (BP Mensual) o 1 columna (Resumen)
' - Se asigna FormulaR1C1Local una sola vez por bloque contiguo
'=========================================================
Private Sub ApplyFormulaByRowBlocks_R1C1Local(ByVal rng As Range, ByVal formulaR1C1Local As String, ByVal skipRows As Variant)
    Dim r As Long
    Dim startRow As Long, endRow As Long
    Dim curExcelRow As Long

    startRow = 0
    endRow = 0

    For r = 1 To rng.Rows.Count
        curExcelRow = rng.Row + r - 1

        If IsRowInList(curExcelRow, skipRows) Then
            If startRow <> 0 Then
                'cerrar bloque actual
                SetFormulaBlock rng, startRow, endRow, formulaR1C1Local
                startRow = 0
                endRow = 0
            End If
        Else
            If startRow = 0 Then
                startRow = curExcelRow
                endRow = curExcelRow
            Else
                endRow = curExcelRow
            End If
        End If
    Next r

    'último bloque
    If startRow <> 0 Then
        SetFormulaBlock rng, startRow, endRow, formulaR1C1Local
    End If
End Sub

'Asigna fórmula al subrango que corresponde al bloque de filas [startExcelRow..endExcelRow]
Private Sub SetFormulaBlock(ByVal baseRng As Range, ByVal startExcelRow As Long, ByVal endExcelRow As Long, ByVal formulaR1C1Local As String)
    Dim relStart As Long, relEnd As Long
    relStart = startExcelRow - baseRng.Row + 1
    relEnd = endExcelRow - baseRng.Row + 1

    baseRng.Rows(relStart & ":" & relEnd).FormulaR1C1Local = formulaR1C1Local
End Sub

'=========================================================
' Helpers de filas / rutas
'=========================================================
Private Function IsRowInList(ByVal excelRow As Long, ByVal rowsList As Variant) As Boolean
    Dim i As Long
    For i = LBound(rowsList) To UBound(rowsList)
        If excelRow = CLng(rowsList(i)) Then
            IsRowInList = True
            Exit Function
        End If
    Next i
End Function

Private Function GetFolderFromFullName(ByVal fullName As String) As String
    Dim p As Long
    p = InStrRev(fullName, "\")
    If p = 0 Then Err.Raise vbObjectError + 2101, "GetFolderFromFullName", "Ruta inválida: " & fullName
    GetFolderFromFullName = Left$(fullName, p)
End Function

Private Function GetFileFromFullName(ByVal fullName As String) As String
    Dim p As Long
    p = InStrRev(fullName, "\")
    If p = 0 Then Err.Raise vbObjectError + 2102, "GetFileFromFullName", "Ruta inválida: " & fullName
    GetFileFromFullName = Mid$(fullName, p + 1)
End Function

Private Function EscapeApostrophes(ByVal s As String) As String
    EscapeApostrophes = Replace(s, "'", "''")
End Function

'KR -> 276, etc.
Private Function ColLetterToNum(ByVal colLetters As String) As Long
    Dim i As Long, n As Long
    colLetters = UCase$(colLetters)
    For i = 1 To Len(colLetters)
        n = n * 26 + (Asc(Mid$(colLetters, i, 1)) - Asc("A") + 1)
    Next i
    ColLetterToNum = n
End Function

'=========================================================
' Orden natural (Plan 1 antes Plan 2, etc.)
'=========================================================
Private Sub SortFilesNatural(ByRef files As Variant)
    If IsEmpty(files) Then Exit Sub
    QuickSortNatural files, LBound(files), UBound(files)
End Sub

Private Sub QuickSortNatural(ByRef arr As Variant, ByVal lo As Long, ByVal hi As Long)
    Dim i As Long, j As Long
    Dim pivot As String, tmp As String

    i = lo: j = hi
    pivot = arr((lo + hi) \ 2)

    Do While i <= j
        Do While NaturalCompare(arr(i), pivot) < 0
            i = i + 1
        Loop
        Do While NaturalCompare(arr(j), pivot) > 0
            j = j - 1
        Loop

        If i <= j Then
            tmp = arr(i): arr(i) = arr(j): arr(j) = tmp
            i = i + 1: j = j - 1
        End If
    Loop

    If lo < j Then QuickSortNatural arr, lo, j
    If i < hi Then QuickSortNatural arr, i, hi
End Sub

Private Function NaturalCompare(ByVal a As String, ByVal b As String) As Long
    Dim i As Long, j As Long
    Dim ca As String, cb As String
    Dim na As String, nb As String

    a = LCase$(GetFileFromFullName(a))
    b = LCase$(GetFileFromFullName(b))

    i = 1: j = 1
    Do While i <= Len(a) And j <= Len(b)
        ca = Mid$(a, i, 1)
        cb = Mid$(b, j, 1)

        If IsDigit(ca) And IsDigit(cb) Then
            na = ReadNumber(a, i)
            nb = ReadNumber(b, j)

            If CLng(na) <> CLng(nb) Then
                NaturalCompare = Sgn(CLng(na) - CLng(nb))
                Exit Function
            End If
        Else
            If ca <> cb Then
                NaturalCompare = Sgn(StrComp(ca, cb, vbTextCompare))
                Exit Function
            End If
            i = i + 1
            j = j + 1
        End If
    Loop

    NaturalCompare = Sgn(Len(a) - Len(b))
End Function

Private Function IsDigit(ByVal ch As String) As Boolean
    IsDigit = (ch >= "0" And ch <= "9")
End Function

Private Function ReadNumber(ByVal s As String, ByRef idx As Long) As String
    Dim startPos As Long
    startPos = idx
    Do While idx <= Len(s) And IsDigit(Mid$(s, idx, 1))
        idx = idx + 1
    Loop
    ReadNumber = Mid$(s, startPos, idx - startPos)
End Function
