Option Explicit

'========================
' Config
'========================
Private Const BP_SHEET_NAME As String = "BP Mensual"
Private Const BP_RANGE_ADDR As String = "C26:KP68"

'Filas (número de fila Excel) que deben quedar sin nada
Private EMPTY_ROWS As Variant

'========================
' Public (asignar a botón)
'========================
Public Sub ActualizarBP()
    Dim prevCalc As XlCalculation
    prevCalc = Application.Calculation

    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.DisplayAlerts = False
    Application.Calculation = xlCalculationManual

    On Error GoTo CleanFail

    EMPTY_ROWS = Array(19, 28, 30, 38, 47, 51, 54, 55, 60, 62, 64, 67)

    Dim folderPath As String
    folderPath = GetPlansFolderPath() 'misma carpeta del archivo madre

    Dim files As Variant
    files = ListExcelFilesInFolder(folderPath, ThisWorkbook.FullName) 'excluye el madre

    If IsEmpty(files) Then GoTo CleanOk

    BuildLinkedSumFormulas ThisWorkbook, BP_SHEET_NAME, BP_RANGE_ADDR, files

CleanOk:
    Application.Calculation = prevCalc
    Application.DisplayAlerts = True
    Application.EnableEvents = True
    Application.ScreenUpdating = True
    Exit Sub

CleanFail:
    Application.Calculation = prevCalc
    Application.DisplayAlerts = True
    Application.EnableEvents = True
    Application.ScreenUpdating = True
    Err.Raise Err.Number, "ActualizarBP", Err.Description
End Sub

'========================
' Funciones auxiliares
'========================

'Carpeta donde están los planes: misma carpeta del archivo madre.
Private Function GetPlansFolderPath() As String
    Dim p As String
    p = ThisWorkbook.Path
    If Len(p) = 0 Then
        Err.Raise vbObjectError + 2001, "GetPlansFolderPath", _
                  "El archivo madre debe estar guardado para poder usar ThisWorkbook.Path."
    End If
    If Right$(p, 1) <> "\" Then p = p & "\"
    GetPlansFolderPath = p
End Function

'Devuelve un array 0..n-1 con FullName de cada archivo Excel en folderPath,
'excluyendo excludeFullName (el madre) y archivos temporales (~$)
Private Function ListExcelFilesInFolder(ByVal folderPath As String, ByVal excludeFullName As String) As Variant
    Dim f As String, full As String
    Dim col As Collection
    Set col = New Collection

    If Right$(folderPath, 1) <> "\" Then folderPath = folderPath & "\"

    f = Dir(folderPath & "*.xls*")
    Do While Len(f) > 0
        If Left$(f, 2) <> "~$" Then
            full = folderPath & f
            If StrComp(full, excludeFullName, vbTextCompare) <> 0 Then
                col.Add full
            End If
        End If
        f = Dir()
    Loop

    If col.Count = 0 Then Exit Function

    Dim arr() As String
    ReDim arr(0 To col.Count - 1) As String

    Dim i As Long
    For i = 1 To col.Count
        arr(i - 1) = CStr(col(i))
    Next i

    ListExcelFilesInFolder = arr
End Function

'Construye fórmulas vinculadas con SUM para cada celda del rango
Private Sub BuildLinkedSumFormulas( _
    ByVal wbMaster As Workbook, _
    ByVal masterSheetName As String, _
    ByVal targetRangeAddr As String, _
    ByVal srcFiles As Variant _
)
    Dim wsM As Worksheet
    Set wsM = wbMaster.Worksheets(masterSheetName)

    Dim rng As Range
    Set rng = wsM.Range(targetRangeAddr)

    Dim r As Long, c As Long
    Dim cell As Range
    Dim addrA1 As String

    For r = 1 To rng.Rows.Count
        'Fila real en Excel
        If IsEmptyRowToSkip(rng.Row + r - 1) Then
            'Deja sin nada toda esa fila dentro del rango
            rng.Rows(r).ClearContents
        Else
            For c = 1 To rng.Columns.Count
                Set cell = rng.Cells(r, c)
                addrA1 = cell.Address(False, False) 'ej: C26

                cell.Formula = BuildExternalSumFormula(srcFiles, BP_SHEET_NAME, addrA1)
            Next c
        End If
    Next r
End Sub

'Devuelve: =SUM('C:\...\[Plan1.xlsm]BP Mensual'!C26,'C:\...\[Plan2.xlsm]BP Mensual'!C26,...)
Private Function BuildExternalSumFormula( _
    ByVal srcFiles As Variant, _
    ByVal srcSheetName As String, _
    ByVal cellA1 As String _
) As String
    Dim i As Long
    Dim parts() As String
    ReDim parts(LBound(srcFiles) To UBound(srcFiles)) As String

    For i = LBound(srcFiles) To UBound(srcFiles)
        parts(i) = ExternalRef(CStr(srcFiles(i)), srcSheetName, cellA1)
    Next i

    BuildExternalSumFormula = "=SUM(" & Join(parts, ",") & ")"
End Function

'Devuelve: 'C:\ruta\[Archivo.xlsm]BP Mensual'!C26
Private Function ExternalRef(ByVal fullName As String, ByVal sheetName As String, ByVal cellA1 As String) As String
    Dim folderPath As String, fileName As String
    folderPath = GetFolderFromFullName(fullName)
    fileName = GetFileFromFullName(fullName)

    ExternalRef = "'" & EscapeApostrophes(folderPath) & "[" & EscapeApostrophes(fileName) & "]" & _
                  EscapeApostrophes(sheetName) & "'!" & cellA1
End Function

Private Function GetFolderFromFullName(ByVal fullName As String) As String
    Dim p As Long
    p = InStrRev(fullName, "\")
    If p = 0 Then
        Err.Raise vbObjectError + 2101, "GetFolderFromFullName", "Ruta inválida: " & fullName
    End If
    GetFolderFromFullName = Left$(fullName, p) 'incluye "\"
End Function

Private Function GetFileFromFullName(ByVal fullName As String) As String
    Dim p As Long
    p = InStrRev(fullName, "\")
    If p = 0 Then
        Err.Raise vbObjectError + 2102, "GetFileFromFullName", "Ruta inválida: " & fullName
    End If
    GetFileFromFullName = Mid$(fullName, p + 1)
End Function

'Si hay apostrofes en ruta/hoja, Excel exige duplicarlos dentro de comillas simples
Private Function EscapeApostrophes(ByVal s As String) As String
    EscapeApostrophes = Replace(s, "'", "''")
End Function

Private Function IsEmptyRowToSkip(ByVal excelRow As Long) As Boolean
    Dim i As Long
    For i = LBound(EMPTY_ROWS) To UBound(EMPTY_ROWS)
        If excelRow = CLng(EMPTY_ROWS(i)) Then
            IsEmptyRowToSkip = True
            Exit Function
        End If
    Next i
End Function
