Option Explicit

'========================
' Config general
'========================
Private Const BP_SHEET_NAME As String = "BP Mensual"
Private Const BP_FIRST_COL As Long = 3          'C
Private Const BP_LAST_COL As Long = 302         'KP
Private Const BP_FIRST_ROW As Long = 6
Private Const BP_LAST_ROW As Long = 68

Private Const RES_SHEET_NAME As String = "Resumen Consolidado"
Private Const RES_FIRST_COL As Long = 3          'C
Private Const RES_FIRST_ROW As Long = 6
Private Const RES_LAST_ROW As Long = 68
Private Const RES_SRC_COL_LETTER As String = "KR" 'en hijos: BP Mensual!KR{fila}

'Filas intocables por hoja
Private BP_SKIP_ROWS As Variant
Private RES_SKIP_ROWS As Variant

'========================
' Macro principal (botón)
'========================
Public Sub ActualizarBP()
    Dim wbMaster As Workbook
    Dim prevCalc As XlCalculation
    Dim stage As String

    On Error GoTo CleanFail

    Set wbMaster = ActiveWorkbook

    prevCalc = Application.Calculation
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.DisplayAlerts = False
    Application.Calculation = xlCalculationManual

    'Fila 30 agregada
    BP_SKIP_ROWS = Array(11, 19, 28, 30, 31, 32, 33, 34, 35, 38, 47, 51, 54, 55, 60, 62, 64, 67, 69)
    RES_SKIP_ROWS = Array(11, 19, 28, 30, 31, 32, 33, 34, 35, 38, 47, 51, 54, 55, 60, 62, 64, 67, 69)

    stage = "Validar hojas"
    RequireSheet wbMaster, BP_SHEET_NAME
    RequireSheet wbMaster, RES_SHEET_NAME

    stage = "Obtener carpeta"
    Dim folderPath As String
    folderPath = GetPlansFolderPath(wbMaster)

    stage = "Listar archivos"
    Dim files As Variant
    files = ListExcelFilesInFolder(folderPath, wbMaster.FullName)
    If IsEmpty(files) Then GoTo CleanOk

    stage = "Ordenar archivos"
    SortFilesNatural files

    '========================================================
    ' 1) BP Mensual: SUMA vinculada (sin tocar formato)
    '========================================================
    stage = "Actualizar BP Mensual"
    BuildBP_LinkedSums_FillValues wbMaster.Worksheets(BP_SHEET_NAME), files, BP_SKIP_ROWS

    '========================================================
    ' 2) Resumen Consolidado: KR por columnas (sin tocar formato)
    '========================================================
    stage = "Actualizar Resumen Consolidado"
    BuildResumen_FillValues wbMaster.Worksheets(RES_SHEET_NAME), files, RES_SKIP_ROWS

CleanOk:
    Application.Calculation = prevCalc
    Application.DisplayAlerts = True
    Application.EnableEvents = True
    Application.ScreenUpdating = True
    Exit Sub

CleanFail:
    Application.Calculation = prevCalc
    Application.DisplayAlerts = True
    Application.EnableEvents = True
    Application.ScreenUpdating = True

    MsgBox "Error etapa: " & stage & vbCrLf & _
           "N°: " & Err.Number & vbCrLf & _
           "Desc: " & Err.Description, vbCritical, "ActualizarBP"
End Sub

'========================
' (Opcional) Botón
'========================
Public Sub RecrearBotonActualizarBP()
    Dim ws As Worksheet
    Set ws = ThisWorkbook.Worksheets(BP_SHEET_NAME)

    Dim shp As Shape
    Const shpName As String = "btnActualizarBP"

    On Error Resume Next
    ws.Shapes(shpName).Delete
    On Error GoTo 0

    Dim anchor As Range
    Set anchor = ws.Range("B2")

    Set shp = ws.Shapes.AddShape(Type:=msoShapeRoundedRectangle, _
                                 Left:=anchor.Left, Top:=anchor.Top, _
                                 Width:=140, Height:=32)

    With shp
        .Name = shpName
        .TextFrame2.TextRange.Text = "Actualizar BP"
        .OnAction = "'" & ThisWorkbook.Name & "'!ActualizarBP"
        .Placement = xlFreeFloating
    End With
End Sub

'=========================================================
' 1) BP Mensual — rápido, sin cambiar formato
'
' Estrategia:
' - Para cada bloque de filas contiguas (saltando intocables)
'   1) Escribo fórmulas SOLO en la primera fila del bloque (C..KP)
'   2) AutoFill hacia abajo con xlFillValues (NO copia formato)
'=========================================================
Private Sub BuildBP_LinkedSums_FillValues(ByVal wsBP As Worksheet, ByVal files As Variant, ByVal skipRows As Variant)
    Dim sep As String
    sep = Application.International(xlListSeparator) 'en español normalmente ";"

    Dim prefixes() As String
    prefixes = BuildExternalPrefixes(files, BP_SHEET_NAME)

    Dim startRow As Long, endRow As Long, r As Long
    startRow = 0: endRow = 0

    For r = BP_FIRST_ROW To BP_LAST_ROW
        If IsRowInList(r, skipRows) Then
            If startRow <> 0 Then
                FillBPBlock wsBP, startRow, endRow, prefixes, sep
                startRow = 0: endRow = 0
            End If
        Else
            If startRow = 0 Then startRow = r
            endRow = r
        End If
    Next r

    If startRow <> 0 Then
        FillBPBlock wsBP, startRow, endRow, prefixes, sep
    End If
End Sub

Private Sub FillBPBlock(ByVal wsBP As Worksheet, ByVal startRow As Long, ByVal endRow As Long, ByVal prefixes As Variant, ByVal sep As String)
    Dim colsCount As Long
    colsCount = BP_LAST_COL - BP_FIRST_COL + 1

    '1) Construyo fórmulas solo para la primera fila del bloque (C..KP)
    Dim arrRow() As Variant
    ReDim arrRow(1 To 1, 1 To colsCount)

    Dim c As Long, excelCol As Long
    For c = 1 To colsCount
        excelCol = BP_FIRST_COL + c - 1
        arrRow(1, c) = BuildSumFormula_A1(prefixes, wsBP, startRow, excelCol, sep)
    Next c

    'Rango de la fila base (source): C{startRow}:KP{startRow}
    Dim rngSource As Range
    Set rngSource = wsBP.Range(wsBP.Cells(startRow, BP_FIRST_COL), wsBP.Cells(startRow, BP_LAST_COL))

    'Escribo la fila source de una vez (rápido) — no cambia formatos, solo contenido
    rngSource.FormulaLocal = arrRow

    '2) Si el bloque tiene más de 1 fila, relleno hacia abajo SOLO valores/fórmulas (sin formatos)
    If endRow > startRow Then
        Dim rngDest As Range
        Set rngDest = wsBP.Range(wsBP.Cells(startRow, BP_FIRST_COL), wsBP.Cells(endRow, BP_LAST_COL))

        rngSource.AutoFill Destination:=rngDest, Type:=xlFillValues
    End If
End Sub

'Construye =SUMA('...\[f1]BP Mensual'!C6; '...\[f2]BP Mensual'!C6; ...)
'Usa A1 SIN $ para que AutoFill ajuste filas/columnas naturalmente.
Private Function BuildSumFormula_A1(ByVal prefixes As Variant, ByVal wsBP As Worksheet, ByVal rowNum As Long, ByVal colNum As Long, ByVal sep As String) As String
    Dim addr As String
    addr = wsBP.Cells(rowNum, colNum).Address(RowAbsolute:=False, ColumnAbsolute:=False) 'ej: C6

    Dim i As Long, s As String
    For i = LBound(prefixes) To UBound(prefixes)
        If Len(s) > 0 Then s = s & sep
        s = s & prefixes(i) & addr
    Next i

    BuildSumFormula_A1 = "=SUMA(" & s & ")"
End Function

'=========================================================
' 2) Resumen Consolidado — rápido, sin cambiar formato
'
' - Cada archivo ocupa una columna (C, D, E...)
' - Para cada bloque de filas, seteo fórmula solo en la primera celda del bloque
'   y FillDown con xlFillValues.
'=========================================================
Private Sub BuildResumen_FillValues(ByVal wsRes As Worksheet, ByVal files As Variant, ByVal skipRows As Variant)
    Dim prefixes() As String
    prefixes = BuildExternalPrefixes(files, BP_SHEET_NAME) 'uno por archivo

    Dim srcKRCol As Long
    srcKRCol = ColLetterToNum(RES_SRC_COL_LETTER)

    Dim i As Long, dstCol As Long
    For i = LBound(files) To UBound(files)
        dstCol = RES_FIRST_COL + (i - LBound(files))
        FillResumenColumn wsRes, dstCol, prefixes(i), srcKRCol, skipRows
    Next i
End Sub

Private Sub FillResumenColumn(ByVal wsRes As Worksheet, ByVal dstCol As Long, ByVal prefixOneFile As String, ByVal srcKRCol As Long, ByVal skipRows As Variant)
    Dim startRow As Long, endRow As Long, r As Long
    startRow = 0: endRow = 0

    For r = RES_FIRST_ROW To RES_LAST_ROW
        If IsRowInList(r, skipRows) Then
            If startRow <> 0 Then
                FillResumenBlock wsRes, dstCol, startRow, endRow, prefixOneFile, srcKRCol
                startRow = 0: endRow = 0
            End If
        Else
            If startRow = 0 Then startRow = r
            endRow = r
        End If
    Next r

    If startRow <> 0 Then
        FillResumenBlock wsRes, dstCol, startRow, endRow, prefixOneFile, srcKRCol
    End If
End Sub

Private Sub FillResumenBlock(ByVal wsRes As Worksheet, ByVal dstCol As Long, ByVal startRow As Long, ByVal endRow As Long, ByVal prefixOneFile As String, ByVal srcKRCol As Long)
    'Primera celda del bloque: referencia a KR{startRow} del archivo i
    Dim srcAddr As String
    srcAddr = wsRes.Cells(startRow, srcKRCol).Address(RowAbsolute:=False, ColumnAbsolute:=False) 'ej KR6 (relativo)

    Dim topCell As Range
    Set topCell = wsRes.Cells(startRow, dstCol)

    topCell.Formula = "=" & prefixOneFile & srcAddr

    If endRow > startRow Then
        Dim rngDest As Range
        Set rngDest = wsRes.Range(wsRes.Cells(startRow, dstCol), wsRes.Cells(endRow, dstCol))
        topCell.AutoFill Destination:=rngDest, Type:=xlFillValues
    End If
End Sub

'=========================================================
' Prefijos externos (optimiza strings)
' Devuelve: 'C:\...\[Archivo.xlsm]BP Mensual'!
'=========================================================
Private Function BuildExternalPrefixes(ByVal files As Variant, ByVal sheetName As String) As String()
    Dim prefixes() As String
    ReDim prefixes(LBound(files) To UBound(files)) As String

    Dim i As Long
    For i = LBound(files) To UBound(files)
        prefixes(i) = ExternalPrefix(CStr(files(i)), sheetName)
    Next i

    BuildExternalPrefixes = prefixes
End Function

Private Function ExternalPrefix(ByVal fullName As String, ByVal sheetName As String) As String
    Dim folderPath As String, fileName As String
    folderPath = GetFolderFromFullName(fullName)
    fileName = GetFileFromFullName(fullName)

    ExternalPrefix = "'" & EscapeApostrophes(folderPath) & "[" & EscapeApostrophes(fileName) & "]" & _
                     EscapeApostrophes(sheetName) & "'!"
End Function

'=========================================================
' Utilidades
'=========================================================
Private Sub RequireSheet(ByVal wb As Workbook, ByVal sheetName As String)
    If Not WorksheetExists(wb, sheetName) Then
        Err.Raise vbObjectError + 9001, "RequireSheet", "No existe la hoja '" & sheetName & "' en " & wb.Name
    End If
End Sub

Private Function WorksheetExists(ByVal wb As Workbook, ByVal sheetName As String) As Boolean
    Dim ws As Worksheet
    On Error Resume Next
    Set ws = wb.Worksheets(sheetName)
    On Error GoTo 0
    WorksheetExists = Not ws Is Nothing
End Function

Private Function GetPlansFolderPath(ByVal wbMaster As Workbook) As String
    Dim p As String
    p = wbMaster.Path
    If Len(p) = 0 Then Err.Raise vbObjectError + 2001, "GetPlansFolderPath", "El archivo madre debe estar guardado."
    If Right$(p, 1) <> "\" Then p = p & "\"
    GetPlansFolderPath = p
End Function

Private Function ListExcelFilesInFolder(ByVal folderPath As String, ByVal excludeFullName As String) As Variant
    Dim f As String, full As String
    Dim col As Collection: Set col = New Collection

    If Right$(folderPath, 1) <> "\" Then folderPath = folderPath & "\"

    f = Dir(folderPath & "*.xls*")
    Do While Len(f) > 0
        If Left$(f, 2) <> "~$" Then
            full = folderPath & f
            If StrComp(full, excludeFullName, vbTextCompare) <> 0 Then col.Add full
        End If
        f = Dir()
    Loop

    If col.Count = 0 Then Exit Function

    Dim arr() As String, i As Long
    ReDim arr(0 To col.Count - 1)
    For i = 1 To col.Count
        arr(i - 1) = CStr(col(i))
    Next i

    ListExcelFilesInFolder = arr
End Function

Private Function IsRowInList(ByVal excelRow As Long, ByVal rowsList As Variant) As Boolean
    Dim i As Long
    For i = LBound(rowsList) To UBound(rowsList)
        If excelRow = CLng(rowsList(i)) Then
            IsRowInList = True
            Exit Function
        End If
    Next i
End Function

Private Function GetFolderFromFullName(ByVal fullName As String) As String
    Dim p As Long
    p = InStrRev(fullName, "\")
    If p = 0 Then Err.Raise vbObjectError + 2101, "GetFolderFromFullName", "Ruta inválida: " & fullName
    GetFolderFromFullName = Left$(fullName, p)
End Function

Private Function GetFileFromFullName(ByVal fullName As String) As String
    Dim p As Long
    p = InStrRev(fullName, "\")
    If p = 0 Then Err.Raise vbObjectError + 2102, "GetFileFromFullName", "Ruta inválida: " & fullName
    GetFileFromFullName = Mid$(fullName, p + 1)
End Function

Private Function EscapeApostrophes(ByVal s As String) As String
    EscapeApostrophes = Replace(s, "'", "''")
End Function

Private Function ColLetterToNum(ByVal colLetters As String) As Long
    Dim i As Long, n As Long
    colLetters = UCase$(colLetters)
    For i = 1 To Len(colLetters)
        n = n * 26 + (Asc(Mid$(colLetters, i, 1)) - Asc("A") + 1)
    Next i
    ColLetterToNum = n
End Function

'=========================================================
' Orden natural
'=========================================================
Private Sub SortFilesNatural(ByRef files As Variant)
    If IsEmpty(files) Then Exit Sub
    QuickSortNatural files, LBound(files), UBound(files)
End Sub

Private Sub QuickSortNatural(ByRef arr As Variant, ByVal lo As Long, ByVal hi As Long)
    Dim i As Long, j As Long
    Dim pivot As String, tmp As String

    i = lo: j = hi
    pivot = arr((lo + hi) \ 2)

    Do While i <= j
        Do While NaturalCompare(arr(i), pivot) < 0
            i = i + 1
        Loop
        Do While NaturalCompare(arr(j), pivot) > 0
            j = j - 1
        Loop

        If i <= j Then
            tmp = arr(i): arr(i) = arr(j): arr(j) = tmp
            i = i + 1: j = j - 1
        End If
    Loop

    If lo < j Then QuickSortNatural arr, lo, j
    If i < hi Then QuickSortNatural arr, i, hi
End Sub

Private Function NaturalCompare(ByVal a As String, ByVal b As String) As Long
    Dim i As Long, j As Long
    Dim ca As String, cb As String
    Dim na As String, nb As String

    a = LCase$(GetFileFromFullName(a))
    b = LCase$(GetFileFromFullName(b))

    i = 1: j = 1
    Do While i <= Len(a) And j <= Len(b)
        ca = Mid$(a, i, 1)
        cb = Mid$(b, j, 1)

        If IsDigit(ca) And IsDigit(cb) Then
            na = ReadNumber(a, i)
            nb = ReadNumber(b, j)

            If CLng(na) <> CLng(nb) Then
                NaturalCompare = Sgn(CLng(na) - CLng(nb))
                Exit Function
            End If
        Else
            If ca <> cb Then
                NaturalCompare = Sgn(StrComp(ca, cb, vbTextCompare))
                Exit Function
            End If
            i = i + 1
            j = j + 1
        End If
    Loop

    NaturalCompare = Sgn(Len(a) - Len(b))
End Function

Private Function IsDigit(ByVal ch As String) As Boolean
    IsDigit = (ch >= "0" And ch <= "9")
End Function

Private Function ReadNumber(ByVal s As String, ByRef idx As Long) As String
    Dim startPos As Long
    startPos = idx
    Do While idx <= Len(s) And IsDigit(Mid$(s, idx, 1))
        idx = idx + 1
    Loop
    ReadNumber = Mid$(s, startPos, idx - startPos)
End Function
